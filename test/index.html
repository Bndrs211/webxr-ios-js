<html>
	<head>
		<meta charset="utf-8">
		<script src="./libs/three/three.min.js"></script>
		<script module src="../dist/webxr.js"></script>
		<style>
			button {
				font-size: 16px;
			}
			html, 
			body, 
			.xr-canvas,
			.arkit-device-wrapper, 
			.arkit-device-wrapper canvas {
				width: 100%;
				height: 100%;
				padding: 0;
				margin: 0;
			}
			body {
				z-index: 1;
			}
			.arkit-device-wrapper, .xr-canvas {
				position: absolute;
				top: 0;
				left: 0;
				bottom: 0;
				right: 0;
			}
			.arkit-device-wrapper {
				z-index: -1;
			}
			.xr-canvas {
				z-index: -2;
			}
		</style>
	</head>
	<body>
		<h1>Test</h1>
		<button type=button id=go-button>Go</button>
		<script type=module>
			import XREngine from "./XREngine.js"

			var device = null
			var session = null
			var layer = null
			var frameOfReference = null
			var engine = null

			// Create the output context where the XRSession will place composited renders
			const xrCanvas = document.createElement('canvas')
			xrCanvas.setAttribute('class', 'xr-canvas')
			const xrContext = xrCanvas.getContext('xrpresent');

			navigator.xr.requestDevice().then(xrDevice => {
				device = xrDevice
			}).catch(err => {
				console.error('Error', err)
			})

			function handleStartSessionRequest(ev){
				if(device === null){
					console.error('No xr device')
					return
				}

				device.requestSession({ outputContext: xrContext })
					.then(handleSessionStarted)
					.catch(err => {
						console.error('Error', err)
					})
			}
			document.getElementById('go-button').addEventListener('click', handleStartSessionRequest)

			function handleSessionStarted(xrSession){
				session = xrSession

				document.body.insertBefore(xrCanvas, document.body.firstChild)

				// Create the context where we will render our 3D scene
				const canvas = document.createElement('canvas')
				var glContext = canvas.getContext('webgl', {
					compatibleXRDevice: device
				})
				if(!glContext) throw new Error('Could not create a webgl context')

				// Set up the base layer
				session.baseLayer = new XRWebGLLayer(session, glContext)

				// Create a simple test scene and renderer
				engine = new XREngine(canvas, glContext)
				engine.addAmbientLight()
				engine.addDirectionalLight()
				engine.addBox([0, -0.5, -0.5])
				engine.addSphere([0, -0.3, -0.6])

				session.requestFrameOfReference('eyeLevel')
					.then(handleFrameOfReference)
					.catch(err => {
						console.error('Error finding frame of reference', err)
					})
			}

			function handleFrameOfReference(xrFrameOfReference){
				frameOfReference = xrFrameOfReference
				session.requestAnimationFrame(handleAnimationFrame)
			}

			function handleAnimationFrame(t, frame){
				if(session.ended) return
				session.requestAnimationFrame(handleAnimationFrame)

				let pose = frame.getDevicePose(frameOfReference)
				if(!pose){
					console.log('No pose')
					return
				}

				engine.startFrame()
				for (let view of frame.views) {
					engine.render(
						session.baseLayer.getViewport(view),
						view.projectionMatrix,
						pose.getViewMatrix(view)
					)
					break
				}
				engine.endFrame()
			}

		</script>
	</body>
</html>