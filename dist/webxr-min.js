!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t():"function"==typeof define&&define.amd?define(t):t()}(0,function(){"use strict";const e="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},t=Symbol("@@webxr-polyfill/EventTarget");class r{constructor(){this[t]={listeners:new Map}}addEventListener(e,r){if("string"!=typeof e)throw new Error("`type` must be a string");if("function"!=typeof r)throw new Error("`listener` must be a function");const i=this[t].listeners.get(e)||[];i.push(r),this[t].listeners.set(e,i)}removeEventListener(e,r){if("string"!=typeof e)throw new Error("`type` must be a string");if("function"!=typeof r)throw new Error("`listener` must be a function");const i=this[t].listeners.get(e)||[];for(let e=i.length;e>=0;e--)i[e]===r&&i.pop()}dispatchEvent(e,r){const i=this[t].listeners.get(e)||[],s=[];for(let e=0;e<i.length;e++)s[e]=i[e];for(let e of s)e(r);"function"==typeof this[`on${e}`]&&this[`on${e}`](r)}}const i=1e-6;let s="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function n(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function a(e,t){let r=t[0],i=t[1],s=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],d=t[9],u=t[10],p=t[11],_=t[12],m=t[13],f=t[14],g=t[15],v=r*o-i*a,w=r*h-s*a,b=r*l-n*a,E=i*h-s*o,y=i*l-n*o,S=s*l-n*h,R=c*m-d*_,M=c*f-u*_,x=c*g-p*_,A=d*f-u*m,T=d*g-p*m,I=u*g-p*f,O=v*I-w*T+b*A+E*x-y*M+S*R;return O?(O=1/O,e[0]=(o*I-h*T+l*A)*O,e[1]=(s*T-i*I-n*A)*O,e[2]=(m*S-f*y+g*E)*O,e[3]=(u*y-d*S-p*E)*O,e[4]=(h*x-a*I-l*M)*O,e[5]=(r*I-s*x+n*M)*O,e[6]=(f*b-_*S-g*w)*O,e[7]=(c*S-u*b+p*w)*O,e[8]=(a*T-o*x+l*R)*O,e[9]=(i*x-r*T-n*R)*O,e[10]=(_*y-m*b+g*v)*O,e[11]=(d*b-c*y-p*v)*O,e[12]=(o*M-a*A-h*R)*O,e[13]=(r*A-i*M+s*R)*O,e[14]=(m*w-_*E-f*v)*O,e[15]=(c*E-d*w+u*v)*O,e):null}function o(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],d=t[8],u=t[9],p=t[10],_=t[11],m=t[12],f=t[13],g=t[14],v=t[15],w=r[0],b=r[1],E=r[2],y=r[3];return e[0]=w*i+b*o+E*d+y*m,e[1]=w*s+b*h+E*u+y*f,e[2]=w*n+b*l+E*p+y*g,e[3]=w*a+b*c+E*_+y*v,w=r[4],b=r[5],E=r[6],y=r[7],e[4]=w*i+b*o+E*d+y*m,e[5]=w*s+b*h+E*u+y*f,e[6]=w*n+b*l+E*p+y*g,e[7]=w*a+b*c+E*_+y*v,w=r[8],b=r[9],E=r[10],y=r[11],e[8]=w*i+b*o+E*d+y*m,e[9]=w*s+b*h+E*u+y*f,e[10]=w*n+b*l+E*p+y*g,e[11]=w*a+b*c+E*_+y*v,w=r[12],b=r[13],E=r[14],y=r[15],e[12]=w*i+b*o+E*d+y*m,e[13]=w*s+b*h+E*u+y*f,e[14]=w*n+b*l+E*p+y*g,e[15]=w*a+b*c+E*_+y*v,e}function h(){let e=new s(3);return s!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function l(e,t,r){let i=new s(3);return i[0]=e,i[1]=t,i[2]=r,i}function c(e,t,r){let i=t[0],s=t[1],n=t[2],a=r[0],o=r[1],h=r[2];return e[0]=s*h-n*o,e[1]=n*a-i*h,e[2]=i*o-s*a,e}const d=function(e){let t=e[0],r=e[1],i=e[2];return Math.sqrt(t*t+r*r+i*i)};!function(){let e=h()}();!function(){let e=function(){let e=new s(4);return s!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}()}();function u(){let e=new s(4);return s!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function p(e,t,r,s){let n,a,o,h,l,c=t[0],d=t[1],u=t[2],p=t[3],_=r[0],m=r[1],f=r[2],g=r[3];return(a=c*_+d*m+u*f+p*g)<0&&(a=-a,_=-_,m=-m,f=-f,g=-g),1-a>i?(n=Math.acos(a),o=Math.sin(n),h=Math.sin((1-s)*n)/o,l=Math.sin(s*n)/o):(h=1-s,l=s),e[0]=h*c+l*_,e[1]=h*d+l*m,e[2]=h*u+l*f,e[3]=h*p+l*g,e}const _=function(e,t,r,i){let n=new s(4);return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n},m=function(e,t){let r=t[0],i=t[1],s=t[2],n=t[3],a=r*r+i*i+s*s+n*n;return a>0&&(a=1/Math.sqrt(a),e[0]=r*a,e[1]=i*a,e[2]=s*a,e[3]=n*a),e},f=(function(){let e=h(),t=l(1,0,0),r=l(0,1,0)}(),function(){let e=u(),t=u()}(),function(){let e=function(){let e=new s(9);return s!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}()}(),Symbol("@@webxr-polyfill/XRRigidTransform"));class g{constructor(){if(this[f]={matrix:null,position:null,orientation:null,inverse:null},0===arguments.length)this[f].matrix=n(new Float32Array(16));else if(1===arguments.length)arguments[0]instanceof Float32Array?this[f].matrix=arguments[0]:(this[f].position=this._getPoint(arguments[0]),this[f].orientation=DOMPointReadOnly.fromPoint({x:0,y:0,z:0,w:1}));else{if(2!==arguments.length)throw new Error("Too many arguments!");this[f].position=this._getPoint(arguments[0]),this[f].orientation=this._getPoint(arguments[1])}if(this[f].matrix){let r=h();e=r,t=this[f].matrix,e[0]=t[12],e[1]=t[13],e[2]=t[14],this[f].position=DOMPointReadOnly.fromPoint({x:r[0],y:r[1],z:r[2]});let i=u();!function(e,t){let r=t[0]+t[5]+t[10],i=0;r>0?(i=2*Math.sqrt(r+1),e[3]=.25*i,e[0]=(t[6]-t[9])/i,e[1]=(t[8]-t[2])/i,e[2]=(t[1]-t[4])/i):t[0]>t[5]&&t[0]>t[10]?(i=2*Math.sqrt(1+t[0]-t[5]-t[10]),e[3]=(t[6]-t[9])/i,e[0]=.25*i,e[1]=(t[1]+t[4])/i,e[2]=(t[8]+t[2])/i):t[5]>t[10]?(i=2*Math.sqrt(1+t[5]-t[0]-t[10]),e[3]=(t[8]-t[2])/i,e[0]=(t[1]+t[4])/i,e[1]=.25*i,e[2]=(t[6]+t[9])/i):(i=2*Math.sqrt(1+t[10]-t[0]-t[5]),e[3]=(t[1]-t[4])/i,e[0]=(t[8]+t[2])/i,e[1]=(t[6]+t[9])/i,e[2]=.25*i)}(i,this[f].matrix),this[f].orientation=DOMPointReadOnly.fromPoint({x:i[0],y:i[1],z:i[2],w:i[3]})}else this[f].matrix=n(new Float32Array(16)),function(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3],o=i+i,h=s+s,l=n+n,c=i*o,d=i*h,u=i*l,p=s*h,_=s*l,m=n*l,f=a*o,g=a*h,v=a*l;e[0]=1-(p+m),e[1]=d+v,e[2]=u-g,e[3]=0,e[4]=d-v,e[5]=1-(c+m),e[6]=_+f,e[7]=0,e[8]=u+g,e[9]=_-f,e[10]=1-(c+p),e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1}(this[f].matrix,_(this[f].orientation.x,this[f].orientation.y,this[f].orientation.z,this[f].orientation.w),l(this[f].position.x,this[f].position.y,this[f].position.z));var e,t}_getPoint(e){return e instanceof DOMPointReadOnly?e:DOMPointReadOnly.fromPoint(e)}get matrix(){return this[f].matrix}get position(){return this[f].position}get orientation(){return this[f].orientation}get inverse(){if(null===this[f].inverse){let e=n(new Float32Array(16));a(e,this[f].matrix),this[f].inverse=new g(e),this[f].inverse[f].inverse=this}return this[f].inverse}}const v=Symbol("@@webxr-polyfill/XRSpace");class w{constructor(e=null,t=null){this[v]={specialType:e,inputSource:t,baseMatrix:null,inverseBaseMatrix:null,lastFrameId:-1}}get _specialType(){return this[v].specialType}get _inputSource(){return this[v].inputSource}_ensurePoseUpdated(e,t){t!=this[v].lastFrameId&&(this[v].lastFrameId=t,this._onPoseUpdate(e))}_onPoseUpdate(e){"viewer"==this[v].specialType&&(this._baseMatrix=e.getBasePoseMatrix())}set _baseMatrix(e){this[v].baseMatrix=e,this[v].inverseBaseMatrix=null}get _baseMatrix(){return this[v].baseMatrix||this[v].inverseBaseMatrix&&(this[v].baseMatrix=new Float32Array(16),a(this[v].baseMatrix,this[v].inverseBaseMatrix)),this[v].baseMatrix}set _inverseBaseMatrix(e){this[v].inverseBaseMatrix=e,this[v].baseMatrix=null}get _inverseBaseMatrix(){return this[v].inverseBaseMatrix||this[v].baseMatrix&&(this[v].inverseBaseMatrix=new Float32Array(16),a(this[v].inverseBaseMatrix,this[v].baseMatrix)),this[v].inverseBaseMatrix}_getSpaceRelativeTransform(e){if(!this._inverseBaseMatrix||!e._baseMatrix)return null;let t=new Float32Array(16);return o(t,this._inverseBaseMatrix,e._baseMatrix),new g(t)}}const b=1.6,E=Symbol("@@webxr-polyfill/XRReferenceSpace"),y=["viewer","local","local-floor","bounded-floor","unbounded"];class S extends w{constructor(e,t=null){if(!y.includes(e))throw new Error(`XRReferenceSpaceType must be one of ${y}`);if(super(e),"bounded-floor"===e&&!t)throw new Error("XRReferenceSpace cannot use 'bounded-floor' type if the platform does not provide the floor level");(function(e){return"bounded-floor"===e||"local-floor"===e})(e)&&!t&&((t=n(new Float32Array(16)))[13]=b),this._inverseBaseMatrix=t||n(new Float32Array(16)),this[E]={type:e,transform:t,originOffset:n(new Float32Array(16))}}_transformBasePoseMatrix(e,t){o(e,this._inverseBaseMatrix,t)}_originOffsetMatrix(){return this[E].originOffset}_adjustForOriginOffset(e){let t=new Float32Array(16);a(t,this[E].originOffset),o(e,t,e)}_getSpaceRelativeTransform(e){let t=super._getSpaceRelativeTransform(e);return this._adjustForOriginOffset(t.matrix),new XRRigidTransform(t.matrix)}getOffsetReferenceSpace(e){let t=new S(this[E].type,this[E].transform,this[E].bounds);return o(t[E].originOffset,this[E].originOffset,e.matrix),t}}const R=Symbol("@@webxr-polyfill/XR"),M=["inline","immersive-vr","immersive-ar"],x={inline:{requiredFeatures:["viewer"],optionalFeatures:[]},"immersive-vr":{requiredFeatures:["viewer","local"],optionalFeatures:[]},"immersive-ar":{requiredFeatures:["viewer","local"],optionalFeatures:[]}},A="Polyfill Error: Must call navigator.xr.isSessionSupported() with any XRSessionMode\nor navigator.xr.requestSession('inline') prior to requesting an immersive\nsession. This is a limitation specific to the WebXR Polyfill and does not apply\nto native implementations of the API.";let T;if("performance"in e==!1){let e=Date.now();T=(()=>Date.now()-e)}else T=(()=>performance.now());var I=T;const O=Symbol("@@webxr-polyfill/XRPose");class C{constructor(e,t){this[O]={transform:e,emulatedPosition:t}}get transform(){return this[O].transform}get emulatedPosition(){return this[O].emulatedPosition}}const P=Symbol("@@webxr-polyfill/XRViewerPose");class N extends C{constructor(e,t,r=!1){super(e,r),this[P]={views:t}}get views(){return this[P].views}}const F=Symbol("@@webxr-polyfill/XRViewport");class L{constructor(e){this[F]={target:e}}get x(){return this[F].target.x}get y(){return this[F].target.y}get width(){return this[F].target.width}get height(){return this[F].target.height}}const D=["left","right","none"],V=Symbol("@@webxr-polyfill/XRView");class G{constructor(e,t,r,i){if(!D.includes(r))throw new Error(`XREye must be one of: ${D}`);const s=Object.create(null),n=new L(s);this[V]={device:e,eye:r,viewport:n,temp:s,sessionId:i,transform:t}}get eye(){return this[V].eye}get projectionMatrix(){return this[V].device.getProjectionMatrix(this.eye)}get transform(){return this[V].transform}_getViewport(e){if(this[V].device.getViewport(this[V].sessionId,this.eye,e,this[V].temp))return this[V].viewport}}const k=Symbol("@@webxr-polyfill/XRFrame"),X="XRFrame access outside the callback that produced it is invalid.",W="getViewerPose can only be called on XRFrame objects passed to XRSession.requestAnimationFrame callbacks.";let U=0;class B{constructor(e,t,r){this[k]={id:++U,active:!1,animationFrame:!1,device:e,session:t,sessionId:r}}get session(){return this[k].session}getViewerPose(e){if(!this[k].animationFrame)throw new DOMException(W,"InvalidStateError");if(!this[k].active)throw new DOMException(X,"InvalidStateError");const t=this[k].device,r=this[k].session;r[ie].viewerSpace._ensurePoseUpdated(t,this[k].id),e._ensurePoseUpdated(t,this[k].id);let i=e._getSpaceRelativeTransform(r[ie].viewerSpace);const s=[];for(let i of r[ie].viewSpaces){i._ensurePoseUpdated(t,this[k].id);let r=e._getSpaceRelativeTransform(i),n=new G(t,r,i.eye,this[k].sessionId);s.push(n)}return new N(i,s,!1)}getPose(e,t){if(!this[k].active)throw new DOMException(X,"InvalidStateError");const r=this[k].device;if("target-ray"===e._specialType||"grip"===e._specialType)return r.getInputPose(e._inputSource,t,e._specialType);{e._ensurePoseUpdated(r,this[k].id),t._ensurePoseUpdated(r,this[k].id);let i=t._getSpaceRelativeTransform(e);return i?new XRPose(i,!1):null}}}const q=Symbol("@@webxr-polyfill/XRRenderState"),j=Object.freeze({depthNear:.1,depthFar:1e3,inlineVerticalFieldOfView:null,baseLayer:null});class H{constructor(e={}){const t=Object.assign({},j,e);this[q]={config:t}}get depthNear(){return this[q].config.depthNear}get depthFar(){return this[q].config.depthFar}get inlineVerticalFieldOfView(){return this[q].config.inlineVerticalFieldOfView}get baseLayer(){return this[q].config.baseLayer}}const z=Symbol("@@webxr-polyfill/polyfilled-xr-compatible"),Y=Symbol("@@webxr-polyfill/xr-compatible"),K=Symbol("@@webxr-polyfill/XRWebGLLayer"),$=Object.freeze({antialias:!0,depth:!1,stencil:!1,alpha:!0,multiview:!1,ignoreDepthValues:!1,framebufferScaleFactor:1});const Z=Symbol("@@webxr-polyfill/XRInputSourceEvent");class J extends Event{constructor(e,t){super(e,t),this[Z]={frame:t.frame,inputSource:t.inputSource},Object.setPrototypeOf(this,J.prototype)}get frame(){return this[Z].frame}get inputSource(){return this[Z].inputSource}}const Q=Symbol("@@webxr-polyfill/XRSessionEvent");class ee extends Event{constructor(e,t){super(e,t),this[Q]={session:t.session},Object.setPrototypeOf(this,ee.prototype)}get session(){return this[Q].session}}const te=Symbol("@@webxr-polyfill/XRInputSourcesChangeEvent");class re extends Event{constructor(e,t){super(e,t),this[te]={session:t.session,added:t.added,removed:t.removed},Object.setPrototypeOf(this,re.prototype)}get session(){return this[te].session}get added(){return this[te].added}get removed(){return this[te].removed}}const ie=Symbol("@@webxr-polyfill/XRSession");class se extends w{constructor(e){super(e)}get eye(){return this._specialType}_onPoseUpdate(e){this._inverseBaseMatrix=e.getBaseViewMatrix(this._specialType)}}class ne extends r{constructor(e,t,r){super();let i="inline"!=t,s=new H({inlineVerticalFieldOfView:i?null:.5*Math.PI});this[ie]={device:e,mode:t,immersive:i,ended:!1,suspended:!1,frameCallbacks:[],currentFrameCallbacks:null,frameHandle:0,deviceFrameHandle:null,id:r,activeRenderState:s,pendingRenderState:null,viewerSpace:new S("viewer"),viewSpaces:[],currentInputSources:[]},i?this[ie].viewSpaces.push(new se("left"),new se("right")):this[ie].viewSpaces.push(new se("none")),this[ie].onDeviceFrame=(()=>{if(this[ie].ended||this[ie].suspended)return;if(this[ie].deviceFrameHandle=null,this[ie].startDeviceFrameLoop(),null!==this[ie].pendingRenderState&&(this[ie].activeRenderState=new H(this[ie].pendingRenderState),this[ie].pendingRenderState=null,this[ie].activeRenderState.baseLayer&&this[ie].device.onBaseLayerSet(this[ie].id,this[ie].activeRenderState.baseLayer)),null===this[ie].activeRenderState.baseLayer)return;const t=new B(e,this,this[ie].id),r=this[ie].currentFrameCallbacks=this[ie].frameCallbacks;this[ie].frameCallbacks=[],t[k].active=!0,t[k].animationFrame=!0,this[ie].device.onFrameStart(this[ie].id,this[ie].activeRenderState),this._checkInputSourcesChange();const i=I();for(let e=0;e<r.length;e++)try{r[e].cancelled||"function"!=typeof r[e].callback||r[e].callback(i,t)}catch(e){console.error(e)}this[ie].currentFrameCallbacks=null,t[k].active=!1,this[ie].device.onFrameEnd(this[ie].id)}),this[ie].startDeviceFrameLoop=(()=>{null===this[ie].deviceFrameHandle&&(this[ie].deviceFrameHandle=this[ie].device.requestAnimationFrame(this[ie].onDeviceFrame))}),this[ie].stopDeviceFrameLoop=(()=>{const e=this[ie].deviceFrameHandle;null!==e&&(this[ie].device.cancelAnimationFrame(e),this[ie].deviceFrameHandle=null)}),this[ie].onPresentationEnd=(t=>{if(t!==this[ie].id)return this[ie].suspended=!1,this[ie].startDeviceFrameLoop(),void this.dispatchEvent("focus",{session:this});this[ie].ended=!0,this[ie].stopDeviceFrameLoop(),e.removeEventListener("@webvr-polyfill/vr-present-end",this[ie].onPresentationEnd),e.removeEventListener("@webvr-polyfill/vr-present-start",this[ie].onPresentationStart),e.removeEventListener("@@webvr-polyfill/input-select-start",this[ie].onSelectStart),e.removeEventListener("@@webvr-polyfill/input-select-end",this[ie].onSelectEnd),this.dispatchEvent("end",new ee("end",{session:this}))}),e.addEventListener("@@webxr-polyfill/vr-present-end",this[ie].onPresentationEnd),this[ie].onPresentationStart=(e=>{e!==this[ie].id&&(this[ie].suspended=!0,this[ie].stopDeviceFrameLoop(),this.dispatchEvent("blur",{session:this}))}),e.addEventListener("@@webxr-polyfill/vr-present-start",this[ie].onPresentationStart),this[ie].onSelectStart=(e=>{e.sessionId===this[ie].id&&this[ie].dispatchInputSourceEvent("selectstart",e.inputSource)}),e.addEventListener("@@webxr-polyfill/input-select-start",this[ie].onSelectStart),this[ie].onSelectEnd=(e=>{e.sessionId===this[ie].id&&(this[ie].dispatchInputSourceEvent("selectend",e.inputSource),this[ie].dispatchInputSourceEvent("select",e.inputSource))}),e.addEventListener("@@webxr-polyfill/input-select-end",this[ie].onSelectEnd),this[ie].onSqueezeStart=(e=>{e.sessionId===this[ie].id&&this[ie].dispatchInputSourceEvent("squeezestart",e.inputSource)}),e.addEventListener("@@webxr-polyfill/input-squeeze-start",this[ie].onSqueezeStart),this[ie].onSqueezeEnd=(e=>{e.sessionId===this[ie].id&&(this[ie].dispatchInputSourceEvent("squeezeend",e.inputSource),this[ie].dispatchInputSourceEvent("squeeze",e.inputSource))}),e.addEventListener("@@webxr-polyfill/input-squeeze-end",this[ie].onSqueezeEnd),this[ie].dispatchInputSourceEvent=((t,r)=>{const i=new B(e,this,this[ie].id),s=new J(t,{frame:i,inputSource:r});i[k].active=!0,this.dispatchEvent(t,s),i[k].active=!1}),this[ie].startDeviceFrameLoop(),this.onblur=void 0,this.onfocus=void 0,this.onresetpose=void 0,this.onend=void 0,this.onselect=void 0,this.onselectstart=void 0,this.onselectend=void 0}get renderState(){return this[ie].activeRenderState}get environmentBlendMode(){return this[ie].device.environmentBlendMode||"opaque"}async requestReferenceSpace(e){if(this[ie].ended)return;if(!y.includes(e))throw new TypeError(`XRReferenceSpaceType must be one of ${y}`);if(!this[ie].device.doesSessionSupportReferenceSpace(this[ie].id,e))throw new DOMException(`The ${e} reference space is not supported by this session.`,"NotSupportedError");if("viewer"===e)return this[ie].viewerSpace;let t=await this[ie].device.requestFrameOfReferenceTransform(e);if("bounded-floor"===e){if(!t)throw new DOMException(`${e} XRReferenceSpace not supported by this device.`,"NotSupportedError");if(!this[ie].device.requestStageBounds())throw new DOMException(`${e} XRReferenceSpace not supported by this device.`,"NotSupportedError");throw new DOMException(`The WebXR polyfill does not support the ${e} reference space yet.`,"NotSupportedError")}return new S(e,t)}requestAnimationFrame(e){if(this[ie].ended)return;const t=++this[ie].frameHandle;return this[ie].frameCallbacks.push({handle:t,callback:e,cancelled:!1}),t}cancelAnimationFrame(e){let t=this[ie].frameCallbacks,r=t.findIndex(t=>t&&t.handle===e);r>-1&&(t[r].cancelled=!0,t.splice(r,1)),(t=this[ie].currentFrameCallbacks)&&(r=t.findIndex(t=>t&&t.handle===e))>-1&&(t[r].cancelled=!0)}get inputSources(){return this[ie].device.getInputSources()}async end(){if(!this[ie].ended)return this[ie].immersive&&(this[ie].ended=!0,this[ie].device.removeEventListener("@@webvr-polyfill/vr-present-start",this[ie].onPresentationStart),this[ie].device.removeEventListener("@@webvr-polyfill/vr-present-end",this[ie].onPresentationEnd),this[ie].device.removeEventListener("@@webvr-polyfill/input-select-start",this[ie].onSelectStart),this[ie].device.removeEventListener("@@webvr-polyfill/input-select-end",this[ie].onSelectEnd),this.dispatchEvent("end",new ee("end",{session:this}))),this[ie].stopDeviceFrameLoop(),this[ie].device.endSession(this[ie].id)}updateRenderState(e){if(this[ie].ended){throw new Error("Can't call updateRenderState on an XRSession that has already ended.")}if(e.baseLayer&&e.baseLayer._session!==this){throw new Error("Called updateRenderState with a base layer that was created by a different session.")}if(null!==e.inlineVerticalFieldOfView&&void 0!==e.inlineVerticalFieldOfView){if(this[ie].immersive){throw new Error("inlineVerticalFieldOfView must not be set for an XRRenderState passed to updateRenderState for an immersive session.")}e.inlineVerticalFieldOfView=Math.min(3.13,Math.max(.01,e.inlineVerticalFieldOfView))}if(null===this[ie].pendingRenderState){const e=this[ie].activeRenderState;this[ie].pendingRenderState={depthNear:e.depthNear,depthFar:e.depthFar,inlineVerticalFieldOfView:e.inlineVerticalFieldOfView,baseLayer:e.baseLayer}}Object.assign(this[ie].pendingRenderState,e)}_checkInputSourcesChange(){const e=[],t=[],r=this.inputSources,i=this[ie].currentInputSources;for(const t of r)i.includes(t)||e.push(t);for(const e of i)r.includes(e)||t.push(e);(e.length>0||t.length>0)&&this.dispatchEvent("inputsourceschange",new re("inputsourceschange",{session:this,added:e,removed:t})),this[ie].currentInputSources.length=0;for(const e of r)this[ie].currentInputSources.push(e)}}const ae=Symbol("@@webxr-polyfill/XRInputSource");const oe=Symbol("@@webxr-polyfill/XRReferenceSpaceEvent");class he extends Event{constructor(e,t){super(e,t),this[oe]={referenceSpace:t.referenceSpace,transform:t.transform||null},Object.setPrototypeOf(this,he.prototype)}get referenceSpace(){return this[oe].referenceSpace}get transform(){return this[oe].transform}}var le={XR:class extends r{constructor(e){super(),this[R]={device:null,devicePromise:e,immersiveSession:null,inlineSessions:new Set},e.then(e=>{this[R].device=e})}async isSessionSupported(e){return this[R].device||await this[R].devicePromise,"inline"!=e?Promise.resolve(this[R].device.isSessionSupported(e)):Promise.resolve(!0)}async requestSession(e,t){if(!this[R].device){if("inline"!=e)throw new Error(A);await this[R].devicePromise}if(!M.includes(e))throw new TypeError(`The provided value '${e}' is not a valid enum value of type XRSessionMode`);const r=x[e],i=r.requiredFeatures.concat(t&&t.requiredFeatures?t.requiredFeatures:[]),s=r.optionalFeatures.concat(t&&t.optionalFeatures?t.optionalFeatures:[]),n=new Set;let a=!1;for(let e of i)this[R].device.isFeatureSupported(e)?n.add(e):(console.error(`The required feature '${e}' is not supported`),a=!0);if(a)throw new DOMException("Session does not support some required features","NotSupportedError");for(let e of s)this[R].device.isFeatureSupported(e)?n.add(e):console.log(`The optional feature '${e}' is not supported`);const o=await this[R].device.requestSession(e,n),h=new XRSession(this[R].device,e,o);"inline"==e?this[R].inlineSessions.add(h):this[R].immersiveSession=h;const l=()=>{"inline"==e?this[R].inlineSessions.delete(h):this[R].immersiveSession=null,h.removeEventListener("end",l)};return h.addEventListener("end",l),h}},XRSession:ne,XRSessionEvent:ee,XRFrame:B,XRView:G,XRViewport:L,XRViewerPose:N,XRWebGLLayer:class{constructor(e,t,r={}){const i=Object.assign({},$,r);if(!(e instanceof ne))throw new Error("session must be a XRSession");if(e.ended)throw new Error("InvalidStateError");if(t[z]&&!0!==t[Y])throw new Error("InvalidStateError");const s=t.getParameter(t.FRAMEBUFFER_BINDING);this[K]={context:t,config:i,framebuffer:s,session:e}}get context(){return this[K].context}get antialias(){return this[K].config.antialias}get ignoreDepthValues(){return!0}get framebuffer(){return this[K].framebuffer}get framebufferWidth(){return this[K].context.drawingBufferWidth}get framebufferHeight(){return this[K].context.drawingBufferHeight}get _session(){return this[K].session}getViewport(e){return e._getViewport(this)}static getNativeFramebufferScaleFactor(e){if(!e)throw new TypeError("getNativeFramebufferScaleFactor must be passed a session.");return e[ie].ended?0:1}},XRSpace:w,XRReferenceSpace:S,XRReferenceSpaceEvent:he,XRInputSource:class{constructor(e){this[ae]={impl:e,gripSpace:new w("grip",this),targetRaySpace:new w("target-ray",this)}}get handedness(){return this[ae].impl.handedness}get targetRayMode(){return this[ae].impl.targetRayMode}get gripSpace(){let e=this[ae].impl.targetRayMode;return"gaze"===e||"screen"===e?null:this[ae].gripSpace}get targetRaySpace(){return this[ae].targetRaySpace}get profiles(){return this[ae].impl.profiles}get gamepad(){return this[ae].impl.gamepad}},XRInputSourceEvent:J,XRInputSourcesChangeEvent:re,XRRenderState:H,XRRigidTransform:g,XRPose:C};const ce=e=>"function"!=typeof e.prototype.makeXRCompatible&&(e.prototype.makeXRCompatible=function(){return this[Y]=!0,Promise.resolve()},!0),de=e=>{const t=e.prototype.getContext;e.prototype.getContext=function(e,r){const i=t.call(this,e,r);return i&&(i[z]=!0,r&&"xrCompatible"in r&&(i[Y]=r.xrCompatible)),i}},ue=async function(e,t){},pe={global:e,webvr:!0,cardboard:!0,cardboardConfig:null,allowCardboardOnDesktop:!1},_e=["navigator","HTMLCanvasElement","WebGLRenderingContext"];class me{constructor(e={}){this.config=Object.freeze(Object.assign({},pe,e)),this.global=this.config.global,this.nativeWebXR="xr"in this.global.navigator,this.injected=!1,this.nativeWebXR?this._injectCompatibilityShims(this.global):this._injectPolyfill(this.global)}_injectPolyfill(e){if(!_e.every(t=>!!e[t]))throw new Error(`Global must have the following attributes : ${_e}`);for(const t of Object.keys(le))void 0!==e[t]?console.warn(`${t} already defined on global.`):e[t]=le[t];ce(e.WebGLRenderingContext)&&(de(e.HTMLCanvasElement),e.OffscreenCanvas&&de(e.OffscreenCanvas),e.WebGL2RenderingContext&&ce(e.WebGL2RenderingContext));this.injected=!0,this._patchNavigatorXR()}_patchNavigatorXR(){let e=ue(this.global,this.config);this.xr=new le.XR(e),Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})}_injectCompatibilityShims(e){if(!_e.every(t=>!!e[t]))throw new Error(`Global must have the following attributes : ${_e}`);if(e.navigator.xr&&"supportsSession"in e.navigator.xr&&!("isSessionSupported"in e.navigator.xr)){let t=e.navigator.xr.supportsSession;e.navigator.xr.isSessionSupported=function(e){return t.call(this,e).then(()=>!0).catch(()=>!1)},e.navigator.xr.supportsSession=function(e){return console.warn("navigator.xr.supportsSession() is deprecated. Please call navigator.xr.isSessionSupported() instead and check the boolean value returned when the promise resolves."),t.call(this,e)}}}}const fe=1e-6;let ge="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function ve(){let e=new ge(16);return ge!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function we(e){let t=new ge(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function be(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Ee(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function ye(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],d=t[8],u=t[9],p=t[10],_=t[11],m=t[12],f=t[13],g=t[14],v=t[15],w=r[0],b=r[1],E=r[2],y=r[3];return e[0]=w*i+b*o+E*d+y*m,e[1]=w*s+b*h+E*u+y*f,e[2]=w*n+b*l+E*p+y*g,e[3]=w*a+b*c+E*_+y*v,w=r[4],b=r[5],E=r[6],y=r[7],e[4]=w*i+b*o+E*d+y*m,e[5]=w*s+b*h+E*u+y*f,e[6]=w*n+b*l+E*p+y*g,e[7]=w*a+b*c+E*_+y*v,w=r[8],b=r[9],E=r[10],y=r[11],e[8]=w*i+b*o+E*d+y*m,e[9]=w*s+b*h+E*u+y*f,e[10]=w*n+b*l+E*p+y*g,e[11]=w*a+b*c+E*_+y*v,w=r[12],b=r[13],E=r[14],y=r[15],e[12]=w*i+b*o+E*d+y*m,e[13]=w*s+b*h+E*u+y*f,e[14]=w*n+b*l+E*p+y*g,e[15]=w*a+b*c+E*_+y*v,e}function Se(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function Re(e,t){let r=t[0]+t[5]+t[10],i=0;return r>0?(i=2*Math.sqrt(r+1),e[3]=.25*i,e[0]=(t[6]-t[9])/i,e[1]=(t[8]-t[2])/i,e[2]=(t[1]-t[4])/i):t[0]>t[5]&&t[0]>t[10]?(i=2*Math.sqrt(1+t[0]-t[5]-t[10]),e[3]=(t[6]-t[9])/i,e[0]=.25*i,e[1]=(t[1]+t[4])/i,e[2]=(t[8]+t[2])/i):t[5]>t[10]?(i=2*Math.sqrt(1+t[5]-t[0]-t[10]),e[3]=(t[8]-t[2])/i,e[0]=(t[1]+t[4])/i,e[1]=.25*i,e[2]=(t[6]+t[9])/i):(i=2*Math.sqrt(1+t[10]-t[0]-t[5]),e[3]=(t[1]-t[4])/i,e[0]=(t[8]+t[2])/i,e[1]=(t[6]+t[9])/i,e[2]=.25*i),e}function Me(){let e=new ge(3);return ge!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function xe(e,t){let r=e[0],i=e[1],s=e[2],n=t[0],a=t[1],o=t[2];return Math.abs(r-n)<=fe*Math.max(1,Math.abs(r),Math.abs(n))&&Math.abs(i-a)<=fe*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(s-o)<=fe*Math.max(1,Math.abs(s),Math.abs(o))}!function(){let e=Me()}();class Ae extends r{constructor(e,t=null,r=0){super(),this._uid=t||Ae._generateUID(),this._transform=we(e),this._timestamp=r,this._poseChanged=!0,this._deleted=!1,this._placeholder=!1}get deleted(){return this._deleted}set deleted(e){this._deleted=e}get placeholder(){return this._placeholder}set placeholder(e){this._placeholder=e}isMesh(){return!1}get timeStamp(){return this._timestamp}get changed(){return this._poseChanged}clearChanged(){this._poseChanged=!1}get modelMatrix(){return this._transform}updateModelMatrix(e,t){if(this._timestamp=t,!this._deleted&&!function(e,t){let r=e[0],i=e[1],s=e[2],n=e[3],a=e[4],o=e[5],h=e[6],l=e[7],c=e[8],d=e[9],u=e[10],p=e[11],_=e[12],m=e[13],f=e[14],g=e[15],v=t[0],w=t[1],b=t[2],E=t[3],y=t[4],S=t[5],R=t[6],M=t[7],x=t[8],A=t[9],T=t[10],I=t[11],O=t[12],C=t[13],P=t[14],N=t[15];return Math.abs(r-v)<=fe*Math.max(1,Math.abs(r),Math.abs(v))&&Math.abs(i-w)<=fe*Math.max(1,Math.abs(i),Math.abs(w))&&Math.abs(s-b)<=fe*Math.max(1,Math.abs(s),Math.abs(b))&&Math.abs(n-E)<=fe*Math.max(1,Math.abs(n),Math.abs(E))&&Math.abs(a-y)<=fe*Math.max(1,Math.abs(a),Math.abs(y))&&Math.abs(o-S)<=fe*Math.max(1,Math.abs(o),Math.abs(S))&&Math.abs(h-R)<=fe*Math.max(1,Math.abs(h),Math.abs(R))&&Math.abs(l-M)<=fe*Math.max(1,Math.abs(l),Math.abs(M))&&Math.abs(c-x)<=fe*Math.max(1,Math.abs(c),Math.abs(x))&&Math.abs(d-A)<=fe*Math.max(1,Math.abs(d),Math.abs(A))&&Math.abs(u-T)<=fe*Math.max(1,Math.abs(u),Math.abs(T))&&Math.abs(p-I)<=fe*Math.max(1,Math.abs(p),Math.abs(I))&&Math.abs(_-O)<=fe*Math.max(1,Math.abs(_),Math.abs(O))&&Math.abs(m-C)<=fe*Math.max(1,Math.abs(m),Math.abs(C))&&Math.abs(f-P)<=fe*Math.max(1,Math.abs(f),Math.abs(P))&&Math.abs(g-N)<=fe*Math.max(1,Math.abs(g),Math.abs(N))}(this._transform,e)){this._poseChanged=!0;for(var r=0;r<16;r++)this._transform[r]=e[r];try{this.dispatchEvent("update",{source:this})}catch(e){console.error("XRAnchor update event error",e)}}}notifyOfRemoval(){try{this.dispatchEvent("remove",{source:this})}catch(e){console.error("XRAnchor removed event error",e)}}get position(){return Se(new Float32Array(3),this._poseMatrix)}get orientation(){return Re(new Float32Array(4),this._poseMatrix)}get uid(){return this._uid}static _generateUID(){return"anchor-"+(new Date).getTime()+"-"+Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}}class Te extends Ae{constructor(e,t=null){super(t,null),this._anchor=e,this._timestamp=e.timeStamp,this._tempArray=new Float32Array(16),this._offsetMatrix=ve(),t&&be(this._offsetMatrix,t),ye(this._transform,e.modelMatrix,this._offsetMatrix),this._handleAnchorUpdateListener=this._handleAnchorUpdate.bind(this),this._notifyOfRemovalListener=this.notifyOfRemoval.bind(this),this._handleReplaceAnchorListener=this._handleReplaceAnchor.bind(this),e.addEventListener("update",this._handleAnchorUpdateListener),e.addEventListener("removal",this._notifyOfRemovalListener),e.addEventListener("replaceAnchor",this._handleReplaceAnchorListener)}_handleReplaceAnchor(e){this._anchor.removeEventListener("update",this._handleAnchorUpdateListener),this._anchor.removeEventListener("removal",this._notifyOfRemovalListener),this._anchor.removeEventListener("replaceAnchor",this._handleReplaceAnchorListener),this._anchor=e,this._anchor.addEventListener("update",this._handleAnchorUpdateListener),this._anchor.addEventListener("removal",this._notifyOfRemovalListener),this._anchor.addEventListener("replaceAnchor",this._handleReplaceAnchorListener)}_handleAnchorUpdate(){ye(this._tempArray,this._anchor.modelMatrix,this._offsetMatrix),this.updateModelMatrix(this._tempArray,Math.max(this._anchor.timeStamp,this._timestamp))}get modelMatrix(){return this._transform}clearChanged(){super.clearChanged()}get anchor(){return this._anchor}get offsetMatrix(){return this._offsetMatrix}set offsetMatrix(e){be(this._offsetMatrix,e),this._handleAnchorUpdate()}}var Ie=!1;class Oe extends Ae{static setUseGeomArrays(){Ie=!0}static useGeomArrays(){return Ie}constructor(e,t,r=null,i=0){super(e,r,i),this._useGeomArrays=Ie,this._vertexCountChanged=!0,this._vertexPositionsChanged=!0,this._triangleIndicesChanged=!0,this._textureCoordinatesChanged=!0,this._vertexPositions=[],this._triangleIndices=[],this._textureCoordinates=[],this._vertexNormalsChanged=!0,this._vertexNormals=[],t&&(this._geometry=t,this._updateGeometry(this._geometry))}isMesh(){return!0}get changed(){return super.changed||this._vertexPositionsChanged||this._vertexNormalsChanged||this._triangleIndicesChanged||this._vertexCountChanged}clearChanged(){super.clearChanged(),this._vertexPositionsChanged=!1,this._vertexNormalsChanged=!1,this._triangleIndicesChanged=!1,this._vertexCountChanged=!1}get vertexCountChanged(){return this._vertexCountChanged}get vertexPositionsChanged(){return this._vertexPositionsChanged}get triangleIndicesChanged(){this._triangleIndicesChanged}get textureCoordinatesChanged(){this._textureCoordinatesChanged}get vertexNormalsChanged(){this._vertexNormalsChanged}get vertexPositions(){return this._vertexPositions}get vertexNormals(){return this._vertexNormals}get triangleIndices(){return this._triangleIndices}get textureCoordinates(){return this._textureCoordinates}get vertexCount(){return this._vertexPositions.length}get triangleCount(){return this._triangleIndices.length}get hasNormals(){return this._vertexNormals.length>0}get hasTextureCoordinates(){return this._textureCoordinates.length>0}_updateGeometry(e){this._geometry=e;let t=e;if(0==t.vertexCount)return void(this._vertexPositions.length>0&&(this._vertexPositionsChanged=!0,this._vertexNormalsChanged=!0,this._triangleIndicesChanged=!0,this._textureCoordinatesChanged=!0,this._vertexPositions=[],this._vertexNormals=[],this.triangleIndices=[],this._textureCoordinates=[]));if(void 0===t.vertexCount)return void console.warn("bad geometry data passed to XRMesh._updateGeometry: no vertex count",t);let r=0;if(this._vertexPositions.length!=3*t.vertexCount){if(void 0===t.vertices)return void console.warn("bad geometry data passed to XRMesh._updateGeometry: no vertices",t);this._vertexCountChanged=!0,this._vertexPositionsChanged=!0,this._vertexPositions=new Float32Array(3*t.vertexCount),t.textureCoordinates&&(this._textureCoordinatesChanged=!0,this._textureCoordinates=new Float32Array(2*t.vertexCount))}else if(this._useGeomArrays)this._vertexPositionsChanged=void 0!==t.vertices&&!Oe.arrayFuzzyEquals(this._vertexPositions,t.vertices),this._textureCoordinatesChanged=void 0!==t.textureCoordinates&&!Oe.arrayFuzzyEquals(this._textureCoordinates,t.textureCoordinates);else{if(this._vertexPositionsChanged=!1,t.vertices){r=0;for(var i=0,s=t.vertexCount;i<s;i++)if(Math.abs(this._vertexPositions[r++]-t.vertices[i].x)>fe||Math.abs(this._vertexPositions[r++]-t.vertices[i].y)>fe||Math.abs(this._vertexPositions[r++]-t.vertices[i].z)>fe){this._vertexPositionsChanged=!0;break}}if(this._textureCoordinatesChanged=!1,t.textureCoordinates){r=0;for(i=0,s=t.vertexCount;i<s;i++)if(Math.abs(this._textureCoordinates[r++]-t.textureCoordinates[i].x)>fe||Math.abs(this._textureCoordinates[r++]-t.textureCoordinates[i].x)>fe){this._textureCoordinatesChanged=!0;break}}}if(t.triangleCount?this._triangleIndices.length!=3*t.triangleCount?(this._triangleIndicesChanged=!0,this._triangleIndices=(Oe.arrayMax(t.triangleIndices),new Uint32Array(3*t.triangleCount))):this._triangleIndicesChanged=t.triangleIndicies&&!Oe.arrayEquals(this._triangleIndices,t.triangleIndices):this._triangleIndicesChanged=!1,this._vertexPositionsChanged)if(this._useGeomArrays)this._vertexPositions.set(t.vertices);else{r=0;for(let e of t.vertices)this._vertexPositions[r++]=e.x,this._vertexPositions[r++]=e.y,this._vertexPositions[r++]=e.z}if(this._textureCoordinatesChanged)if(r=0,this._useGeomArrays)this._textureCoordinates.set(t.textureCoordinates);else for(let e of t.textureCoordinates)this._textureCoordinates[r++]=e.x,this._textureCoordinates[r++]=e.y;this._triangleIndicesChanged&&this._triangleIndices.set(t.triangleIndices)}static arrayMax(e){if(0===e.length)return-1/0;for(var t=e[0],r=1,i=e.length;r<i;++r)e[r]>t&&(t=e[r]);return t}static arrayEquals(e,t){if(!e||!t)return!1;if(e.length!=t.length)return!1;for(var r=0,i=e.length;r<i;r++)if(e[r]!=t[r])return!1;return!0}static arrayFuzzyEquals(e,t){if(!e||!t)return!1;if(e.length!=t.length)return!1;for(var r=0,i=e.length;r<i;r++)if(Math.abs(e[r]-t[r])>fe)return!1;return!0}}class Ce extends Oe{constructor(e,t,r,i=null,s=0){super(e,t,i,s),this._blendShapes={},this._blendShapesChanged=!0,this._updateBlendShapes(r)}get changed(){return super.changed||this._blendShapesChanged}clearChanged(){super.clearChanged(),this._blendShapesChanged=!1}_updateBlendShapes(e){for(let i=0;i<Pe.length;i++){let s=Pe[i];var t=this._blendShapes[s],r=e[i];Math.abs(t-r)>fe&&(this._blendShapesChanged=!0,this._blendShapes[s]=r)}}updateFaceData(e,t,r,i){super.updateModelMatrix(e,i),void 0===t.vertexCount&&(t.vertexCount=t.vertices.length/(Oe.useGeomArrays()?3:1)),this._updateGeometry(t),this._updateBlendShapes(r)}get blendShapes(){return this._blendShapes}}const Pe=["browDownLeft","browDownRight","browInnerUp","browOuterUpLeft","browOuterUpRight","cheekPuff","cheekSquintLeft","cheekSquintRight","eyeBlinkLeft","eyeBlinkRight","eyeLookDownLeft","eyeLookDownRight","eyeLookInLeft","eyeLookInRight","eyeLookOutLeft","eyeLookOutRight","eyeLookUpLeft","eyeLookUpRight","eyeSquintLeft","eyeSquintRight","eyeWideLeft","eyeWideRight","jawForward","jawLeft","jawOpen","jawRight","mouthClose","mouthDimpleLeft","mouthDimpleRight","mouthFrownLeft","mouthFrownRight","mouthFunnel","mouthLeft","mouthLowerDownLeft","mouthLowerDownRight","mouthPressLeft","mouthPressRight","mouthPucker","mouthRight","mouthRollLower","mouthRollUpper","mouthShrugLower","mouthShrugUpper","mouthSmileLeft","mouthSmileRight","mouthStretchLeft","mouthStretchRight","mouthUpperUpLeft","mouthUpperUpRight","noseSneerLeft","noseSneerRight"];class Ne{constructor(e=null,t=null,r){this._hit=t,this._timestamp=r,this._hitMatrix=we(e)}get hitMatrix(){return this._hitMatrix}get timeStamp(){return this._timestamp}}class Fe extends Ae{}const Le=Symbol("@@webxr-polyfill/XRLightProbe");class De{constructor(e={}){this[Le]={indirectIrradiance:e.indirectIrradiance}}get indirectIrradiance(){return this[Le].indirectIrradiance}get primaryLightDirection(){throw new Error("Not implemented")}get primaryLightIntensity(){throw new Error("Not implemented")}get sphericalHarmonicsCoefficients(){throw new Error("Not implemented")}get sphericalHarmonicsOrientation(){throw new Error("Not implemented")}}function Ve(){let e=new ge(4);return ge!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}!function(){let e=Ve()}();class Ge extends Oe{constructor(e,t,r,i,s,n=null,a=0){super(e,null,n,a),this._center=t,this._extent=r,this._alignment=i,this._planeFeatureChanged=!0,this._yAxis=function(e,t,r,i){let s=new ge(4);return s[0]=e,s[1]=t,s[2]=r,s[3]=i,s}(0,1,0,0),this._normal=Ve(),this._boundaryVerticesChanged=!0,this._boundaryVertices=[],this._geometry=s,this._updateGeometry(this._geometry)}get changed(){return super.changed||this._planeFeatureChanged}clearChanged(){super.clearChanged(),this._planeFeatureChanged=!1}updatePlaneData(e,t,r,i,s,n){super.updateModelMatrix(e,n),xe(this._center,t)&&xe(this._extent,r)&&!this._alignment||(this._center=t,this._extent=r,this._alignment=i,this._planeFeatureChanged=!0),this._updateGeometry(s)}get center(){return this._center}get extent(){return this._extent}get alignment(){return this._alignment}get boundaryVertices(){return this._boundaryVertices}get boundaryVerticesChanged(){return this._boundaryVerticesChanged}get boundaryVertexCount(){return this._boundaryVertices.length}_updateGeometry(e){super._updateGeometry(e);let t=e;const r=function(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3];return e[0]=r[0]*i+r[4]*s+r[8]*n+r[12]*a,e[1]=r[1]*i+r[5]*s+r[9]*n+r[13]*a,e[2]=r[2]*i+r[6]*s+r[10]*n+r[14]*a,e[3]=r[3]*i+r[7]*s+r[11]*n+r[15]*a,e}(this._normal,this._yAxis,this._transform),i=r[0],s=r[1],n=r[2];let a=0;if(this._boundaryVertices.length!=3*t.boundaryVertexCount)this._boundaryVerticesChanged=!0,this._boundaryVertices=new Float32Array(3*t.vertexCount),this._vertexNormalsChanged=!0,this._vertexNormals=new Float32Array(3*t.vertexCount);else if(this._vertexNormalsChanged=Math.abs(this._vertexNormals[0]-i)>fe||Math.abs(this._vertexNormals[1]-s)>fe||Math.abs(this._vertexNormals[2]-n)>fe,this._useGeomArrays)this._vertexPositionsChanged=!Oe.arrayFuzzyEquals(this._boundaryVertices,t.boundaryVertices);else{this._boundaryVerticesChanged=!1,a=0;for(var o=0,h=t.vertexCount;o<h;o++)if(Math.abs(this._boundaryVertices[a++]-t.boundaryVertices[o].x)>fe||Math.abs(this._boundaryVertices[a++]-t.boundaryVertices[o].y)>fe||Math.abs(this._boundaryVertices[a++]-t.boundaryVertices[o].z)>fe){this._boundaryVerticesChanged=!0;break}}if(this._boundaryVerticesChanged)if(this._useGeomArrays)this._boundaryVertices.set(t.boundaryVertices);else{a=0;for(let e of t.boundaryVertices)this._boundaryVertices[a++]=e.x,this._boundaryVertices[a++]=e.y,this._boundaryVertices[a++]=e.z}if(this._vertexNormalsChanged){a=0;for(o=0;o<t.vertexCount;o++)this._vertexNormals[a++]=i,this._vertexNormals[a++]=s,this._vertexNormals[a++]=n}}}class ke{static decodeLength(e){return e.length/4*3}static decodeArrayBuffer(e,t){var r=e.length/4*3;return t&&t.byteLength==r||(t=new ArrayBuffer(r)),this.decode(e,t),t}static removePaddingChars(e){return 64==this._keyStr.indexOf(e.charAt(e.length-1))?e.substring(0,e.length-1):e}static decode(e,t){e=this.removePaddingChars(e),e=this.removePaddingChars(e);var r,i,s,n,a,o,h,l=parseInt(e.length/4*3,10),c=0,d=0;for(r=t?new Uint8Array(t):new Uint8Array(l),e=e.replace(/[^A-Za-z0-9\+\/\=]/g,""),c=0;c<l;c+=3)i=this._keyStr.indexOf(e.charAt(d++))<<2|(a=this._keyStr.indexOf(e.charAt(d++)))>>4,s=(15&a)<<4|(o=this._keyStr.indexOf(e.charAt(d++)))>>2,n=(3&o)<<6|(h=this._keyStr.indexOf(e.charAt(d++))),r[c]=i,64!=o&&(r[c+1]=s),64!=h&&(r[c+2]=n);return r}static encode(e){var t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=e;e instanceof ArrayBuffer?i=new Uint8Array(arrayBuffer):e instanceof ImageData&&(i=e.data);for(var s,n=e.length,a=n%3,o=n-a,h=0;h<o;h+=3)t+=r[(16515072&(s=i[h]<<16|i[h+1]<<8|i[h+2]))>>18]+r[(258048&s)>>12]+r[(4032&s)>>6]+r[63&s];return 1==a?t+=r[(252&(s=i[o]))>>2]+r[(3&s)<<4]+"==":2==a&&(t+=r[(64512&(s=i[o]<<8|i[o+1]))>>10]+r[(1008&s)>>4]+r[(15&s)<<2]+"="),t}}ke._keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var Xe=[];class We{constructor(e,t,r,i){this._buffers=e;for(var s=0;s<e.length;s++)if(e[s]._buffer=e[s].buffer,e[s].buffer=null,e[s]._abCache||"string"!=typeof e[s]._buffer){if(!e[s]._abCache&&e[s]._buffer instanceof ImageData){var n=e[s]._buffer.data;for(l=n.length,c=0;c<Xe.length;c++)if(Xe[c].byteLength==l){e[s]._abCache=Xe[c],Xe.splice(c,1);break}var a=e[s]._abCache?e[s]._abCache:new ArrayBuffer(l);e[s]._abCache=null;for(var o=new Uint8Array(a),h=0;h<l;h++)o[h]=n[h];e[s]._buffer=a}}else for(var l=ke.decodeLength(e[s]._buffer),c=0;c<Xe.length;c++)if(Xe[c].byteLength==l){e[s]._abCache=Xe[c],Xe.splice(c,1);break}this._pixelFormat=t,this._timestamp=r,this._camera=i}static createFromMessage(e){return new this(e.data.buffers,e.data.pixelFormat,e.data.timestamp,e.data.camera)}numBuffers(){this._buffers.length}buffer(e){if(e>=0&&e<this._buffers.length){var t=this._buffers[e];return t.buffer||("string"==typeof t._buffer?(t._buffer=ke.decodeArrayBuffer(t._buffer,t._abCache),t._abCache=null,t.buffer=new Uint8Array(t._buffer)):t._buffer instanceof ArrayBuffer?t.buffer=new Uint8Array(t._buffer):t._buffer instanceof ImageData&&(t.buffer=ImageData.data)),t}return null}get pixelFormat(){return this._pixelFormat}get timestamp(){return this._timestamp}get camera(){return this._camera}release(){for(var e=this._buffers,t=0;t<e.length;t++)e[t]._buffer instanceof ArrayBuffer&&e[t]._buffer.byteLength>0&&Xe.push(e[t]._buffer),e[t]._abCache instanceof ArrayBuffer&&e[t]._abCache.byteLength>0&&Xe.push(e[t]._abCache)}postMessageToWorker(e,t){var r=Object.assign({},t||{});r.buffers=this._buffers,r.timestamp=this._timestamp,r.pixelFormat=this._pixelFormat,r.camera=this._camera;for(var i=[],s=0;s<r.buffers.length;s++)r.buffers[s].buffer=r.buffers[s]._buffer,(r.buffers[s]._buffer instanceof ArrayBuffer||r.buffers[s]._buffer instanceof ImageData)&&i.push(r.buffers[s]._buffer),r.buffers[s]._buffer=null,r.buffers[s]._abCache instanceof ArrayBuffer&&i.push(r.buffers[s]._abCache);e.postMessage(r,i)}postReplyMessage(e){var t=Object.assign({},e);t.buffers=this._buffers,t.timestamp=this._timestamp,t.pixelFormat=this._pixelFormat,t.camera=this._camera;for(var r=[],i=0;i<t.buffers.length;i++)t.buffers[i].buffer=null,(t.buffers[i]._buffer instanceof ArrayBuffer||t.buffers[i]._buffer instanceof ImageData)&&(r.push(t.buffers[i]._buffer),t.buffers[i].buffer=t.buffers[i]._buffer),t.buffers[i]._buffer=null,t.buffers[i]._abCache instanceof ArrayBuffer&&r.push(t.buffers[i]._abCache);postMessage(t,r)}}We.IMAGEFORMAT_RGBA32="RGBA32",We.IMAGEFORMAT_BGRA32="BGRA32",We.IMAGEFORMAT_RGB24="RGB24",We.IMAGEFORMAT_BGR24="BGR24",We.IMAGEFORMAT_GRAY8="GRAY8",We.IMAGEFORMAT_YUV444P="YUV444P",We.IMAGEFORMAT_YUV422P="YUV422P",We.IMAGEFORMAT_YUV420P="YUV420P",We.IMAGEFORMAT_YUV420SP_NV12="YUV420SP_NV12",We.IMAGEFORMAT_YUV420SP_NV21="YUV420SP_NV21",We.IMAGEFORMAT_HSV="HSV",We.IMAGEFORMAT_Lab="Lab",We.IMAGEFORMAT_DEPTH="DEPTH",We.IMAGEFORMAT_NULL="",We.IMAGEFORMAT=[We.IMAGEFORMAT_RGBA32,We.IMAGEFORMAT_BGRA32,We.IMAGEFORMAT_RGB24,We.IMAGEFORMAT_BGR24,We.IMAGEFORMAT_GRAY8,We.IMAGEFORMAT_YUV444P,We.IMAGEFORMAT_YUV422P,We.IMAGEFORMAT_YUV420P,We.IMAGEFORMAT_YUV420SP_NV12,We.IMAGEFORMAT_YUV420SP_NV21,We.IMAGEFORMAT_HSV,We.IMAGEFORMAT_Lab,We.IMAGEFORMAT_DEPTH,We.IMAGEFORMAT_NULL];var Ue={XRAnchor:Ae,XRAnchorOffset:Te,XRFaceMesh:Ce,XRHitResult:Ne,XRImageAnchor:Fe,XRLightProbe:De,XRMesh:Oe,XRPlaneMesh:Ge,XRVideoFrame:We};class Be extends r{constructor(e){super(),this.global=e,this.onWindowResize=this.onWindowResize.bind(this),this.global.window.addEventListener("resize",this.onWindowResize),this.environmentBlendMode="opaque"}onBaseLayerSet(e,t){throw new Error("Not implemented")}isSessionSupported(e){throw new Error("Not implemented")}isFeatureSupported(e){throw new Error("Not implemented")}async requestSession(e,t){throw new Error("Not implemented")}requestAnimationFrame(e){throw new Error("Not implemented")}onFrameStart(e){throw new Error("Not implemented")}onFrameEnd(e){throw new Error("Not implemented")}doesSessionSupportReferenceSpace(e,t){throw new Error("Not implemented")}requestStageBounds(){throw new Error("Not implemented")}async requestFrameOfReferenceTransform(e,t){}cancelAnimationFrame(e){throw new Error("Not implemented")}endSession(e){throw new Error("Not implemented")}getViewport(e,t,r,i){throw new Error("Not implemented")}getProjectionMatrix(e){throw new Error("Not implemented")}getBasePoseMatrix(){throw new Error("Not implemented")}getBaseViewMatrix(e){throw new Error("Not implemented")}getInputSources(){throw new Error("Not implemented")}getInputPose(e,t,r){throw new Error("Not implemented")}onWindowResize(){this.onWindowResize()}}let qe=function(e,t,r=!0,i=!0){var s,n,a,o,h=0,l=function(){h=!1===r?0:Date.now(),s=null,o=e.apply(n,a),s||(n=a=null)},c=function(){var c=Date.now();h||!1!==r||(h=c);var d=t-(c-h);return n=this,a=arguments,d<=0||d>t?(s&&(clearTimeout(s),s=null),h=c,o=e.apply(n,a),s||(n=a=null)):s||!1===i||(s=setTimeout(l,d)),o};return c.cancel=function(){clearTimeout(s),h=0,s=n=a=null},c};qe(function(...e){console.log(...e)},1e3);class je extends r{constructor(){if(super(),!1===je.HasARKit())throw new Error("ARKitWrapper will only work in Mozilla's ARDemo test app");if(void 0!==je.GLOBAL_INSTANCE)throw new Error("ARKitWrapper is a singleton. Use ARKitWrapper.GetOrCreate() to get the global instance.");this._timestamp=0,this._lightProbe=null,this._deviceId=null,this._isWatching=!1,this._waitingForSessionStart=!1,this._isInitialized=!1,this._rawARData=null,this._rAF_callback=null,this._rAF_callbackParams=[],this._requestedPermissions={cameraAccess:!1,worldAccess:!1},this._currentPermissions={cameraAccess:!1,worldAccess:!1},this._worldSensingState={meshDetectionState:!1},this._worldInformation=null,this._projectionMatrix=new Float32Array(16),this._viewMatrix=new Float32Array(16),this._cameraTransform=new Float32Array(16),this._anchors=new Map,this._timeOffsets=[],this._timeOffset=0,this._timeOffsetComputed=!1,this._dataBeforeNext=0,this._worldMappingStatus=je.WEB_AR_WORLDMAPPING_NOT_AVAILABLE,this._defaultOptions={location:!0,camera:!0,objects:!0,light_intensity:!0,computer_vision_data:!1};const e={arkitStartRecording:je.RECORD_START_EVENT,arkitStopRecording:je.RECORD_STOP_EVENT,arkitDidMoveBackground:je.DID_MOVE_BACKGROUND_EVENT,arkitWillEnterForeground:je.WILL_ENTER_FOREGROUND_EVENT,arkitInterrupted:je.INTERRUPTED_EVENT,arkitInterruptionEnded:je.INTERRUPTION_ENDED_EVENT,arkitShowDebug:je.SHOW_DEBUG_EVENT,arkitWindowResize:je.WINDOW_RESIZE_EVENT,onError:je.ON_ERROR,arTrackingChanged:je.AR_TRACKING_CHANGED};for(const t in e)window[t]=(r=>{r=r||null;try{this.dispatchEvent(e[t],new CustomEvent(e[t],{source:this,detail:r}))}catch(e){console.error(t+" callback error",e)}});window.onComputerVisionData=(e=>{this._onComputerVisionData(e)}),window.setNativeTime=(e=>{this._timeOffsets.push((performance||Date).now()-e.nativeTime),this._timeOffsetComputed=!0,this._timeOffset=0;for(let e=0;e<this._timeOffsets.length;e++)this._timeOffset+=this._timeOffsets[e];this._timeOffset=this._timeOffset/this._timeOffsets.length}),window.userGrantedComputerVisionData=(e=>{this._sessionCameraAccess|=e.granted}),window.userGrantedWorldSensingData=(e=>{this._sessionWorldAccess|=e.granted})}static GetOrCreate(e=null){if(void 0===je.GLOBAL_INSTANCE){const t=new je;je.GLOBAL_INSTANCE=t;const r={browser:!0,points:!0,focus:!1,rec:!0,rec_time:!0,mic:!1,build:!1,plane:!0,warnings:!0,anchors:!1,debug:!0,statistics:!1},i="object"==typeof(e=e&&"object"==typeof e?e:{}).ui?e.ui:{};e.ui=Object.assign(r,i),e.geometry_arrays=!0,Oe.setUseGeomArrays(),console.log("----INIT"),t._initAR(e).then(e=>{t._deviceId=e,t._isInitialized=!0;try{t.dispatchEvent(je.INIT_EVENT,new CustomEvent(je.INIT_EVENT,{source:t}))}catch(e){console.error("INIT_EVENT event error",e)}})}return je.GLOBAL_INSTANCE}static HasARKit(){return void 0!==window.webkit}get deviceId(){return this._deviceId}get hasSession(){return this._isWatching}get isInitialized(){return this._isInitialized}_sendMessage(e,t={},r=!0,i=!0){return new Promise((s,n)=>{if(r&&!this._isInitialized)return void n(new Error("ARKit is not initialized"));const a={};if(i){const t="arkitCallback_"+e+"_"+(new Date).getTime()+"_"+Math.floor(Math.random()*Number.MAX_SAFE_INTEGER);window[t]=(e=>{delete window[t],s(e)}),a.callback=t}window.webkit.messageHandlers[e].postMessage(Object.assign({},t,a)),i||s()})}_initAR(e){return this._sendMessage("initAR",{options:e},!1)}_requestSession(e,t){return this._sendMessage("requestSession",{options:e,data_callback:t})}_hitTest(e,t,r){return this._sendMessage("hitTest",{x:e,y:t,type:r})}_addAnchor(e,t){return this._sendMessage("addAnchor",{uuid:e,transform:t})}_removeAnchors(e){return new Promise(t=>{window.webkit.messageHandlers.removeAnchors.postMessage(e),t()})}_createDetectionImage(e,t,r,i,s){return this._sendMessage("createImageAnchor",{uid:e,buffer:ke.encode(t),imageWidth:r,imageHeight:i,physicalWidth:s})}_destroyDetectionImage(e){return this._sendMessage("destroyImageAnchor",{uid:e})}_activateDetectionImage(e,t=!1){return this._sendMessage("activateDetectionImage",{uid:e,trackable:t})}_deactivateDetectionImage(e){return this._sendMessage("deactivateDetectionImage",{uid:e})}_setNumberOfTrackedImages(e){this._sendMessage("setNumberOfTrackedImages",{numberOfTrackedImages:"number"==typeof e?e:0},!0,!1)}_getWorldMap(){return this._sendMessage("getWorldMap")}_setWorldMap(e){return this._sendMessage("setWorldMap",{worldMap:e.worldMap})}_stop(){return this._sendMessage("stopAR")}_setUIOptions(e){return this._sendMessage("setUIOptions",e,!0,!1)}_onUpdate(){return window.webkit.messageHandlers.onUpdate.postMessage({})}_requestComputerVisionData(){return this._sendMessage("requestComputerVisionData",{},!0,!1)}_startSendingComputerVisionData(){return this._sendMessage("startSendingComputerVisionData",{},!0,!1)}_stopSendingComputerVisionData(){return this._sendMessage("stopSendingComputerVisionData",{},!0,!1)}_onData(e){if(this._rawARData=e,this._worldInformation=null,this._timestamp=this._adjustARKitTime(e.timestamp),this._lightProbe=new De({indirectIrradiance:e.light_intensity/1e3}),be(this._cameraTransform,e.camera_transform),be(this._viewMatrix,e.camera_view),be(this._projectionMatrix,e.projection_camera),this._worldMappingStatus=e.worldMappingStatus,e.newObjects.length)for(let t=0;t<e.newObjects.length;t++){const r=e.newObjects[t],i=this._anchors.get(r.uuid);i&&i.deleted&&(i.deleted=!1),this._createOrUpdateAnchorObject(r)}if(e.removedObjects.length)for(let t=0;t<e.removedObjects.length;t++){const r=e.removedObjects[t],i=this._anchors.get(r);i?(i.notifyOfRemoval(),this._anchors.delete(r)):console.error("app signalled removal of non-existant anchor/plane")}if(e.objects.length)for(let t=0;t<e.objects.length;t++){const r=e.objects[t];this._createOrUpdateAnchorObject(r)}try{this.dispatchEvent(je.WATCH_EVENT,new CustomEvent(je.WATCH_EVENT,{source:this,detail:this}))}catch(e){console.error("WATCH_EVENT event error",e)}this._rAF_callback&&this._do_rAF(),this._dataBeforeNext++}_onComputerVisionData(e){if(!e)return console.error("detail passed to _onComputerVisionData is null"),void this._requestComputerVisionData();if(!e.frame||!e.frame.buffers||e.frame.buffers.length<=0)return console.error("detail passed to _onComputerVisionData is bad, no buffers"),void this._requestComputerVisionData();e.camera.arCamera=!0;const t=e.camera.interfaceOrientation;switch(e.camera.viewMatrix=e.camera.inverse_viewMatrix,t){case 1:e.camera.cameraOrientation=-90;break;case 2:e.camera.cameraOrientation=90;break;case 3:e.camera.cameraOrientation=0;break;case 4:e.camera.cameraOrientation=180}switch(e.frame.pixelFormatType){case"kCVPixelFormatType_420YpCbCr8BiPlanarFullRange":e.frame.pixelFormat="YUV420P";break;default:e.frame.pixelFormat=e.frame.pixelFormatType}const r=new We(e.frame.buffers,e.frame.pixelFormat,this._adjustARKitTime(e.frame.timestamp),e.camera);try{this.dispatchEvent(je.COMPUTER_VISION_DATA,new CustomEvent(je.COMPUTER_VISION_DATA,{source:this,detail:r}))}catch(e){console.error("COMPUTER_VISION_DATA event error",e)}}_do_rAF(){if(this._rAF_callback){const e=this._rAF_callback,t=this._rAF_callbackParams;return this._rAF_callback=null,this._rAF_callbackParams=[],window.requestAnimationFrame((...r)=>{this.startingRender();try{e(...t)}catch(e){console.error("application callback error: ",e)}this.finishedRender()})}}_createOrUpdateAnchorObject(e){if(e.plane_center){const t=this._anchors.get(e.uuid);if(!t||t.placeholder){const r=new Ge(e.transform,e.plane_center,[e.plane_extent.x,e.plane_extent.z],e.plane_alignment,e.geometry,e.uuid,this._timestamp);if(t){try{t.dispatchEvent("replaceAnchor",new CustomEvent("replaceAnchor",{source:t,detail:r}))}catch(e){console.error("replaceAnchor event error",e)}console.log("replaced dummy anchor created from hit test with plane"),this._anchors.delete(e.uuid)}this._anchors.set(e.uuid,r),e.object=r}else t&&(t.updatePlaneData(e.transform,e.plane_center,[e.plane_extent.x,e.plane_extent.y],e.plane_alignment,e.geometry,this._timestamp),e.object=t)}else{const t=this._anchors.get(e.uuid);if(!t||t.placeholder){let r;switch(e.type){case je.ANCHOR_TYPE_FACE:r=new Ce(e.transform,e.geometry,e.blendShapes,e.uuid,this._timestamp);break;case je.ANCHOR_TYPE_ANCHOR:r=new Ae(e.transform,e.uuid,this._timestamp);break;case je.ANCHOR_TYPE_IMAGE:r=new Fe(e.transform,e.uuid,this._timestamp)}if(t){try{t.dispatchEvent("replaceAnchor",new CustomEvent("replaceAnchor",{source:t||mesh,detail:r}))}catch(e){console.error("replaceAnchor event error",e)}console.log("replaced dummy anchor created from hit test with new anchor")}this._anchors.set(e.uuid,r),e.object=r}else{switch(e.type){case je.ANCHOR_TYPE_FACE:t.updateFaceData(e.transform,e.geometry,e.blendShapes,this._timestamp);break;default:t.updateModelMatrix(e.transform,this._timestamp)}e.object=t}}}_adjustARKitTime(e){return this._timeOffsetComputed?e+this._timeOffset:(performance||Date).now()}get hasData(){return null!==this._rawARData}getData(e=null){return e?this._rawARData&&void 0!==this._rawARData[e]?this._rawARData[e]:null:this._rawARData}waitForInit(){return new Promise((e,t)=>{if(this._isInitialized)return void e();const r=()=>{this.removeEventListener(je.INIT_EVENT,r,!1),e()};this.addEventListener(je.INIT_EVENT,r,!1)})}pickBestHit(e){if(0===e.length)return null;const t=e.filter(e=>e.type!=je.HIT_TEST_TYPE_FEATURE_POINT),r=t.filter(e=>e.type==je.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT),i=t.filter(e=>e.type==je.HIT_TEST_TYPE_EXISTING_PLANE);return r.length?(r=r.sort((e,t)=>e.distance-t.distance),r[0]):i.length?(i=i.sort((e,t)=>e.distance-t.distance),i[0]):t.length?(t=t.sort((e,t)=>e.distance-t.distance),t[0]):e[0]}createAnchorFromHit(e){return new Promise((t,r)=>{if(e.anchor_transform){let r=this._anchors.get(e.uuid);r?r.placeholder&&r.updateModelMatrix(e.anchor_transform,this._timestamp):(r=new Ae(e.anchor_transform,e.uuid,this._timestamp),console.log("created dummy anchor from hit test"),r.placeholder=!0,this._anchors.set(e.uuid,r)),t(new Te(r,e.local_transform))}else{let r=this._anchors.get(e.uuid);r?(r.placeholder=!1,r.deleted=!1,console.log("hit test resulted in a hit on an existing anchor, without an offset")):(r=new Ae(e.world_transform,e.uuid),console.log("created dummy anchor (not a plane) from hit test"),r.placeholder=!0,this._anchors.set(e.uuid,r)),t(r)}})}requestAnimationFrame(e,...t){this._rAF_callback=e,this._rAF_callbackParams=t,this._dataBeforeNext>0&&this._do_rAF()}startingRender(){this._dataBeforeNext}finishedRender(){this._dataBeforeNext=0,this._anchors.forEach(e=>{e.clearChanged()}),this._onUpdate()}watch(e=null){return new Promise((t,r)=>{if(!this._isInitialized)return void r("ARKitWrapper hasn't been initialized yet");if(this._waitingForSessionStart)return void r("ARKitWrapper startSession called, waiting to finish");if(this._isWatching)return void t({cameraAccess:this._sessionCameraAccess,worldAccess:this._sessionWorldAccess,webXRAccess:!0});this._waitingForSessionStart=!0;let i=Object.assign({},this._defaultOptions);null!==e&&(i=Object.assign(i,e)),this._requestedPermissions.cameraAccess=i.videoFrames,this._requestedPermissions.worldAccess=i.worldSensing,i.videoFrames&&(delete i.videoFrames,i.computer_vision_data=!0),console.log("----WATCH");void 0===window.arkitCallbackOnData&&(window.arkitCallbackOnData=(e=>{this._onData(e)})),this._requestSession(i,"arkitCallbackOnData").then(e=>{e.webXRAccess?(this._waitingForSessionStart=!1,this._isWatching=!0,this._currentPermissions.cameraAccess=e.cameraAccess,this._currentPermissions.worldAccess=e.worldAccess,t(e)):r(new Error("user did not give permission to start a webxr session"))})})}stop(){return new Promise((e,t)=>{this._isWatching?(console.log("----STOP"),this._stop().then(t=>{this._isWatching=!1,e(t)})):e()})}hitTest(e,t,r=je.HIT_TEST_TYPE_ALL){return this._hitTest(e,t,r)}createAnchor(e){return new Promise((t,r)=>{const i=new Ae(e,null,this._timestamp);this._addAnchor(i.uid,e).then(e=>{if(e.error)return void r(e.error);const s=this._anchors.get(e.uuid);s?(s.placeholder=!1,s.deleted=!1,s.updateModelMatrix(e.transform,this._timestamp),t(s)):(this._anchors.set(e.uuid,i),t(i))}).catch((...e)=>{console.error("could not create anchor",...e),r()})})}removeAnchor(e){let t=this._anchors.get(e.uid);t.placeholder?this._anchors.delete(e.uid):(t&&(t.deleted=!0),!e instanceof Te&&this._removeAnchors([e.uid]))}createDetectionImage(e,t,r,i,s){return new Promise((n,a)=>{this._createDetectionImage(e,t,r,i,s).then(e=>{e.error?a(e.error):e.created?n():a(null)}).catch((...e)=>{console.error("could not create image",...e),a()})})}destroyDetectionImage(e){return new Promise((t,r)=>{this._destroyDetectionImage(e).then(e=>{e.error?r(e.error):t()}).catch((...e)=>{console.error("could not destroy image",...e),r()})})}activateDetectionImage(e,t=!1){return new Promise((r,i)=>{const s=this._anchors.get(e);!s||s.deleted?this._activateDetectionImage(e,t).then(e=>{e.error&&(i(e.error),i()),e.activated?(this._createOrUpdateAnchorObject(e.imageAnchor),e.imageAnchor.object.deleted=!1,r(e.imageAnchor.object)):i(null)}).catch((...e)=>{console.error("could not activate image",...e),i()}):r(s)})}deactivateDetectionImage(e){return new Promise((t,r)=>{this._deactivateDetectionImage(e).then(i=>{i.error&&r(i.error);const s=this._anchors.get(e);s&&(console.warn("anchor for image target '"+e+"' still exists after deactivation"),this.removeAnchor(s)),t()}).catch((...e)=>{console.error("could not activate image",...e),r()})})}setNumberOfTrackedImages(e){return this._setNumberOfTrackedImages(e)}getWorldMap(){return new Promise((e,t)=>{this._getWorldMap().then(r=>{if(!0!==r.saved)return null!==r.error?void t(r.error):void t(null);e(r.worldMap)}).catch((...e)=>{console.error("could not get world map",...e),t()})})}setWorldMap(e){return this._setWorldMap(e)}getLightProbe(){return new Promise((e,t)=>{this._lightProbe?e(this._lightProbe):t(new Error("Not populated yet"))})}setUIOptions(e){return this._setUIOptions(e)}updateWorldSensingState(e){return e.hasOwnProperty("meshDetectionState")&&this._currentPermissions.worldAccess?this._worldSensingState.meshDetectionState=e.meshDetectionState.enabled||!1:this._worldSensingState.meshDetectionState=!1,this._worldSensingState}getWorldInformation(){if(this._worldInformation)return this._worldInformation;let e={};return this._worldSensingState.meshDetectionState&&(e.meshes=[],this._anchors.forEach(t=>{!t.isMesh()||t.deleted||t.placeholder||e.meshes.push(t)})),this._worldInformation=e,e}}je.INIT_EVENT="arkit-init",je.WATCH_EVENT="arkit-watch",je.RECORD_START_EVENT="arkit-record-start",je.RECORD_STOP_EVENT="arkit-record-stop",je.DID_MOVE_BACKGROUND_EVENT="arkit-did-move-background",je.WILL_ENTER_FOREGROUND_EVENT="arkit-will-enter-foreground",je.INTERRUPTED_EVENT="arkit-interrupted",je.INTERRUPTION_ENDED_EVENT="arkit-interruption-ended",je.SHOW_DEBUG_EVENT="arkit-show-debug",je.WINDOW_RESIZE_EVENT="arkit-window-resize",je.ON_ERROR="on-error",je.AR_TRACKING_CHANGED="ar_tracking_changed",je.COMPUTER_VISION_DATA="cv_data",je.USER_GRANTED_COMPUTER_VISION_DATA="user-granted-cv-data",je.USER_GRANTED_WORLD_SENSING_DATA="user-granted-world-sensing-data",je.ORIENTATION_UP=1,je.ORIENTATION_UP_MIRRORED=2,je.ORIENTATION_DOWN=3,je.ORIENTATION_DOWN_MIRRORED=4,je.ORIENTATION_LEFT_MIRRORED=5,je.ORIENTATION_RIGHT=6,je.ORIENTATION_RIGHT_MIRRORED=7,je.ORIENTATION_LEFT=8,je.WEB_AR_WORLDMAPPING_NOT_AVAILABLE="ar_worldmapping_not_available",je.WEB_AR_WORLDMAPPING_LIMITED="ar_worldmapping_limited",je.WEB_AR_WORLDMAPPING_EXTENDING="ar_worldmapping_extending",je.WEB_AR_WORLDMAPPING_MAPPED="ar_worldmapping_mapped",je.HIT_TEST_TYPE_FEATURE_POINT=1,je.HIT_TEST_TYPE_ESTIMATED_HORIZONTAL_PLANE=2,je.HIT_TEST_TYPE_ESTIMATED_VERTICAL_PLANE=4,je.HIT_TEST_TYPE_EXISTING_PLANE=8,je.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT=16,je.HIT_TEST_TYPE_EXISTING_PLANE_USING_GEOMETRY=32,je.HIT_TEST_TYPE_ALL=je.HIT_TEST_TYPE_FEATURE_POINT|je.HIT_TEST_TYPE_EXISTING_PLANE|je.HIT_TEST_TYPE_ESTIMATED_HORIZONTAL_PLANE|je.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT,je.HIT_TEST_TYPE_EXISTING_PLANES=je.HIT_TEST_TYPE_EXISTING_PLANE|je.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT,je.ANCHOR_TYPE_PLANE="plane",je.ANCHOR_TYPE_FACE="face",je.ANCHOR_TYPE_ANCHOR="anchor",je.ANCHOR_TYPE_IMAGE="image";class He{constructor(e){this._subscribed=!1,this._arKitWrapper=e,this.subscribe()}subscribe(){this._subscribed||(this._subscribed=!0,this._arKitWrapper.addEventListener(je.INIT_EVENT,this.handleARKitInit.bind(this)),this._arKitWrapper.addEventListener(je.WATCH_EVENT,this.handleARKitUpdate.bind(this)),this._arKitWrapper.addEventListener(je.WINDOW_RESIZE_EVENT,this.handleARKitWindowResize.bind(this)),this._arKitWrapper.addEventListener(je.ON_ERROR,this.handleOnError.bind(this)),this._arKitWrapper.addEventListener(je.AR_TRACKING_CHANGED,this.handleArTrackingChanged.bind(this)),this._arKitWrapper.addEventListener(je.COMPUTER_VISION_DATA,this.handleComputerVisionData.bind(this)))}handleARKitInit(){}handleARKitUpdate(){}handleARKitWindowResize(){}handleOnError(){}handleArTrackingChanged(){}handleComputerVisionData(){}}class ze extends Be{constructor(e){super(e),this._throttledLogPose=qe(this.logPose,1e3),this._sessions=new Map,this._activeSession=null,this._frameSession=null,this._wrapperDiv=document.createElement("div"),this._wrapperDiv.setAttribute("class","arkit-device-wrapper");const t=()=>{document.body.insertBefore(this._wrapperDiv,document.body.firstChild||null)};document.body?t():document.addEventListener("DOMContentLoaded",t),this._headModelMatrix=ve(),this._headModelMatrixInverse=ve(),this._projectionMatrix=ve(),this._eyeLevelMatrix=Ee(ve()),this._stageMatrix=Ee(ve()),this._stageMatrix[13]=-1.3,this._identityMatrix=Ee(ve()),this._baseFrameSet=!1,this._frameOfRefRequestsWaiting=[],this._depthNear=.1,this._depthFar=1e3;try{this._arKitWrapper=je.GetOrCreate(),this._arWatcher=new $e(this._arKitWrapper,this)}catch(e){console.error("Error initializing the ARKit wrapper",e),this._arKitWrapper=null,this._arWatcher=null}}static initStyles(){const e=()=>{const e=document.createElement("style");document.head.appendChild(e);const t=e.sheet;t.insertRule(".arkit-device-wrapper { z-index: -1; }",0),t.insertRule(".arkit-device-wrapper, .xr-canvas { position: absolute; top: 0; left: 0; bottom: 0; right: 0; }",0),t.insertRule(".arkit-device-wrapper, .arkit-device-wrapper canvas { width: 100%; height: 100%; padding: 0; margin: 0; -webkit-user-select: none; user-select: none; }",0)};document.body?e():window.addEventListener("DOMContentLoaded",e)}logPose(){console.log("pose",Se(new Float32Array(3),this._headModelMatrix),Re(new Float32Array(4),this._headModelMatrix))}setProjectionMatrix(e){be(this._projectionMatrix,e)}setBaseViewMatrix(e){if(be(this._headModelMatrixInverse,e),function(e,t){let r=t[0],i=t[1],s=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],d=t[9],u=t[10],p=t[11],_=t[12],m=t[13],f=t[14],g=t[15],v=r*o-i*a,w=r*h-s*a,b=r*l-n*a,E=i*h-s*o,y=i*l-n*o,S=s*l-n*h,R=c*m-d*_,M=c*f-u*_,x=c*g-p*_,A=d*f-u*m,T=d*g-p*m,I=u*g-p*f,O=v*I-w*T+b*A+E*x-y*M+S*R;O&&(O=1/O,e[0]=(o*I-h*T+l*A)*O,e[1]=(s*T-i*I-n*A)*O,e[2]=(m*S-f*y+g*E)*O,e[3]=(u*y-d*S-p*E)*O,e[4]=(h*x-a*I-l*M)*O,e[5]=(r*I-s*x+n*M)*O,e[6]=(f*b-_*S-g*w)*O,e[7]=(c*S-u*b+p*w)*O,e[8]=(a*T-o*x+l*R)*O,e[9]=(i*x-r*T-n*R)*O,e[10]=(_*y-m*b+g*v)*O,e[11]=(d*b-c*y-p*v)*O,e[12]=(o*M-a*A-h*R)*O,e[13]=(r*A-i*M+s*R)*O,e[14]=(m*w-_*E-f*v)*O,e[15]=(c*E-d*w+u*v)*O)}(this._headModelMatrix,this._headModelMatrixInverse),!this._baseFrameSet){this._baseFrameSet=!0;for(let e=0;e<this._frameOfRefRequestsWaiting.length;e++){const t=this._frameOfRefRequestsWaiting[e];try{t()}catch(e){console.error("finalization of reference frame requests failed: ",e)}}this._frameOfRefRequestsWaiting.length=0}}get depthNear(){return this._depthNear}set depthNear(e){this._depthNear=e}get depthFar(){return this._depthFar}set depthFar(e){this._depthFar=e}isSessionSupported(e){return"immersive-ar"===e||"inline"===e}isFeatureSupported(e){switch(e){case"viewer":case"local":case"local-floor":return!0;case"bounded":case"unbounded":return!1;case"worldSensing":case"computerVision":case"alignEUS":return!0;default:return!1}}doesSessionSupportReferenceSpace(e,t){const r=this._sessions.get(e);if(r.ended)return!1;if(!r.enabledFeatures.has(t))return!1;switch(t){case"viewer":case"local":case"local-floor":return!0;case"bounded":case"unbounded":default:return!1}}async requestSession(e,t){if(!this.isSessionSupported(e))return console.error("Invalid session mode",e),Promise.reject();if("inline"===e){const r=new Ke(e,t);return this._sessions.set(r.id,r),Promise.resolve(r.id)}if(!this._arKitWrapper)return console.error("Session requested without an ARKitWrapper"),Promise.reject();if(null!==this._activeSession)return console.error("Tried to start a second active session"),Promise.reject();const r={};return t.has("worldSensing")&&(r.worldSensing=!0),t.has("computerVision")&&(r.videoFrames=!0),t.has("alignEUS")&&(r.alignEUS=!0),await this._arKitWrapper.waitForInit().then(()=>{}).catch((...e)=>(console.error("app failed to initialize: ",...e),Promise.reject())),await this._arKitWrapper.watch(r).then(r=>{const i=new Ke(e,t);return this._sessions.set(i.id,i),this._activeSession=i,Promise.resolve(i.id)}).catch((...e)=>(console.error("session request failed: ",...e),Promise.reject()))}onBaseLayerSet(e,t){const r=this._sessions.get(e),i=t.context.canvas;r.baseLayer=t,r.immersive&&(this._wrapperDiv.appendChild(i),i.style.width="100%",i.style.height="100%")}requestAnimationFrame(e,...t){return this._activeSession?this._arKitWrapper.requestAnimationFrame(e,t):window.requestAnimationFrame(e,t)}cancelAnimationFrame(e){return window.cancelAnimationFrame(e)}onFrameStart(e,t){const r=this._sessions.get(e);if(this._frameSession=r,!r.immersive&&r.baseLayer){const e=r.baseLayer.context.canvas;!function(e,t,r,i,s){let n,a=1/Math.tan(t/2);e[0]=a/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=s&&s!==1/0?(n=1/(i-s),e[10]=(s+i)*n,e[14]=2*s*i*n):(e[10]=-1,e[14]=-2*i)}(this._projectionMatrix,t.inlineVerticalFieldOfView,e.width/e.height,t.depthNear,t.depthFar)}}onFrameEnd(e){this._frameSession=null}requestFrameOfReferenceTransform(e,t){return new Promise((t,r)=>{const i=e=>{this._baseFrameSet?e():this._frameOfRefRequestsWaiting.push(e)};switch(e){case"viewer":return void i(()=>{t(this._headModelMatrix)});case"local":return void i(()=>{t(this._eyeLevelMatrix)});case"local-floor":case"bounded-floor":case"unbounded":return void r(new Error("not supported "+e));default:return void r(new Error("Unsupported frame of reference type "+e))}})}endSession(e){const t=this._sessions.get(e);t&&!t.ended&&(t.ended=!0,this._activeSession===t&&(this._activeSession=null,Ee(this._headModelMatrix),this._arKitWrapper.stop()),this._frameSession=null,null!==t.baseLayer&&this._wrapperDiv.removeChild(t.baseLayer.context.canvas))}getViewport(e,t,r,i){const{width:s,height:n}=r.context.canvas;return i.x=0,i.y=0,i.width=s,i.height=n,!0}getProjectionMatrix(e){return this._projectionMatrix}getBasePoseMatrix(){return this._frameSession.immersive?this._headModelMatrix:this._identityMatrix}getBaseViewMatrix(e){return this._frameSession.immersive?this._headModelMatrix:this._identityMatrix}requestStageBounds(){return null}getInputSources(){return[]}getInputPose(e,t){return null}onWindowResize(){this._sessions.forEach((e,t)=>{})}}let Ye=100;class Ke{constructor(e,t){this.mode=e,this.enabledFeatures=t,this.immersive="immersive-ar"==e,this.ended=null,this.baseLayer=null,this.id=++Ye}}class $e extends He{constructor(e,t){super(e),this._arKitDevice=t}handleARKitUpdate(e){this._arKitDevice.setBaseViewMatrix(this._arKitWrapper._cameraTransform),this._arKitDevice.setProjectionMatrix(this._arKitWrapper._projectionMatrix)}handleOnError(...e){console.error("ARKit error",...e)}}const Ze=ve(),Je=ve();me.prototype._patchNavigatorXR=function(){this.xr=new XR(Promise.resolve(new ze(this.global))),this.xr._mozillaXRViewer=!0,Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})};const Qe=navigator.userAgent.indexOf("Mobile/"),et=-1!==navigator.userAgent.indexOf("WebXRViewer")||(-1!==navigator.userAgent.indexOf("iPhone")||-1!==navigator.userAgent.indexOf("iPad"))&&-1!==Qe&&-1!==navigator.userAgent.indexOf("AppleWebKit")&&-1===navigator.userAgent.indexOf(" ",Qe)?new me(null,{webvr:!1,cardboard:!1}):null;let tt=null;const rt=()=>{void 0!==window.XRFrame&&(XRFrame.prototype.addAnchor=async function(e,t){if(!this.session[ie].immersive)return Promise.reject();const r=ve();return e instanceof Ne&&(ye(r,e._hit.anchor_transform,e._hit.local_transform),e=r),e instanceof Float32Array?new Promise((r,i)=>{let s=this.session[ie]._localSpace;be(Ze,this.getPose(s,t).transform.matrix);const n=ye(ve(),Ze,e);tt.createAnchor(n).then(r).catch((...e)=>{console.error("could not create anchor",...e),i()})}):Promise.reject("invalid value passed to addAnchor "+e)},Ae.prototype.detach=async function(){return new Promise((e,t)=>{tt.removeAnchor(this),e()})})},it=()=>{if(void 0===window.XRSession)return;ne.prototype._original_XRSession_rAF=ne.prototype.requestAnimationFrame;let e=[];ne.prototype.requestAnimationFrame=function(t){this._original_XRSession_rAF((r,i)=>{for(const t of e)t(r,i);e.length=0,t(r,i)})},ne.prototype.requestHitTest=function(t,r,i){return this[ie].immersive?new Promise((i,s)=>{const n=((e,t)=>{const r=function(e,t,r){let i=t[0],s=t[1],n=t[2],a=r[3]*i+r[7]*s+r[11]*n+r[15];return a=a||1,e[0]=(r[0]*i+r[4]*s+r[8]*n+r[12])/a,e[1]=(r[1]*i+r[5]*s+r[9]*n+r[13])/a,e[2]=(r[2]*i+r[6]*s+r[10]*n+r[14])/a,e}(Me(),e,t);return[(r[0]+1)/2,(1-r[1])/2]})(t,tt._projectionMatrix);tt.hitTest(...n,je.HIT_TEST_TYPE_EXISTING_PLANE_USING_GEOMETRY).then(t=>{0===t.length&&i([]);let s=this[ie]._localSpace,n=tt._timestamp;e.push((e,a)=>{be(Ze,a.getPose(r,s).transform.matrix),i(t.map(e=>(ye(Je,Ze,e.world_transform),new Ne(Je,e,n))))})}).catch((...e)=>{console.error("Error testing for hits",...e),s()})}):Promise.reject()}},st=()=>{void 0!==window.XRFrame&&void 0!==window.XRSession&&(Object.defineProperty(XRFrame.prototype,"worldInformation",{get:function(){if(!this.session[ie].immersive)throw new Error("Not implemented");return tt.getWorldInformation()}}),ne.prototype.updateWorldSensingState=function(e){if(!this[ie].immersive)throw new Error("Not implemented");return tt.updateWorldSensingState(e)})},nt=()=>{void 0!==window.XRFrame&&(XRFrame.prototype.getGlobalLightEstimate=function(){if(!this.session[ie].immersive)throw new Error("Not implemented");return tt.getLightProbe()},XRFrame.prototype.getGlobalReflectionProbe=function(){throw new Error("Not implemented")})},at=()=>{void 0!==window.XRSession&&(ne.prototype.nonStandard_setNumberOfTrackedImages=function(e){if(!this[ie].immersive)throw new Error("Not implemented");return tt.setNumberOfTrackedImages(e)},ne.prototype.nonStandard_createDetectionImage=function(e,t,r,i,s){if(!this[ie].immersive)throw new Error("Not implemented");return tt.createDetectionImage(e,t,r,i,s)},ne.prototype.nonStandard_destroyDetectionImage=function(e){if(!this[ie].immersive)throw new Error("Not implemented");return tt.createDetectionImage(e)},ne.prototype.nonStandard_activateDetectionImage=function(e){if(!this[ie].immersive)throw new Error("Not implemented");return tt.activateDetectionImage(e)},ne.prototype.nonStandard_deactivateDetectionImage=function(e){if(!this[ie].immersive)throw new Error("Not implemented");return tt.deactivateDetectionImage(e)},ne.prototype.nonStandard_getWorldMap=function(){if(!this[ie].immersive)throw new Error("Not implemented");return tt.getWorldMap()},ne.prototype.nonStandard_setWorldMap=function(e){if(!this[ie].immersive)throw new Error("Not implemented");return tt.setWorldMap(e)},ne.prototype.nonStandard_getWorldMappingStatus=function(){if(!this[ie].immersive)throw new Error("Not implemented");return tt._worldMappingStatus})};if(et&&et.injected&&navigator.xr){tt=je.GetOrCreate(),ze.initStyles(),window.XR&&(XR.prototype._isSessionSupported=XR.prototype.isSessionSupported,XR.prototype._requestSession=XR.prototype.requestSession,XR.prototype.isSessionSupported=function(e){return"immersive-ar"!==e&&"inline"!==e?Promise.resolve(!1):this._isSessionSupported(e)},XR.prototype.requestSession=async function(e,t){if("immersive-ar"!==e&&"inline"!==e)throw new DOMException("Polyfill Error: only immersive-ar or inline mode is supported.");let r=await this._requestSession(e,t);return"immersive-ar"===e&&(r[ie]._localSpace=await r.requestReferenceSpace("local")),r}),rt(),it(),st(),nt(),at();for(const e of Object.keys(Ue))void 0!==window[e]?console.warn(`${e} already defined on global.`):window[e]=Ue[e]}});
