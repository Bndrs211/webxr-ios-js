!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t():"function"==typeof define&&define.amd?define(t):t()}(0,function(){"use strict";const e="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},t=Symbol("@@webxr-polyfill/EventTarget");class r{constructor(){this[t]={listeners:new Map}}addEventListener(e,r){if("string"!=typeof e)throw new Error("`type` must be a string");if("function"!=typeof r)throw new Error("`listener` must be a function");const i=this[t].listeners.get(e)||[];i.push(r),this[t].listeners.set(e,i)}removeEventListener(e,r){if("string"!=typeof e)throw new Error("`type` must be a string");if("function"!=typeof r)throw new Error("`listener` must be a function");const i=this[t].listeners.get(e)||[];for(let e=i.length;e>=0;e--)i[e]===r&&i.pop()}dispatchEvent(e,r){const i=this[t].listeners.get(e)||[],s=[];for(let e=0;e<i.length;e++)s[e]=i[e];for(let e of s)e(r);"function"==typeof this[`on${e}`]&&this[`on${e}`](r)}}const i=1e-6;let s="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function n(){let e=new s(16);return s!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function a(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function o(e,t){let r=t[0],i=t[1],s=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],d=t[9],u=t[10],p=t[11],m=t[12],f=t[13],_=t[14],g=t[15],v=r*o-i*a,w=r*h-s*a,b=r*l-n*a,y=i*h-s*o,E=i*l-n*o,x=s*l-n*h,S=c*f-d*m,R=c*_-u*m,M=c*g-p*m,A=d*_-u*f,T=d*g-p*f,I=u*g-p*_,P=v*I-w*T+b*A+y*M-E*R+x*S;return P?(P=1/P,e[0]=(o*I-h*T+l*A)*P,e[1]=(s*T-i*I-n*A)*P,e[2]=(f*x-_*E+g*y)*P,e[3]=(u*E-d*x-p*y)*P,e[4]=(h*M-a*I-l*R)*P,e[5]=(r*I-s*M+n*R)*P,e[6]=(_*b-m*x-g*w)*P,e[7]=(c*x-u*b+p*w)*P,e[8]=(a*T-o*M+l*S)*P,e[9]=(i*M-r*T-n*S)*P,e[10]=(m*E-f*b+g*v)*P,e[11]=(d*b-c*E-p*v)*P,e[12]=(o*R-a*A-h*S)*P,e[13]=(r*A-i*R+s*S)*P,e[14]=(f*w-m*y-_*v)*P,e[15]=(c*y-d*w+u*v)*P,e):null}function h(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],d=t[8],u=t[9],p=t[10],m=t[11],f=t[12],_=t[13],g=t[14],v=t[15],w=r[0],b=r[1],y=r[2],E=r[3];return e[0]=w*i+b*o+y*d+E*f,e[1]=w*s+b*h+y*u+E*_,e[2]=w*n+b*l+y*p+E*g,e[3]=w*a+b*c+y*m+E*v,w=r[4],b=r[5],y=r[6],E=r[7],e[4]=w*i+b*o+y*d+E*f,e[5]=w*s+b*h+y*u+E*_,e[6]=w*n+b*l+y*p+E*g,e[7]=w*a+b*c+y*m+E*v,w=r[8],b=r[9],y=r[10],E=r[11],e[8]=w*i+b*o+y*d+E*f,e[9]=w*s+b*h+y*u+E*_,e[10]=w*n+b*l+y*p+E*g,e[11]=w*a+b*c+y*m+E*v,w=r[12],b=r[13],y=r[14],E=r[15],e[12]=w*i+b*o+y*d+E*f,e[13]=w*s+b*h+y*u+E*_,e[14]=w*n+b*l+y*p+E*g,e[15]=w*a+b*c+y*m+E*v,e}function l(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3],o=i+i,h=s+s,l=n+n,c=i*o,d=i*h,u=i*l,p=s*h,m=s*l,f=n*l,_=a*o,g=a*h,v=a*l;return e[0]=1-(p+f),e[1]=d+v,e[2]=u-g,e[3]=0,e[4]=d-v,e[5]=1-(c+f),e[6]=m+_,e[7]=0,e[8]=u+g,e[9]=m-_,e[10]=1-(c+p),e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}function c(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function d(e,t){let r=t[0]+t[5]+t[10],i=0;return r>0?(i=2*Math.sqrt(r+1),e[3]=.25*i,e[0]=(t[6]-t[9])/i,e[1]=(t[8]-t[2])/i,e[2]=(t[1]-t[4])/i):t[0]>t[5]&&t[0]>t[10]?(i=2*Math.sqrt(1+t[0]-t[5]-t[10]),e[3]=(t[6]-t[9])/i,e[0]=.25*i,e[1]=(t[1]+t[4])/i,e[2]=(t[8]+t[2])/i):t[5]>t[10]?(i=2*Math.sqrt(1+t[5]-t[0]-t[10]),e[3]=(t[8]-t[2])/i,e[0]=(t[1]+t[4])/i,e[1]=.25*i,e[2]=(t[6]+t[9])/i):(i=2*Math.sqrt(1+t[10]-t[0]-t[5]),e[3]=(t[1]-t[4])/i,e[0]=(t[8]+t[2])/i,e[1]=(t[6]+t[9])/i,e[2]=.25*i),e}function u(){let e=new s(3);return s!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function p(e){var t=new s(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function m(e,t,r){let i=new s(3);return i[0]=e,i[1]=t,i[2]=r,i}function f(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function _(e,t,r){return e[0]=t[0]+r[0],e[1]=t[1]+r[1],e[2]=t[2]+r[2],e}function g(e,t,r){return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function v(e,t){let r=t[0],i=t[1],s=t[2],n=r*r+i*i+s*s;return n>0&&(n=1/Math.sqrt(n),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n),e}function w(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function b(e,t,r){let i=t[0],s=t[1],n=t[2],a=r[0],o=r[1],h=r[2];return e[0]=s*h-n*o,e[1]=n*a-i*h,e[2]=i*o-s*a,e}function y(e,t,r){let i=r[0],s=r[1],n=r[2],a=r[3],o=t[0],h=t[1],l=t[2],c=s*l-n*h,d=n*o-i*l,u=i*h-s*o,p=s*u-n*d,m=n*c-i*u,f=i*d-s*c,_=2*a;return c*=_,d*=_,u*=_,p*=2,m*=2,f*=2,e[0]=o+c+p,e[1]=h+d+m,e[2]=l+u+f,e}const E=function(e){let t=e[0],r=e[1],i=e[2];return Math.sqrt(t*t+r*r+i*i)};!function(){let e=u()}();!function(){let e=function(){let e=new s(4);return s!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}()}();function x(){let e=new s(4);return s!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e[3]=1,e}function S(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3],o=r[0],h=r[1],l=r[2],c=r[3];return e[0]=i*c+a*o+s*l-n*h,e[1]=s*c+a*h+n*o-i*l,e[2]=n*c+a*l+i*h-s*o,e[3]=a*c-i*o-s*h-n*l,e}function R(e,t,r,s){let n,a,o,h,l,c=t[0],d=t[1],u=t[2],p=t[3],m=r[0],f=r[1],_=r[2],g=r[3];return(a=c*m+d*f+u*_+p*g)<0&&(a=-a,m=-m,f=-f,_=-_,g=-g),1-a>i?(n=Math.acos(a),o=Math.sin(n),h=Math.sin((1-s)*n)/o,l=Math.sin(s*n)/o):(h=1-s,l=s),e[0]=h*c+l*m,e[1]=h*d+l*f,e[2]=h*u+l*_,e[3]=h*p+l*g,e}function M(e,t){let r=t[0],i=t[1],s=t[2],n=t[3],a=r*r+i*i+s*s+n*n,o=a?1/a:0;return e[0]=-r*o,e[1]=-i*o,e[2]=-s*o,e[3]=n*o,e}const A=function(e){let t=new s(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t},T=function(e,t,r,i){let n=new s(4);return n[0]=e,n[1]=t,n[2]=r,n[3]=i,n},I=function(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e},P=function(e,t){let r=t[0],i=t[1],s=t[2],n=t[3],a=r*r+i*i+s*s+n*n;return a>0&&(a=1/Math.sqrt(a),e[0]=r*a,e[1]=i*a,e[2]=s*a,e[3]=n*a),e},O=(function(){let e=u(),t=m(1,0,0),r=m(0,1,0)}(),function(){let e=x(),t=x()}(),function(){let e=function(){let e=new s(9);return s!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[5]=0,e[6]=0,e[7]=0),e[0]=1,e[4]=1,e[8]=1,e}()}(),Symbol("@@webxr-polyfill/XRRigidTransform"));class C{constructor(){if(this[O]={matrix:null,position:null,orientation:null,inverse:null},0===arguments.length)this[O].matrix=a(new Float32Array(16));else if(1===arguments.length)arguments[0]instanceof Float32Array?this[O].matrix=arguments[0]:(this[O].position=this._getPoint(arguments[0]),this[O].orientation=DOMPointReadOnly.fromPoint({x:0,y:0,z:0,w:1}));else{if(2!==arguments.length)throw new Error("Too many arguments!");this[O].position=this._getPoint(arguments[0]),this[O].orientation=this._getPoint(arguments[1])}if(this[O].matrix){let e=u();c(e,this[O].matrix),this[O].position=DOMPointReadOnly.fromPoint({x:e[0],y:e[1],z:e[2]});let t=x();d(t,this[O].matrix),this[O].orientation=DOMPointReadOnly.fromPoint({x:t[0],y:t[1],z:t[2],w:t[3]})}else this[O].matrix=a(new Float32Array(16)),l(this[O].matrix,T(this[O].orientation.x,this[O].orientation.y,this[O].orientation.z,this[O].orientation.w),m(this[O].position.x,this[O].position.y,this[O].position.z))}_getPoint(e){return e instanceof DOMPointReadOnly?e:DOMPointReadOnly.fromPoint(e)}get matrix(){return this[O].matrix}get position(){return this[O].position}get orientation(){return this[O].orientation}get inverse(){if(null===this[O].inverse){let e=a(new Float32Array(16));o(e,this[O].matrix),this[O].inverse=new C(e),this[O].inverse[O].inverse=this}return this[O].inverse}}const F=Symbol("@@webxr-polyfill/XRSpace");class N{constructor(e=null,t=null){this[F]={specialType:e,inputSource:t,baseMatrix:null,inverseBaseMatrix:null,lastFrameId:-1}}get _specialType(){return this[F].specialType}get _inputSource(){return this[F].inputSource}_ensurePoseUpdated(e,t){t!=this[F].lastFrameId&&(this[F].lastFrameId=t,this._onPoseUpdate(e))}_onPoseUpdate(e){"viewer"==this[F].specialType&&(this._baseMatrix=e.getBasePoseMatrix())}set _baseMatrix(e){this[F].baseMatrix=e,this[F].inverseBaseMatrix=null}get _baseMatrix(){return this[F].baseMatrix||this[F].inverseBaseMatrix&&(this[F].baseMatrix=new Float32Array(16),o(this[F].baseMatrix,this[F].inverseBaseMatrix)),this[F].baseMatrix}set _inverseBaseMatrix(e){this[F].inverseBaseMatrix=e,this[F].baseMatrix=null}get _inverseBaseMatrix(){return this[F].inverseBaseMatrix||this[F].baseMatrix&&(this[F].inverseBaseMatrix=new Float32Array(16),o(this[F].inverseBaseMatrix,this[F].baseMatrix)),this[F].inverseBaseMatrix}_getSpaceRelativeTransform(e){if(!this._inverseBaseMatrix||!e._baseMatrix)return null;let t=new Float32Array(16);return h(t,this._inverseBaseMatrix,e._baseMatrix),new C(t)}}const D=1.6,L=Symbol("@@webxr-polyfill/XRReferenceSpace"),V=["viewer","local","local-floor","bounded-floor","unbounded"];class k extends N{constructor(e,t=null){if(!V.includes(e))throw new Error(`XRReferenceSpaceType must be one of ${V}`);if(super(e),"bounded-floor"===e&&!t)throw new Error("XRReferenceSpace cannot use 'bounded-floor' type if the platform does not provide the floor level");(function(e){return"bounded-floor"===e||"local-floor"===e})(e)&&!t&&((t=a(new Float32Array(16)))[13]=D),this._inverseBaseMatrix=t||a(new Float32Array(16)),this[L]={type:e,transform:t,originOffset:a(new Float32Array(16))}}_transformBasePoseMatrix(e,t){h(e,this._inverseBaseMatrix,t)}_originOffsetMatrix(){return this[L].originOffset}_adjustForOriginOffset(e){let t=new Float32Array(16);o(t,this[L].originOffset),h(e,t,e)}_getSpaceRelativeTransform(e){let t=super._getSpaceRelativeTransform(e);return this._adjustForOriginOffset(t.matrix),new XRRigidTransform(t.matrix)}getOffsetReferenceSpace(e){let t=new k(this[L].type,this[L].transform,this[L].bounds);return h(t[L].originOffset,this[L].originOffset,e.matrix),t}}const X=Symbol("@@webxr-polyfill/XR"),G=["inline","immersive-vr","immersive-ar"],W={inline:{requiredFeatures:["viewer"],optionalFeatures:[]},"immersive-vr":{requiredFeatures:["viewer","local"],optionalFeatures:[]},"immersive-ar":{requiredFeatures:["viewer","local"],optionalFeatures:[]}},B="Polyfill Error: Must call navigator.xr.isSessionSupported() with any XRSessionMode\nor navigator.xr.requestSession('inline') prior to requesting an immersive\nsession. This is a limitation specific to the WebXR Polyfill and does not apply\nto native implementations of the API.";let U;if("performance"in e==!1){let e=Date.now();U=(()=>Date.now()-e)}else U=(()=>performance.now());var H=U;const q=Symbol("@@webxr-polyfill/XRPose");class j{constructor(e,t){this[q]={transform:e,emulatedPosition:t}}get transform(){return this[q].transform}get emulatedPosition(){return this[q].emulatedPosition}}const z=Symbol("@@webxr-polyfill/XRViewerPose");class Y extends j{constructor(e,t,r=!1){super(e,r),this[z]={views:t}}get views(){return this[z].views}}const K=Symbol("@@webxr-polyfill/XRViewport");class Q{constructor(e){this[K]={target:e}}get x(){return this[K].target.x}get y(){return this[K].target.y}get width(){return this[K].target.width}get height(){return this[K].target.height}}const $=["left","right","none"],Z=Symbol("@@webxr-polyfill/XRView");class J{constructor(e,t,r,i){if(!$.includes(r))throw new Error(`XREye must be one of: ${$}`);const s=Object.create(null),n=new Q(s);this[Z]={device:e,eye:r,viewport:n,temp:s,sessionId:i,transform:t}}get eye(){return this[Z].eye}get projectionMatrix(){return this[Z].device.getProjectionMatrix(this.eye)}get transform(){return this[Z].transform}_getViewport(e){if(this[Z].device.getViewport(this[Z].sessionId,this.eye,e,this[Z].temp))return this[Z].viewport}}const ee=Symbol("@@webxr-polyfill/XRFrame"),te="XRFrame access outside the callback that produced it is invalid.",re="getViewerPose can only be called on XRFrame objects passed to XRSession.requestAnimationFrame callbacks.";let ie=0;class se{constructor(e,t,r){this[ee]={id:++ie,active:!1,animationFrame:!1,device:e,session:t,sessionId:r}}get session(){return this[ee].session}getViewerPose(e){if(!this[ee].animationFrame)throw new DOMException(re,"InvalidStateError");if(!this[ee].active)throw new DOMException(te,"InvalidStateError");const t=this[ee].device,r=this[ee].session;r[ve].viewerSpace._ensurePoseUpdated(t,this[ee].id),e._ensurePoseUpdated(t,this[ee].id);let i=e._getSpaceRelativeTransform(r[ve].viewerSpace);const s=[];for(let i of r[ve].viewSpaces){i._ensurePoseUpdated(t,this[ee].id);let r=e._getSpaceRelativeTransform(i),n=new J(t,r,i.eye,this[ee].sessionId);s.push(n)}return new Y(i,s,!1)}getPose(e,t){if(!this[ee].active)throw new DOMException(te,"InvalidStateError");const r=this[ee].device;if("target-ray"===e._specialType||"grip"===e._specialType)return r.getInputPose(e._inputSource,t,e._specialType);{e._ensurePoseUpdated(r,this[ee].id),t._ensurePoseUpdated(r,this[ee].id);let i=t._getSpaceRelativeTransform(e);return i?new XRPose(i,!1):null}}}const ne=Symbol("@@webxr-polyfill/XRRenderState"),ae=Object.freeze({depthNear:.1,depthFar:1e3,inlineVerticalFieldOfView:null,baseLayer:null});class oe{constructor(e={}){const t=Object.assign({},ae,e);this[ne]={config:t}}get depthNear(){return this[ne].config.depthNear}get depthFar(){return this[ne].config.depthFar}get inlineVerticalFieldOfView(){return this[ne].config.inlineVerticalFieldOfView}get baseLayer(){return this[ne].config.baseLayer}}const he=Symbol("@@webxr-polyfill/polyfilled-xr-compatible"),le=Symbol("@@webxr-polyfill/xr-compatible"),ce=Symbol("@@webxr-polyfill/XRWebGLLayer"),de=Object.freeze({antialias:!0,depth:!1,stencil:!1,alpha:!0,multiview:!1,ignoreDepthValues:!1,framebufferScaleFactor:1});const ue=Symbol("@@webxr-polyfill/XRInputSourceEvent");class pe extends Event{constructor(e,t){super(e,t),this[ue]={frame:t.frame,inputSource:t.inputSource},Object.setPrototypeOf(this,pe.prototype)}get frame(){return this[ue].frame}get inputSource(){return this[ue].inputSource}}const me=Symbol("@@webxr-polyfill/XRSessionEvent");class fe extends Event{constructor(e,t){super(e,t),this[me]={session:t.session},Object.setPrototypeOf(this,fe.prototype)}get session(){return this[me].session}}const _e=Symbol("@@webxr-polyfill/XRInputSourcesChangeEvent");class ge extends Event{constructor(e,t){super(e,t),this[_e]={session:t.session,added:t.added,removed:t.removed},Object.setPrototypeOf(this,ge.prototype)}get session(){return this[_e].session}get added(){return this[_e].added}get removed(){return this[_e].removed}}const ve=Symbol("@@webxr-polyfill/XRSession");class we extends N{constructor(e){super(e)}get eye(){return this._specialType}_onPoseUpdate(e){this._inverseBaseMatrix=e.getBaseViewMatrix(this._specialType)}}class be extends r{constructor(e,t,r){super();let i="inline"!=t,s=new oe({inlineVerticalFieldOfView:i?null:.5*Math.PI});this[ve]={device:e,mode:t,immersive:i,ended:!1,suspended:!1,frameCallbacks:[],currentFrameCallbacks:null,frameHandle:0,deviceFrameHandle:null,id:r,activeRenderState:s,pendingRenderState:null,viewerSpace:new k("viewer"),viewSpaces:[],currentInputSources:[]},i?this[ve].viewSpaces.push(new we("left"),new we("right")):this[ve].viewSpaces.push(new we("none")),this[ve].onDeviceFrame=(()=>{if(this[ve].ended||this[ve].suspended)return;if(this[ve].deviceFrameHandle=null,this[ve].startDeviceFrameLoop(),null!==this[ve].pendingRenderState&&(this[ve].activeRenderState=new oe(this[ve].pendingRenderState),this[ve].pendingRenderState=null,this[ve].activeRenderState.baseLayer&&this[ve].device.onBaseLayerSet(this[ve].id,this[ve].activeRenderState.baseLayer)),null===this[ve].activeRenderState.baseLayer)return;const t=new se(e,this,this[ve].id),r=this[ve].currentFrameCallbacks=this[ve].frameCallbacks;this[ve].frameCallbacks=[],t[ee].active=!0,t[ee].animationFrame=!0,this[ve].device.onFrameStart(this[ve].id,this[ve].activeRenderState),this._checkInputSourcesChange();const i=H();for(let e=0;e<r.length;e++)try{r[e].cancelled||"function"!=typeof r[e].callback||r[e].callback(i,t)}catch(e){console.error(e)}this[ve].currentFrameCallbacks=null,t[ee].active=!1,this[ve].device.onFrameEnd(this[ve].id)}),this[ve].startDeviceFrameLoop=(()=>{null===this[ve].deviceFrameHandle&&(this[ve].deviceFrameHandle=this[ve].device.requestAnimationFrame(this[ve].onDeviceFrame))}),this[ve].stopDeviceFrameLoop=(()=>{const e=this[ve].deviceFrameHandle;null!==e&&(this[ve].device.cancelAnimationFrame(e),this[ve].deviceFrameHandle=null)}),this[ve].onPresentationEnd=(t=>{if(t!==this[ve].id)return this[ve].suspended=!1,this[ve].startDeviceFrameLoop(),void this.dispatchEvent("focus",{session:this});this[ve].ended=!0,this[ve].stopDeviceFrameLoop(),e.removeEventListener("@webvr-polyfill/vr-present-end",this[ve].onPresentationEnd),e.removeEventListener("@webvr-polyfill/vr-present-start",this[ve].onPresentationStart),e.removeEventListener("@@webvr-polyfill/input-select-start",this[ve].onSelectStart),e.removeEventListener("@@webvr-polyfill/input-select-end",this[ve].onSelectEnd),this.dispatchEvent("end",new fe("end",{session:this}))}),e.addEventListener("@@webxr-polyfill/vr-present-end",this[ve].onPresentationEnd),this[ve].onPresentationStart=(e=>{e!==this[ve].id&&(this[ve].suspended=!0,this[ve].stopDeviceFrameLoop(),this.dispatchEvent("blur",{session:this}))}),e.addEventListener("@@webxr-polyfill/vr-present-start",this[ve].onPresentationStart),this[ve].onSelectStart=(e=>{e.sessionId===this[ve].id&&this[ve].dispatchInputSourceEvent("selectstart",e.inputSource)}),e.addEventListener("@@webxr-polyfill/input-select-start",this[ve].onSelectStart),this[ve].onSelectEnd=(e=>{e.sessionId===this[ve].id&&(this[ve].dispatchInputSourceEvent("selectend",e.inputSource),this[ve].dispatchInputSourceEvent("select",e.inputSource))}),e.addEventListener("@@webxr-polyfill/input-select-end",this[ve].onSelectEnd),this[ve].onSqueezeStart=(e=>{e.sessionId===this[ve].id&&this[ve].dispatchInputSourceEvent("squeezestart",e.inputSource)}),e.addEventListener("@@webxr-polyfill/input-squeeze-start",this[ve].onSqueezeStart),this[ve].onSqueezeEnd=(e=>{e.sessionId===this[ve].id&&(this[ve].dispatchInputSourceEvent("squeezeend",e.inputSource),this[ve].dispatchInputSourceEvent("squeeze",e.inputSource))}),e.addEventListener("@@webxr-polyfill/input-squeeze-end",this[ve].onSqueezeEnd),this[ve].dispatchInputSourceEvent=((t,r)=>{const i=new se(e,this,this[ve].id),s=new pe(t,{frame:i,inputSource:r});i[ee].active=!0,this.dispatchEvent(t,s),i[ee].active=!1}),this[ve].startDeviceFrameLoop(),this.onblur=void 0,this.onfocus=void 0,this.onresetpose=void 0,this.onend=void 0,this.onselect=void 0,this.onselectstart=void 0,this.onselectend=void 0}get renderState(){return this[ve].activeRenderState}get environmentBlendMode(){return this[ve].device.environmentBlendMode||"opaque"}async requestReferenceSpace(e){if(this[ve].ended)return;if(!V.includes(e))throw new TypeError(`XRReferenceSpaceType must be one of ${V}`);if(!this[ve].device.doesSessionSupportReferenceSpace(this[ve].id,e))throw new DOMException(`The ${e} reference space is not supported by this session.`,"NotSupportedError");if("viewer"===e)return this[ve].viewerSpace;let t=await this[ve].device.requestFrameOfReferenceTransform(e);if("bounded-floor"===e){if(!t)throw new DOMException(`${e} XRReferenceSpace not supported by this device.`,"NotSupportedError");if(!this[ve].device.requestStageBounds())throw new DOMException(`${e} XRReferenceSpace not supported by this device.`,"NotSupportedError");throw new DOMException(`The WebXR polyfill does not support the ${e} reference space yet.`,"NotSupportedError")}return new k(e,t)}requestAnimationFrame(e){if(this[ve].ended)return;const t=++this[ve].frameHandle;return this[ve].frameCallbacks.push({handle:t,callback:e,cancelled:!1}),t}cancelAnimationFrame(e){let t=this[ve].frameCallbacks,r=t.findIndex(t=>t&&t.handle===e);r>-1&&(t[r].cancelled=!0,t.splice(r,1)),(t=this[ve].currentFrameCallbacks)&&(r=t.findIndex(t=>t&&t.handle===e))>-1&&(t[r].cancelled=!0)}get inputSources(){return this[ve].device.getInputSources()}async end(){if(!this[ve].ended)return this[ve].immersive&&(this[ve].ended=!0,this[ve].device.removeEventListener("@@webvr-polyfill/vr-present-start",this[ve].onPresentationStart),this[ve].device.removeEventListener("@@webvr-polyfill/vr-present-end",this[ve].onPresentationEnd),this[ve].device.removeEventListener("@@webvr-polyfill/input-select-start",this[ve].onSelectStart),this[ve].device.removeEventListener("@@webvr-polyfill/input-select-end",this[ve].onSelectEnd),this.dispatchEvent("end",new fe("end",{session:this}))),this[ve].stopDeviceFrameLoop(),this[ve].device.endSession(this[ve].id)}updateRenderState(e){if(this[ve].ended){throw new Error("Can't call updateRenderState on an XRSession that has already ended.")}if(e.baseLayer&&e.baseLayer._session!==this){throw new Error("Called updateRenderState with a base layer that was created by a different session.")}if(null!==e.inlineVerticalFieldOfView&&void 0!==e.inlineVerticalFieldOfView){if(this[ve].immersive){throw new Error("inlineVerticalFieldOfView must not be set for an XRRenderState passed to updateRenderState for an immersive session.")}e.inlineVerticalFieldOfView=Math.min(3.13,Math.max(.01,e.inlineVerticalFieldOfView))}if(null===this[ve].pendingRenderState){const e=this[ve].activeRenderState;this[ve].pendingRenderState={depthNear:e.depthNear,depthFar:e.depthFar,inlineVerticalFieldOfView:e.inlineVerticalFieldOfView,baseLayer:e.baseLayer}}Object.assign(this[ve].pendingRenderState,e)}_checkInputSourcesChange(){const e=[],t=[],r=this.inputSources,i=this[ve].currentInputSources;for(const t of r)i.includes(t)||e.push(t);for(const e of i)r.includes(e)||t.push(e);(e.length>0||t.length>0)&&this.dispatchEvent("inputsourceschange",new ge("inputsourceschange",{session:this,added:e,removed:t})),this[ve].currentInputSources.length=0;for(const e of r)this[ve].currentInputSources.push(e)}}const ye=Symbol("@@webxr-polyfill/XRInputSource");class Ee{constructor(e){this[ye]={impl:e,gripSpace:new N("grip",this),targetRaySpace:new N("target-ray",this)}}get handedness(){return this[ye].impl.handedness}get targetRayMode(){return this[ye].impl.targetRayMode}get gripSpace(){let e=this[ye].impl.targetRayMode;return"gaze"===e||"screen"===e?null:this[ye].gripSpace}get targetRaySpace(){return this[ye].targetRaySpace}get profiles(){return this[ye].impl.profiles}get gamepad(){return this[ye].impl.gamepad}}const xe=Symbol("@@webxr-polyfill/XRReferenceSpaceEvent");class Se extends Event{constructor(e,t){super(e,t),this[xe]={referenceSpace:t.referenceSpace,transform:t.transform||null},Object.setPrototypeOf(this,Se.prototype)}get referenceSpace(){return this[xe].referenceSpace}get transform(){return this[xe].transform}}var Re={XR:class extends r{constructor(e){super(),this[X]={device:null,devicePromise:e,immersiveSession:null,inlineSessions:new Set},e.then(e=>{this[X].device=e})}async isSessionSupported(e){return this[X].device||await this[X].devicePromise,"inline"!=e?Promise.resolve(this[X].device.isSessionSupported(e)):Promise.resolve(!0)}async requestSession(e,t){if(!this[X].device){if("inline"!=e)throw new Error(B);await this[X].devicePromise}if(!G.includes(e))throw new TypeError(`The provided value '${e}' is not a valid enum value of type XRSessionMode`);const r=W[e],i=r.requiredFeatures.concat(t&&t.requiredFeatures?t.requiredFeatures:[]),s=r.optionalFeatures.concat(t&&t.optionalFeatures?t.optionalFeatures:[]),n=new Set;let a=!1;for(let e of i)this[X].device.isFeatureSupported(e)?n.add(e):(console.error(`The required feature '${e}' is not supported`),a=!0);if(a)throw new DOMException("Session does not support some required features","NotSupportedError");for(let e of s)this[X].device.isFeatureSupported(e)?n.add(e):console.log(`The optional feature '${e}' is not supported`);const o=await this[X].device.requestSession(e,n),h=new XRSession(this[X].device,e,o);"inline"==e?this[X].inlineSessions.add(h):this[X].immersiveSession=h;const l=()=>{"inline"==e?this[X].inlineSessions.delete(h):this[X].immersiveSession=null,h.removeEventListener("end",l)};return h.addEventListener("end",l),h}},XRSession:be,XRSessionEvent:fe,XRFrame:se,XRView:J,XRViewport:Q,XRViewerPose:Y,XRWebGLLayer:class{constructor(e,t,r={}){const i=Object.assign({},de,r);if(!(e instanceof be))throw new Error("session must be a XRSession");if(e.ended)throw new Error("InvalidStateError");if(t[he]&&!0!==t[le])throw new Error("InvalidStateError");const s=t.getParameter(t.FRAMEBUFFER_BINDING);this[ce]={context:t,config:i,framebuffer:s,session:e}}get context(){return this[ce].context}get antialias(){return this[ce].config.antialias}get ignoreDepthValues(){return!0}get framebuffer(){return this[ce].framebuffer}get framebufferWidth(){return this[ce].context.drawingBufferWidth}get framebufferHeight(){return this[ce].context.drawingBufferHeight}get _session(){return this[ce].session}getViewport(e){return e._getViewport(this)}static getNativeFramebufferScaleFactor(e){if(!e)throw new TypeError("getNativeFramebufferScaleFactor must be passed a session.");return e[ve].ended?0:1}},XRSpace:N,XRReferenceSpace:k,XRReferenceSpaceEvent:Se,XRInputSource:Ee,XRInputSourceEvent:pe,XRInputSourcesChangeEvent:ge,XRRenderState:oe,XRRigidTransform:C,XRPose:j};const Me=e=>"function"!=typeof e.prototype.makeXRCompatible&&(e.prototype.makeXRCompatible=function(){return this[le]=!0,Promise.resolve()},!0),Ae=e=>{const t=e.prototype.getContext;e.prototype.getContext=function(e,r){const i=t.call(this,e,r);return i&&(i[he]=!0,r&&"xrCompatible"in r&&(i[le]=r.xrCompatible)),i}},Te=async function(e,t){},Ie={global:e,webvr:!0,cardboard:!0,cardboardConfig:null,allowCardboardOnDesktop:!1},Pe=["navigator","HTMLCanvasElement","WebGLRenderingContext"];class Oe{constructor(e={}){this.config=Object.freeze(Object.assign({},Ie,e)),this.global=this.config.global,this.nativeWebXR="xr"in this.global.navigator,this.injected=!1,this.nativeWebXR?this._injectCompatibilityShims(this.global):this._injectPolyfill(this.global)}_injectPolyfill(e){if(!Pe.every(t=>!!e[t]))throw new Error(`Global must have the following attributes : ${Pe}`);for(const t of Object.keys(Re))void 0!==e[t]?console.warn(`${t} already defined on global.`):e[t]=Re[t];Me(e.WebGLRenderingContext)&&(Ae(e.HTMLCanvasElement),e.OffscreenCanvas&&Ae(e.OffscreenCanvas),e.WebGL2RenderingContext&&Me(e.WebGL2RenderingContext));this.injected=!0,this._patchNavigatorXR()}_patchNavigatorXR(){let e=Te(this.global,this.config);this.xr=new Re.XR(e),Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})}_injectCompatibilityShims(e){if(!Pe.every(t=>!!e[t]))throw new Error(`Global must have the following attributes : ${Pe}`);if(e.navigator.xr&&"supportsSession"in e.navigator.xr&&!("isSessionSupported"in e.navigator.xr)){let t=e.navigator.xr.supportsSession;e.navigator.xr.isSessionSupported=function(e){return t.call(this,e).then(()=>!0).catch(()=>!1)},e.navigator.xr.supportsSession=function(e){return console.warn("navigator.xr.supportsSession() is deprecated. Please call navigator.xr.isSessionSupported() instead and check the boolean value returned when the promise resolves."),t.call(this,e)}}}}const Ce=1e-6;let Fe="undefined"!=typeof Float32Array?Float32Array:Array;Math.PI;function Ne(){let e=new Fe(16);return Fe!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function De(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Le(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function Ve(e,t){let r=t[0],i=t[1],s=t[2],n=t[3],a=t[4],o=t[5],h=t[6],l=t[7],c=t[8],d=t[9],u=t[10],p=t[11],m=t[12],f=t[13],_=t[14],g=t[15],v=r*o-i*a,w=r*h-s*a,b=r*l-n*a,y=i*h-s*o,E=i*l-n*o,x=s*l-n*h,S=c*f-d*m,R=c*_-u*m,M=c*g-p*m,A=d*_-u*f,T=d*g-p*f,I=u*g-p*_,P=v*I-w*T+b*A+y*M-E*R+x*S;return P?(P=1/P,e[0]=(o*I-h*T+l*A)*P,e[1]=(s*T-i*I-n*A)*P,e[2]=(f*x-_*E+g*y)*P,e[3]=(u*E-d*x-p*y)*P,e[4]=(h*M-a*I-l*R)*P,e[5]=(r*I-s*M+n*R)*P,e[6]=(_*b-m*x-g*w)*P,e[7]=(c*x-u*b+p*w)*P,e[8]=(a*T-o*M+l*S)*P,e[9]=(i*M-r*T-n*S)*P,e[10]=(m*E-f*b+g*v)*P,e[11]=(d*b-c*E-p*v)*P,e[12]=(o*R-a*A-h*S)*P,e[13]=(r*A-i*R+s*S)*P,e[14]=(f*w-m*y-_*v)*P,e[15]=(c*y-d*w+u*v)*P,e):null}function ke(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3],o=t[4],h=t[5],l=t[6],c=t[7],d=t[8],u=t[9],p=t[10],m=t[11],f=t[12],_=t[13],g=t[14],v=t[15],w=r[0],b=r[1],y=r[2],E=r[3];return e[0]=w*i+b*o+y*d+E*f,e[1]=w*s+b*h+y*u+E*_,e[2]=w*n+b*l+y*p+E*g,e[3]=w*a+b*c+y*m+E*v,w=r[4],b=r[5],y=r[6],E=r[7],e[4]=w*i+b*o+y*d+E*f,e[5]=w*s+b*h+y*u+E*_,e[6]=w*n+b*l+y*p+E*g,e[7]=w*a+b*c+y*m+E*v,w=r[8],b=r[9],y=r[10],E=r[11],e[8]=w*i+b*o+y*d+E*f,e[9]=w*s+b*h+y*u+E*_,e[10]=w*n+b*l+y*p+E*g,e[11]=w*a+b*c+y*m+E*v,w=r[12],b=r[13],y=r[14],E=r[15],e[12]=w*i+b*o+y*d+E*f,e[13]=w*s+b*h+y*u+E*_,e[14]=w*n+b*l+y*p+E*g,e[15]=w*a+b*c+y*m+E*v,e}function Xe(e,t,r){let i=Math.sin(r),s=Math.cos(r),n=t[4],a=t[5],o=t[6],h=t[7],l=t[8],c=t[9],d=t[10],u=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=n*s+l*i,e[5]=a*s+c*i,e[6]=o*s+d*i,e[7]=h*s+u*i,e[8]=l*s-n*i,e[9]=c*s-a*i,e[10]=d*s-o*i,e[11]=u*s-h*i,e}function Ge(e,t,r){let i=Math.sin(r),s=Math.cos(r),n=t[0],a=t[1],o=t[2],h=t[3],l=t[8],c=t[9],d=t[10],u=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*s-l*i,e[1]=a*s-c*i,e[2]=o*s-d*i,e[3]=h*s-u*i,e[8]=n*i+l*s,e[9]=a*i+c*s,e[10]=o*i+d*s,e[11]=h*i+u*s,e}function We(e,t,r){let i,s,n,a=r[0],o=r[1],h=r[2],l=Math.sqrt(a*a+o*o+h*h);return l<Ce?null:(a*=l=1/l,o*=l,h*=l,i=Math.sin(t),n=1-(s=Math.cos(t)),e[0]=a*a*n+s,e[1]=o*a*n+h*i,e[2]=h*a*n-o*i,e[3]=0,e[4]=a*o*n-h*i,e[5]=o*o*n+s,e[6]=h*o*n+a*i,e[7]=0,e[8]=a*h*n+o*i,e[9]=o*h*n-a*i,e[10]=h*h*n+s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)}function Be(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3],o=i+i,h=s+s,l=n+n,c=i*o,d=i*h,u=i*l,p=s*h,m=s*l,f=n*l,_=a*o,g=a*h,v=a*l;return e[0]=1-(p+f),e[1]=d+v,e[2]=u-g,e[3]=0,e[4]=d-v,e[5]=1-(c+f),e[6]=m+_,e[7]=0,e[8]=u+g,e[9]=m-_,e[10]=1-(c+p),e[11]=0,e[12]=r[0],e[13]=r[1],e[14]=r[2],e[15]=1,e}function Ue(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function He(e,t){let r=t[0]+t[5]+t[10],i=0;return r>0?(i=2*Math.sqrt(r+1),e[3]=.25*i,e[0]=(t[6]-t[9])/i,e[1]=(t[8]-t[2])/i,e[2]=(t[1]-t[4])/i):t[0]>t[5]&&t[0]>t[10]?(i=2*Math.sqrt(1+t[0]-t[5]-t[10]),e[3]=(t[6]-t[9])/i,e[0]=.25*i,e[1]=(t[1]+t[4])/i,e[2]=(t[8]+t[2])/i):t[5]>t[10]?(i=2*Math.sqrt(1+t[5]-t[0]-t[10]),e[3]=(t[8]-t[2])/i,e[0]=(t[1]+t[4])/i,e[1]=.25*i,e[2]=(t[6]+t[9])/i):(i=2*Math.sqrt(1+t[10]-t[0]-t[5]),e[3]=(t[1]-t[4])/i,e[0]=(t[8]+t[2])/i,e[1]=(t[6]+t[9])/i,e[2]=.25*i),e}function qe(){let e=new Fe(3);return Fe!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function je(e,t,r,i){return e[0]=t,e[1]=r,e[2]=i,e}function ze(e,t,r){let i=t[0],s=t[1],n=t[2],a=r[3]*i+r[7]*s+r[11]*n+r[15];return a=a||1,e[0]=(r[0]*i+r[4]*s+r[8]*n+r[12])/a,e[1]=(r[1]*i+r[5]*s+r[9]*n+r[13])/a,e[2]=(r[2]*i+r[6]*s+r[10]*n+r[14])/a,e}function Ye(e,t){let r=e[0],i=e[1],s=e[2],n=t[0],a=t[1],o=t[2];return Math.abs(r-n)<=Ce*Math.max(1,Math.abs(r),Math.abs(n))&&Math.abs(i-a)<=Ce*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(s-o)<=Ce*Math.max(1,Math.abs(s),Math.abs(o))}!function(){let e=qe()}();class Ke extends r{constructor(e,t=null,r=0){super(),this._uid=t||Ke._generateUID(),this._transform=function(e){let t=new Fe(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}(e),this._timestamp=r,this._poseChanged=!0,this._deleted=!1,this._placeholder=!1}get deleted(){return this._deleted}set deleted(e){this._deleted=e}get placeholder(){return this._placeholder}set placeholder(e){this._placeholder=e}isMesh(){return!1}get timeStamp(){return this._timestamp}get changed(){return this._poseChanged}clearChanged(){this._poseChanged=!1}get modelMatrix(){return this._transform}updateModelMatrix(e,t){if(this._timestamp=t,!this._deleted&&!function(e,t){let r=e[0],i=e[1],s=e[2],n=e[3],a=e[4],o=e[5],h=e[6],l=e[7],c=e[8],d=e[9],u=e[10],p=e[11],m=e[12],f=e[13],_=e[14],g=e[15],v=t[0],w=t[1],b=t[2],y=t[3],E=t[4],x=t[5],S=t[6],R=t[7],M=t[8],A=t[9],T=t[10],I=t[11],P=t[12],O=t[13],C=t[14],F=t[15];return Math.abs(r-v)<=Ce*Math.max(1,Math.abs(r),Math.abs(v))&&Math.abs(i-w)<=Ce*Math.max(1,Math.abs(i),Math.abs(w))&&Math.abs(s-b)<=Ce*Math.max(1,Math.abs(s),Math.abs(b))&&Math.abs(n-y)<=Ce*Math.max(1,Math.abs(n),Math.abs(y))&&Math.abs(a-E)<=Ce*Math.max(1,Math.abs(a),Math.abs(E))&&Math.abs(o-x)<=Ce*Math.max(1,Math.abs(o),Math.abs(x))&&Math.abs(h-S)<=Ce*Math.max(1,Math.abs(h),Math.abs(S))&&Math.abs(l-R)<=Ce*Math.max(1,Math.abs(l),Math.abs(R))&&Math.abs(c-M)<=Ce*Math.max(1,Math.abs(c),Math.abs(M))&&Math.abs(d-A)<=Ce*Math.max(1,Math.abs(d),Math.abs(A))&&Math.abs(u-T)<=Ce*Math.max(1,Math.abs(u),Math.abs(T))&&Math.abs(p-I)<=Ce*Math.max(1,Math.abs(p),Math.abs(I))&&Math.abs(m-P)<=Ce*Math.max(1,Math.abs(m),Math.abs(P))&&Math.abs(f-O)<=Ce*Math.max(1,Math.abs(f),Math.abs(O))&&Math.abs(_-C)<=Ce*Math.max(1,Math.abs(_),Math.abs(C))&&Math.abs(g-F)<=Ce*Math.max(1,Math.abs(g),Math.abs(F))}(this._transform,e)){this._poseChanged=!0;for(var r=0;r<16;r++)this._transform[r]=e[r];try{this.dispatchEvent("update",{source:this})}catch(e){console.error("XRAnchor update event error",e)}}}notifyOfRemoval(){try{this.dispatchEvent("remove",{source:this})}catch(e){console.error("XRAnchor removed event error",e)}}get position(){return Ue(new Float32Array(3),this._poseMatrix)}get orientation(){return He(new Float32Array(4),this._poseMatrix)}get uid(){return this._uid}static _generateUID(){return"anchor-"+(new Date).getTime()+"-"+Math.floor(Math.random()*Number.MAX_SAFE_INTEGER)}}class Qe extends Ke{constructor(e,t=null){super(t,null),this._anchor=e,this._timestamp=e.timeStamp,this._tempArray=new Float32Array(16),this._offsetMatrix=Ne(),t&&De(this._offsetMatrix,t),ke(this._transform,e.modelMatrix,this._offsetMatrix),this._handleAnchorUpdateListener=this._handleAnchorUpdate.bind(this),this._notifyOfRemovalListener=this.notifyOfRemoval.bind(this),this._handleReplaceAnchorListener=this._handleReplaceAnchor.bind(this),e.addEventListener("update",this._handleAnchorUpdateListener),e.addEventListener("removal",this._notifyOfRemovalListener),e.addEventListener("replaceAnchor",this._handleReplaceAnchorListener)}_handleReplaceAnchor(e){this._anchor.removeEventListener("update",this._handleAnchorUpdateListener),this._anchor.removeEventListener("removal",this._notifyOfRemovalListener),this._anchor.removeEventListener("replaceAnchor",this._handleReplaceAnchorListener),this._anchor=e,this._anchor.addEventListener("update",this._handleAnchorUpdateListener),this._anchor.addEventListener("removal",this._notifyOfRemovalListener),this._anchor.addEventListener("replaceAnchor",this._handleReplaceAnchorListener)}_handleAnchorUpdate(){ke(this._tempArray,this._anchor.modelMatrix,this._offsetMatrix),this.updateModelMatrix(this._tempArray,Math.max(this._anchor.timeStamp,this._timestamp))}get modelMatrix(){return this._transform}clearChanged(){super.clearChanged()}get anchor(){return this._anchor}get offsetMatrix(){return this._offsetMatrix}set offsetMatrix(e){De(this._offsetMatrix,e),this._handleAnchorUpdate()}}var $e=!1;class Ze extends Ke{static setUseGeomArrays(){$e=!0}static useGeomArrays(){return $e}constructor(e,t,r=null,i=0){super(e,r,i),this._useGeomArrays=$e,this._vertexCountChanged=!0,this._vertexPositionsChanged=!0,this._triangleIndicesChanged=!0,this._textureCoordinatesChanged=!0,this._vertexPositions=[],this._triangleIndices=[],this._textureCoordinates=[],this._vertexNormalsChanged=!0,this._vertexNormals=[],t&&(this._geometry=t,this._updateGeometry(this._geometry))}isMesh(){return!0}get changed(){return super.changed||this._vertexPositionsChanged||this._vertexNormalsChanged||this._triangleIndicesChanged||this._vertexCountChanged}clearChanged(){super.clearChanged(),this._vertexPositionsChanged=!1,this._vertexNormalsChanged=!1,this._triangleIndicesChanged=!1,this._vertexCountChanged=!1}get vertexCountChanged(){return this._vertexCountChanged}get vertexPositionsChanged(){return this._vertexPositionsChanged}get triangleIndicesChanged(){this._triangleIndicesChanged}get textureCoordinatesChanged(){this._textureCoordinatesChanged}get vertexNormalsChanged(){this._vertexNormalsChanged}get vertexPositions(){return this._vertexPositions}get vertexNormals(){return this._vertexNormals}get triangleIndices(){return this._triangleIndices}get textureCoordinates(){return this._textureCoordinates}get vertexCount(){return this._vertexPositions.length}get triangleCount(){return this._triangleIndices.length}get hasNormals(){return this._vertexNormals.length>0}get hasTextureCoordinates(){return this._textureCoordinates.length>0}_updateGeometry(e){this._geometry=e;let t=e;if(0==t.vertexCount)return void(this._vertexPositions.length>0&&(this._vertexPositionsChanged=!0,this._vertexNormalsChanged=!0,this._triangleIndicesChanged=!0,this._textureCoordinatesChanged=!0,this._vertexPositions=[],this._vertexNormals=[],this.triangleIndices=[],this._textureCoordinates=[]));if(void 0===t.vertexCount)return void console.warn("bad geometry data passed to XRMesh._updateGeometry: no vertex count",t);let r=0;if(this._vertexPositions.length!=3*t.vertexCount){if(void 0===t.vertices)return void console.warn("bad geometry data passed to XRMesh._updateGeometry: no vertices",t);this._vertexCountChanged=!0,this._vertexPositionsChanged=!0,this._vertexPositions=new Float32Array(3*t.vertexCount),t.textureCoordinates&&(this._textureCoordinatesChanged=!0,this._textureCoordinates=new Float32Array(2*t.vertexCount))}else if(this._useGeomArrays)this._vertexPositionsChanged=void 0!==t.vertices&&!Ze.arrayFuzzyEquals(this._vertexPositions,t.vertices),this._textureCoordinatesChanged=void 0!==t.textureCoordinates&&!Ze.arrayFuzzyEquals(this._textureCoordinates,t.textureCoordinates);else{if(this._vertexPositionsChanged=!1,t.vertices){r=0;for(var i=0,s=t.vertexCount;i<s;i++)if(Math.abs(this._vertexPositions[r++]-t.vertices[i].x)>Ce||Math.abs(this._vertexPositions[r++]-t.vertices[i].y)>Ce||Math.abs(this._vertexPositions[r++]-t.vertices[i].z)>Ce){this._vertexPositionsChanged=!0;break}}if(this._textureCoordinatesChanged=!1,t.textureCoordinates){r=0;for(i=0,s=t.vertexCount;i<s;i++)if(Math.abs(this._textureCoordinates[r++]-t.textureCoordinates[i].x)>Ce||Math.abs(this._textureCoordinates[r++]-t.textureCoordinates[i].x)>Ce){this._textureCoordinatesChanged=!0;break}}}if(t.triangleCount?this._triangleIndices.length!=3*t.triangleCount?(this._triangleIndicesChanged=!0,this._triangleIndices=(Ze.arrayMax(t.triangleIndices),new Uint32Array(3*t.triangleCount))):this._triangleIndicesChanged=t.triangleIndicies&&!Ze.arrayEquals(this._triangleIndices,t.triangleIndices):this._triangleIndicesChanged=!1,this._vertexPositionsChanged)if(this._useGeomArrays)this._vertexPositions.set(t.vertices);else{r=0;for(let e of t.vertices)this._vertexPositions[r++]=e.x,this._vertexPositions[r++]=e.y,this._vertexPositions[r++]=e.z}if(this._textureCoordinatesChanged)if(r=0,this._useGeomArrays)this._textureCoordinates.set(t.textureCoordinates);else for(let e of t.textureCoordinates)this._textureCoordinates[r++]=e.x,this._textureCoordinates[r++]=e.y;this._triangleIndicesChanged&&this._triangleIndices.set(t.triangleIndices)}static arrayMax(e){if(0===e.length)return-1/0;for(var t=e[0],r=1,i=e.length;r<i;++r)e[r]>t&&(t=e[r]);return t}static arrayEquals(e,t){if(!e||!t)return!1;if(e.length!=t.length)return!1;for(var r=0,i=e.length;r<i;r++)if(e[r]!=t[r])return!1;return!0}static arrayFuzzyEquals(e,t){if(!e||!t)return!1;if(e.length!=t.length)return!1;for(var r=0,i=e.length;r<i;r++)if(Math.abs(e[r]-t[r])>Ce)return!1;return!0}}class Je extends Ze{constructor(e,t,r,i=null,s=0){super(e,t,i,s),this._blendShapes={},this._blendShapesChanged=!0,this._updateBlendShapes(r)}get changed(){return super.changed||this._blendShapesChanged}clearChanged(){super.clearChanged(),this._blendShapesChanged=!1}_updateBlendShapes(e){for(let i=0;i<et.length;i++){let s=et[i];var t=this._blendShapes[s],r=e[i];Math.abs(t-r)>Ce&&(this._blendShapesChanged=!0,this._blendShapes[s]=r)}}updateFaceData(e,t,r,i){super.updateModelMatrix(e,i),void 0===t.vertexCount&&(t.vertexCount=t.vertices.length/(Ze.useGeomArrays()?3:1)),this._updateGeometry(t),this._updateBlendShapes(r)}get blendShapes(){return this._blendShapes}}const et=["browDownLeft","browDownRight","browInnerUp","browOuterUpLeft","browOuterUpRight","cheekPuff","cheekSquintLeft","cheekSquintRight","eyeBlinkLeft","eyeBlinkRight","eyeLookDownLeft","eyeLookDownRight","eyeLookInLeft","eyeLookInRight","eyeLookOutLeft","eyeLookOutRight","eyeLookUpLeft","eyeLookUpRight","eyeSquintLeft","eyeSquintRight","eyeWideLeft","eyeWideRight","jawForward","jawLeft","jawOpen","jawRight","mouthClose","mouthDimpleLeft","mouthDimpleRight","mouthFrownLeft","mouthFrownRight","mouthFunnel","mouthLeft","mouthLowerDownLeft","mouthLowerDownRight","mouthPressLeft","mouthPressRight","mouthPucker","mouthRight","mouthRollLower","mouthRollUpper","mouthShrugLower","mouthShrugUpper","mouthSmileLeft","mouthSmileRight","mouthStretchLeft","mouthStretchRight","mouthUpperUpLeft","mouthUpperUpRight","noseSneerLeft","noseSneerRight"],tt=Symbol("@@webxr-polyfill/XRHitTestResult");class rt{constructor(e,t){this[tt]={frame:e,transform:t}}getPose(e){const t=new N;return t._baseMatrix=De(Ne(),this[tt].transform.matrix),this[tt].frame.getPose(t,e)}get _frame(){return this[tt].frame}}function it(){let e=new Fe(4);return Fe!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function st(e,t,r,i,s){return e[0]=t,e[1]=r,e[2]=i,e[3]=s,e}function nt(e,t,r){let i=t[0],s=t[1],n=t[2],a=t[3];return e[0]=r[0]*i+r[4]*s+r[8]*n+r[12]*a,e[1]=r[1]*i+r[5]*s+r[9]*n+r[13]*a,e[2]=r[2]*i+r[6]*s+r[10]*n+r[14]*a,e[3]=r[3]*i+r[7]*s+r[11]*n+r[15]*a,e}!function(){let e=it()}();const at=Symbol("@@webxr-polyfill/XRRay");class ot{constructor(e,t){const r={x:0,y:0,z:0,w:1},i={x:0,y:0,z:-1,w:0};if(e&&e instanceof C){const t=e.matrix,s=st(it(),r.x,r.y,r.z,r.w),n=st(it(),i.x,i.y,i.z,i.w);nt(s,s,t),nt(n,n,t),r.x=s[0],r.y=s[1],r.z=s[2],r.w=s[3],_directionVec4.x=n[0],_directionVec4.y=n[1],_directionVec4.z=n[2],_directionVec4.w=n[3]}else e&&(r.x=e.x,r.y=e.y,r.z=e.z,r.w=e.w),t&&(i.x=t.x,i.y=t.y,i.z=t.z,i.w=t.w);const s=Math.sqrt(i.x*i.x+i.y*i.y+i.z*i.z)||1;i.x=i.x/s,i.y=i.y/s,i.z=i.z/s,this[at]={origin:new DOMPointReadOnly(r.x,r.y,r.z,r.w),direction:new DOMPointReadOnly(i.x,i.y,i.z,i.w),matrix:null}}get origin(){return this[at].origin}get direction(){return this[at].direction}get matrix(){if(this[at].matrix)return this[at].matrix;const e=je(qe(),0,0,-1),t=je(qe(),this[at].origin.x,this[at].origin.y,this[at].origin.z),r=je(qe(),this[at].direction.x,this[at].direction.y,this[at].direction.z),i=function(e,t,r){let i=t[0],s=t[1],n=t[2],a=r[0],o=r[1],h=r[2];return e[0]=s*h-n*o,e[1]=n*a-i*h,e[2]=i*o-s*a,e}(qe(),r,e),s=(a=e,(n=r)[0]*a[0]+n[1]*a[1]+n[2]*a[2]);var n,a;const o=Ne();s>-1&&s<1?We(o,Math.acos(s),i):-1===s&&We(o,Math.acos(s),je(qe(),1,0,0));const h=(l=Ne(),c=t,l[0]=1,l[1]=0,l[2]=0,l[3]=0,l[4]=0,l[5]=1,l[6]=0,l[7]=0,l[8]=0,l[9]=0,l[10]=1,l[11]=0,l[12]=c[0],l[13]=c[1],l[14]=c[2],l[15]=1,l);var l,c;const d=ke(Ne(),h,o);return this[at].matrix=d,d}}const ht=Symbol("@@webxr-polyfill/XRHitTestSource");class lt{constructor(e,t){if(!t.space)throw new Error("XRHitTestSource requires space.");if("viewer"!==t.space._specialType)throw new Error("XRHitTestSource supports only viewer space for now.");if(t.entityTypes)for(const e of t.entityTypes)if("plane"!==e)throw new Error("XRHitTestSource does not support entityType"+e+" yet.");if(t.offsetRay&&(0!==t.offsetRay.origin.x||0!==t.offsetRay.origin.y||0!==t.offsetRay.origin.z||1!==t.offsetRay.origin.w))throw new Error("XRHitTestSource supports offsetRay.origin yet.");this[ht]={session:e,space:t.space,offsetRay:t.offsetRay||new ot,active:!0}}cancel(){this[ht].active=!1}get _space(){return this[ht].space}get _session(){return this[ht].session}get _offsetRay(){return this[ht].offsetRay}get _active(){return this[ht].active}}class ct extends Ke{}const dt=Symbol("@@webxr-polyfill/XRLightProbe");class ut{constructor(e={}){this[dt]={indirectIrradiance:e.indirectIrradiance}}get indirectIrradiance(){return this[dt].indirectIrradiance}get primaryLightDirection(){throw new Error("Not implemented")}get primaryLightIntensity(){throw new Error("Not implemented")}get sphericalHarmonicsCoefficients(){throw new Error("Not implemented")}get sphericalHarmonicsOrientation(){throw new Error("Not implemented")}}class pt extends Ze{constructor(e,t,r,i,s,n=null,a=0){super(e,null,n,a),this._center=t,this._extent=r,this._alignment=i,this._planeFeatureChanged=!0,this._yAxis=function(e,t,r,i){let s=new Fe(4);return s[0]=e,s[1]=t,s[2]=r,s[3]=i,s}(0,1,0,0),this._normal=it(),this._boundaryVerticesChanged=!0,this._boundaryVertices=[],this._geometry=s,this._updateGeometry(this._geometry)}get changed(){return super.changed||this._planeFeatureChanged}clearChanged(){super.clearChanged(),this._planeFeatureChanged=!1}updatePlaneData(e,t,r,i,s,n){super.updateModelMatrix(e,n),Ye(this._center,t)&&Ye(this._extent,r)&&!this._alignment||(this._center=t,this._extent=r,this._alignment=i,this._planeFeatureChanged=!0),this._updateGeometry(s)}get center(){return this._center}get extent(){return this._extent}get alignment(){return this._alignment}get boundaryVertices(){return this._boundaryVertices}get boundaryVerticesChanged(){return this._boundaryVerticesChanged}get boundaryVertexCount(){return this._boundaryVertices.length}_updateGeometry(e){super._updateGeometry(e);let t=e;const r=nt(this._normal,this._yAxis,this._transform),i=r[0],s=r[1],n=r[2];let a=0;if(this._boundaryVertices.length!=3*t.boundaryVertexCount)this._boundaryVerticesChanged=!0,this._boundaryVertices=new Float32Array(3*t.vertexCount),this._vertexNormalsChanged=!0,this._vertexNormals=new Float32Array(3*t.vertexCount);else if(this._vertexNormalsChanged=Math.abs(this._vertexNormals[0]-i)>Ce||Math.abs(this._vertexNormals[1]-s)>Ce||Math.abs(this._vertexNormals[2]-n)>Ce,this._useGeomArrays)this._vertexPositionsChanged=!Ze.arrayFuzzyEquals(this._boundaryVertices,t.boundaryVertices);else{this._boundaryVerticesChanged=!1,a=0;for(var o=0,h=t.vertexCount;o<h;o++)if(Math.abs(this._boundaryVertices[a++]-t.boundaryVertices[o].x)>Ce||Math.abs(this._boundaryVertices[a++]-t.boundaryVertices[o].y)>Ce||Math.abs(this._boundaryVertices[a++]-t.boundaryVertices[o].z)>Ce){this._boundaryVerticesChanged=!0;break}}if(this._boundaryVerticesChanged)if(this._useGeomArrays)this._boundaryVertices.set(t.boundaryVertices);else{a=0;for(let e of t.boundaryVertices)this._boundaryVertices[a++]=e.x,this._boundaryVertices[a++]=e.y,this._boundaryVertices[a++]=e.z}if(this._vertexNormalsChanged){a=0;for(o=0;o<t.vertexCount;o++)this._vertexNormals[a++]=i,this._vertexNormals[a++]=s,this._vertexNormals[a++]=n}}}class mt{static decodeLength(e){return e.length/4*3}static decodeArrayBuffer(e,t){var r=e.length/4*3;return t&&t.byteLength==r||(t=new ArrayBuffer(r)),this.decode(e,t),t}static removePaddingChars(e){return 64==this._keyStr.indexOf(e.charAt(e.length-1))?e.substring(0,e.length-1):e}static decode(e,t){e=this.removePaddingChars(e),e=this.removePaddingChars(e);var r,i,s,n,a,o,h,l=parseInt(e.length/4*3,10),c=0,d=0;for(r=t?new Uint8Array(t):new Uint8Array(l),e=e.replace(/[^A-Za-z0-9\+\/\=]/g,""),c=0;c<l;c+=3)i=this._keyStr.indexOf(e.charAt(d++))<<2|(a=this._keyStr.indexOf(e.charAt(d++)))>>4,s=(15&a)<<4|(o=this._keyStr.indexOf(e.charAt(d++)))>>2,n=(3&o)<<6|(h=this._keyStr.indexOf(e.charAt(d++))),r[c]=i,64!=o&&(r[c+1]=s),64!=h&&(r[c+2]=n);return r}static encode(e){var t="",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=e;e instanceof ArrayBuffer?i=new Uint8Array(arrayBuffer):e instanceof ImageData&&(i=e.data);for(var s,n=e.length,a=n%3,o=n-a,h=0;h<o;h+=3)t+=r[(16515072&(s=i[h]<<16|i[h+1]<<8|i[h+2]))>>18]+r[(258048&s)>>12]+r[(4032&s)>>6]+r[63&s];return 1==a?t+=r[(252&(s=i[o]))>>2]+r[(3&s)<<4]+"==":2==a&&(t+=r[(64512&(s=i[o]<<8|i[o+1]))>>10]+r[(1008&s)>>4]+r[(15&s)<<2]+"="),t}}mt._keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";var ft=[];class _t{constructor(e,t,r,i){this._buffers=e;for(var s=0;s<e.length;s++)if(e[s]._buffer=e[s].buffer,e[s].buffer=null,e[s]._abCache||"string"!=typeof e[s]._buffer){if(!e[s]._abCache&&e[s]._buffer instanceof ImageData){var n=e[s]._buffer.data;for(l=n.length,c=0;c<ft.length;c++)if(ft[c].byteLength==l){e[s]._abCache=ft[c],ft.splice(c,1);break}var a=e[s]._abCache?e[s]._abCache:new ArrayBuffer(l);e[s]._abCache=null;for(var o=new Uint8Array(a),h=0;h<l;h++)o[h]=n[h];e[s]._buffer=a}}else for(var l=mt.decodeLength(e[s]._buffer),c=0;c<ft.length;c++)if(ft[c].byteLength==l){e[s]._abCache=ft[c],ft.splice(c,1);break}this._pixelFormat=t,this._timestamp=r,this._camera=i}static createFromMessage(e){return new this(e.data.buffers,e.data.pixelFormat,e.data.timestamp,e.data.camera)}numBuffers(){this._buffers.length}buffer(e){if(e>=0&&e<this._buffers.length){var t=this._buffers[e];return t.buffer||("string"==typeof t._buffer?(t._buffer=mt.decodeArrayBuffer(t._buffer,t._abCache),t._abCache=null,t.buffer=new Uint8Array(t._buffer)):t._buffer instanceof ArrayBuffer?t.buffer=new Uint8Array(t._buffer):t._buffer instanceof ImageData&&(t.buffer=ImageData.data)),t}return null}get pixelFormat(){return this._pixelFormat}get timestamp(){return this._timestamp}get camera(){return this._camera}release(){for(var e=this._buffers,t=0;t<e.length;t++)e[t]._buffer instanceof ArrayBuffer&&e[t]._buffer.byteLength>0&&ft.push(e[t]._buffer),e[t]._abCache instanceof ArrayBuffer&&e[t]._abCache.byteLength>0&&ft.push(e[t]._abCache)}postMessageToWorker(e,t){var r=Object.assign({},t||{});r.buffers=this._buffers,r.timestamp=this._timestamp,r.pixelFormat=this._pixelFormat,r.camera=this._camera;for(var i=[],s=0;s<r.buffers.length;s++)r.buffers[s].buffer=r.buffers[s]._buffer,(r.buffers[s]._buffer instanceof ArrayBuffer||r.buffers[s]._buffer instanceof ImageData)&&i.push(r.buffers[s]._buffer),r.buffers[s]._buffer=null,r.buffers[s]._abCache instanceof ArrayBuffer&&i.push(r.buffers[s]._abCache);e.postMessage(r,i)}postReplyMessage(e){var t=Object.assign({},e);t.buffers=this._buffers,t.timestamp=this._timestamp,t.pixelFormat=this._pixelFormat,t.camera=this._camera;for(var r=[],i=0;i<t.buffers.length;i++)t.buffers[i].buffer=null,(t.buffers[i]._buffer instanceof ArrayBuffer||t.buffers[i]._buffer instanceof ImageData)&&(r.push(t.buffers[i]._buffer),t.buffers[i].buffer=t.buffers[i]._buffer),t.buffers[i]._buffer=null,t.buffers[i]._abCache instanceof ArrayBuffer&&r.push(t.buffers[i]._abCache);postMessage(t,r)}}_t.IMAGEFORMAT_RGBA32="RGBA32",_t.IMAGEFORMAT_BGRA32="BGRA32",_t.IMAGEFORMAT_RGB24="RGB24",_t.IMAGEFORMAT_BGR24="BGR24",_t.IMAGEFORMAT_GRAY8="GRAY8",_t.IMAGEFORMAT_YUV444P="YUV444P",_t.IMAGEFORMAT_YUV422P="YUV422P",_t.IMAGEFORMAT_YUV420P="YUV420P",_t.IMAGEFORMAT_YUV420SP_NV12="YUV420SP_NV12",_t.IMAGEFORMAT_YUV420SP_NV21="YUV420SP_NV21",_t.IMAGEFORMAT_HSV="HSV",_t.IMAGEFORMAT_Lab="Lab",_t.IMAGEFORMAT_DEPTH="DEPTH",_t.IMAGEFORMAT_NULL="",_t.IMAGEFORMAT=[_t.IMAGEFORMAT_RGBA32,_t.IMAGEFORMAT_BGRA32,_t.IMAGEFORMAT_RGB24,_t.IMAGEFORMAT_BGR24,_t.IMAGEFORMAT_GRAY8,_t.IMAGEFORMAT_YUV444P,_t.IMAGEFORMAT_YUV422P,_t.IMAGEFORMAT_YUV420P,_t.IMAGEFORMAT_YUV420SP_NV12,_t.IMAGEFORMAT_YUV420SP_NV21,_t.IMAGEFORMAT_HSV,_t.IMAGEFORMAT_Lab,_t.IMAGEFORMAT_DEPTH,_t.IMAGEFORMAT_NULL];var gt={XRAnchor:Ke,XRAnchorOffset:Qe,XRFaceMesh:Je,XRHitTestResult:rt,XRHitTestSource:lt,XRTransientInputHitTestResult:class{constructor(){throw new Error("XRTransientInputHitTestResult is not supported yet.")}getPose(e){}},XRTransientInputHitTestSource:class{constructor(e){throw new Error("XRTransientInputHitTestSource is not supported yet.")}cancel(){}},XRImageAnchor:ct,XRLightProbe:ut,XRMesh:Ze,XRPlaneMesh:pt,XRRay:ot,XRVideoFrame:_t};class vt extends r{constructor(e){super(),this.global=e,this.onWindowResize=this.onWindowResize.bind(this),this.global.window.addEventListener("resize",this.onWindowResize),this.environmentBlendMode="opaque"}onBaseLayerSet(e,t){throw new Error("Not implemented")}isSessionSupported(e){throw new Error("Not implemented")}isFeatureSupported(e){throw new Error("Not implemented")}async requestSession(e,t){throw new Error("Not implemented")}requestAnimationFrame(e){throw new Error("Not implemented")}onFrameStart(e){throw new Error("Not implemented")}onFrameEnd(e){throw new Error("Not implemented")}doesSessionSupportReferenceSpace(e,t){throw new Error("Not implemented")}requestStageBounds(){throw new Error("Not implemented")}async requestFrameOfReferenceTransform(e,t){}cancelAnimationFrame(e){throw new Error("Not implemented")}endSession(e){throw new Error("Not implemented")}getViewport(e,t,r,i){throw new Error("Not implemented")}getProjectionMatrix(e){throw new Error("Not implemented")}getBasePoseMatrix(){throw new Error("Not implemented")}getBaseViewMatrix(e){throw new Error("Not implemented")}getInputSources(){throw new Error("Not implemented")}getInputPose(e,t,r){throw new Error("Not implemented")}onWindowResize(){this.onWindowResize()}}let wt={mapping:"xr-standard",profiles:["oculus-go","generic-trigger-touchpad"],buttons:{length:3,0:1,1:null,2:0},gripTransform:{orientation:[.11*Math.PI,0,0,1]}},bt={mapping:"xr-standard",displayProfiles:{"Oculus Quest":["oculus-touch-v2","oculus-touch","generic-trigger-squeeze-thumbstick"]},profiles:["oculus-touch","generic-trigger-squeeze-thumbstick"],axes:{length:4,0:null,1:null,2:0,3:1},buttons:{length:7,0:1,1:2,2:null,3:0,4:3,5:4,6:null},gripTransform:{position:[0,-.02,.04,1],orientation:[.11*Math.PI,0,0,1]}},yt={mapping:"xr-standard",profiles:["htc-vive","generic-trigger-squeeze-touchpad"],displayProfiles:{"HTC Vive":["htc-vive","generic-trigger-squeeze-touchpad"],"HTC Vive DVT":["htc-vive","generic-trigger-squeeze-touchpad"],"Valve Index":["valve-index","generic-trigger-squeeze-touchpad-thumbstick"]},buttons:{length:3,0:1,1:2,2:0},gripTransform:{position:[0,0,.05,1]},targetRayTransform:{orientation:[-.08*Math.PI,0,0,1]},userAgentOverrides:{Firefox:{axes:{invert:[1,3]}}}},Et={mapping:"xr-standard",profiles:["samsung-gearvr","generic-trigger-touchpad"],buttons:{length:3,0:1,1:null,2:0},gripTransform:{orientation:[.11*Math.PI,0,0,1]}},xt={mapping:"xr-standard",profiles:["samsung-odyssey","microsoft-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"],buttons:{length:4,0:1,1:0,2:2,3:4},gripTransform:{position:[0,-.02,.04,1],orientation:[.11*Math.PI,0,0,1]}},St={mapping:"xr-standard",profiles:["microsoft-mixed-reality","generic-trigger-squeeze-touchpad-thumbstick"],buttons:{length:4,0:1,1:0,2:2,3:4},gripTransform:{position:[0,-.02,.04,1],orientation:[.11*Math.PI,0,0,1]}},Rt={"Daydream Controller":{mapping:"",profiles:["google-daydream","generic-trigger-touchpad"],buttons:{length:3,0:null,1:null,2:0}},"Gear VR Controller":Et,"HTC Vive Focus Controller":{mapping:"xr-standard",profiles:["htc-vive-focus","generic-trigger-touchpad"],buttons:{length:3,0:1,1:null,2:0}},"Oculus Go Controller":wt,"Oculus Touch (Right)":bt,"Oculus Touch (Left)":bt,"OpenVR Gamepad":yt,"Spatial Controller (Spatial Interaction Source) 045E-065A":St,"Spatial Controller (Spatial Interaction Source) 045E-065D":xt,"Windows Mixed Reality (Right)":St,"Windows Mixed Reality (Left)":St};const Mt=m(.155,-.465,-.15),At=m(-.155,-.465,-.15),Tt=m(0,0,-.25),It=m(0,0,.05),Pt=m(-.08,.14,.08),Ot=.4,Ct=.4,Ft=.61,Nt=.175,Dt=.12,Lt=.87,Vt=180/Math.PI;class kt{constructor(){this.hand="right",this.headElbowOffset=Mt,this.controllerQ=x(),this.lastControllerQ=x(),this.headQ=x(),this.headPos=u(),this.elbowPos=u(),this.wristPos=u(),this.time=null,this.lastTime=null,this.rootQ=x(),this.position=u()}setHandedness(e){this.hand!=e&&(this.hand=e,"left"==this.hand?this.headElbowOffset=At:this.headElbowOffset=Mt)}update(e,t){this.time=H(),e&&(I(this.lastControllerQ,this.controllerQ),I(this.controllerQ,e)),t&&(c(this.headPos,t),d(this.headQ,t));let r=this.getHeadYawOrientation_(),i=this.quatAngle_(this.lastControllerQ,this.controllerQ);i/((this.time-this.lastTime)/1e3)>Ft?R(this.rootQ,this.rootQ,r,Math.min(i/Nt,1)):I(this.rootQ,r);let s=m(0,0,-1);y(s,s,this.controllerQ);let n=w(s,[0,1,0]),a=this.clamp_((n-Dt)/Lt,0,1),o=A(this.rootQ);M(o,o),S(o,o,this.controllerQ);let h=this.elbowPos;f(h,this.headPos),_(h,h,this.headElbowOffset);let l=p(Pt);g(l,l,a),_(h,h,l);let u=this.quatAngle_(o,x())*Vt,v=(1-Math.pow(u/180,4))*(Ot+(1-Ot)*a*Ct),b=x();R(b,b,o,v);let E=M(x(),b),T=A(o);S(T,T,E);let P=this.wristPos;f(P,It),y(P,P,b),_(P,P,Tt),y(P,P,T),_(P,P,h);let O=p(Pt);g(O,O,a),_(this.position,this.wristPos,O),y(this.position,this.position,this.rootQ),this.lastTime=this.time}getPosition(){return this.position}getHeadYawOrientation_(){let e=u();return function(e,t,r){function i(e,t,r){return e<t?t:e>r?r:e}var s=t[0]*t[0],n=t[1]*t[1],a=t[2]*t[2],o=t[3]*t[3];if("XYZ"===r)e[0]=Math.atan2(2*(t[0]*t[3]-t[1]*t[2]),o-s-n+a),e[1]=Math.asin(i(2*(t[0]*t[2]+t[1]*t[3]),-1,1)),e[2]=Math.atan2(2*(t[2]*t[3]-t[0]*t[1]),o+s-n-a);else if("YXZ"===r)e[0]=Math.asin(i(2*(t[0]*t[3]-t[1]*t[2]),-1,1)),e[1]=Math.atan2(2*(t[0]*t[2]+t[1]*t[3]),o-s-n+a),e[2]=Math.atan2(2*(t[0]*t[1]+t[2]*t[3]),o-s+n-a);else if("ZXY"===r)e[0]=Math.asin(i(2*(t[0]*t[3]+t[1]*t[2]),-1,1)),e[1]=Math.atan2(2*(t[1]*t[3]-t[2]*t[0]),o-s-n+a),e[2]=Math.atan2(2*(t[2]*t[3]-t[0]*t[1]),o-s+n-a);else if("ZYX"===r)e[0]=Math.atan2(2*(t[0]*t[3]+t[2]*t[1]),o-s-n+a),e[1]=Math.asin(i(2*(t[1]*t[3]-t[0]*t[2]),-1,1)),e[2]=Math.atan2(2*(t[0]*t[1]+t[2]*t[3]),o+s-n-a);else if("YZX"===r)e[0]=Math.atan2(2*(t[0]*t[3]-t[2]*t[1]),o-s+n-a),e[1]=Math.atan2(2*(t[1]*t[3]-t[0]*t[2]),o+s-n-a),e[2]=Math.asin(i(2*(t[0]*t[1]+t[2]*t[3]),-1,1));else{if("XZY"!==r)return void console.log("No order given for quaternion to euler conversion.");e[0]=Math.atan2(2*(t[0]*t[3]+t[1]*t[2]),o-s+n-a),e[1]=Math.atan2(2*(t[0]*t[2]+t[1]*t[3]),o+s-n-a),e[2]=Math.asin(i(2*(t[2]*t[3]-t[0]*t[1]),-1,1))}}(e,this.headQ,"YXZ"),function(e,t,r,i){let s=.5*Math.PI/180;t*=s,r*=s,i*=s;let n=Math.sin(t),a=Math.cos(t),o=Math.sin(r),h=Math.cos(r),l=Math.sin(i),c=Math.cos(i);return e[0]=n*h*c-a*o*l,e[1]=a*o*c+n*h*l,e[2]=a*h*l-n*o*c,e[3]=a*h*c+n*o*l,e}(x(),0,e[1]*Vt,0)}clamp_(e,t,r){return Math.min(Math.max(e,t),r)}quatAngle_(e,t){let r=[0,0,-1],i=[0,0,-1];return y(r,r,e),y(i,i,t),function(e,t){let r=m(e[0],e[1],e[2]),i=m(t[0],t[1],t[2]);v(r,r),v(i,i);let s=w(r,i);return s>1?0:s<-1?Math.PI:Math.acos(s)}(r,i)}}const Xt=Symbol("@@webxr-polyfill/XRRemappedGamepad"),Gt={pressed:!1,touched:!1,value:0};Object.freeze(Gt);class Wt{constructor(e,t,r){if(r||(r={}),r.userAgentOverrides)for(let e in r.userAgentOverrides)if(navigator.userAgent.includes(e)){let t=r.userAgentOverrides[e];for(let e in t)e in r?Object.assign(r[e],t[e]):r[e]=t[e];break}let i=new Array(r.axes&&r.axes.length?r.axes.length:e.axes.length),s=new Array(r.buttons&&r.buttons.length?r.buttons.length:e.buttons.length),a=null;if(r.gripTransform){let e=r.gripTransform.orientation||[0,0,0,1];l(a=n(),P(e,e),r.gripTransform.position||[0,0,0])}let o=null;if(r.targetRayTransform){let e=r.targetRayTransform.orientation||[0,0,0,1];l(o=n(),P(e,e),r.targetRayTransform.position||[0,0,0])}let h=r.profiles;r.displayProfiles&&t.displayName in r.displayProfiles&&(h=r.displayProfiles[t.displayName]),this[Xt]={gamepad:e,map:r,profiles:h||[e.id],mapping:r.mapping||e.mapping,axes:i,buttons:s,gripTransform:a,targetRayTransform:o},this._update()}_update(){let e=this[Xt].gamepad,t=this[Xt].map,r=this[Xt].axes;for(let i=0;i<r.length;++i)t.axes&&i in t.axes?null===t.axes[i]?r[i]=0:r[i]=e.axes[t.axes[i]]:r[i]=e.axes[i];if(t.axes&&t.axes.invert)for(let e of t.axes.invert)e<r.length&&(r[e]*=-1);let i=this[Xt].buttons;for(let r=0;r<i.length;++r)t.buttons&&r in t.buttons?null===t.buttons[r]?i[r]=Gt:i[r]=e.buttons[t.buttons[r]]:i[r]=e.buttons[r]}get id(){return""}get _profiles(){return this[Xt].profiles}get index(){return-1}get connected(){return this[Xt].gamepad.connected}get timestamp(){return this[Xt].gamepad.timestamp}get mapping(){return this[Xt].mapping}get axes(){return this[Xt].axes}get buttons(){return this[Xt].buttons}get hapticActuators(){return this[Xt].gamepad.hapticActuators}}class Bt{constructor(e,t,r=0,i=-1){this.polyfill=e,this.display=t,this.nativeGamepad=null,this.gamepad=null,this.inputSource=new Ee(this),this.lastPosition=u(),this.emulatedPosition=!1,this.basePoseMatrix=n(),this.outputMatrix=n(),this.primaryButtonIndex=r,this.primaryActionPressed=!1,this.primarySqueezeButtonIndex=i,this.primarySqueezeActionPressed=!1,this.handedness="",this.targetRayMode="gaze",this.armModel=null}get profiles(){return this.gamepad?this.gamepad._profiles:[]}updateFromGamepad(e){this.nativeGamepad!==e&&(this.nativeGamepad=e,this.gamepad=e?new Wt(e,this.display,Rt[e.id]):null),this.handedness=""===e.hand?"none":e.hand,this.gamepad&&this.gamepad._update(),e.pose?(this.targetRayMode="tracked-pointer",this.emulatedPosition=!e.pose.hasPosition):""===e.hand&&(this.targetRayMode="gaze",this.emulatedPosition=!1)}updateBasePoseMatrix(){if(this.nativeGamepad&&this.nativeGamepad.pose){let e=this.nativeGamepad.pose,t=e.position,r=e.orientation;if(!t&&!r)return;t?(this.lastPosition[0]=t[0],this.lastPosition[1]=t[1],this.lastPosition[2]=t[2]):e.hasPosition?t=this.lastPosition:(this.armModel||(this.armModel=new kt),this.armModel.setHandedness(this.nativeGamepad.hand),this.armModel.update(r,this.polyfill.getBasePoseMatrix()),t=this.armModel.getPosition()),l(this.basePoseMatrix,r,t)}else e=this.basePoseMatrix,t=this.polyfill.getBasePoseMatrix(),e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15];var e,t;return this.basePoseMatrix}getXRPose(e,t){switch(this.updateBasePoseMatrix(),t){case"target-ray":e._transformBasePoseMatrix(this.outputMatrix,this.basePoseMatrix),this.gamepad&&this.gamepad[Xt].targetRayTransform&&h(this.outputMatrix,this.outputMatrix,this.gamepad[Xt].targetRayTransform);break;case"grip":if(!this.nativeGamepad||!this.nativeGamepad.pose)return null;e._transformBasePoseMatrix(this.outputMatrix,this.basePoseMatrix),this.gamepad&&this.gamepad[Xt].gripTransform&&h(this.outputMatrix,this.outputMatrix,this.gamepad[Xt].gripTransform);break;default:return null}return e._adjustForOriginOffset(this.outputMatrix),new XRPose(new XRRigidTransform(this.outputMatrix),this.emulatedPosition)}}let Ut=function(e,t,r=!0,i=!0){var s,n,a,o,h=0,l=function(){h=!1===r?0:Date.now(),s=null,o=e.apply(n,a),s||(n=a=null)},c=function(){var c=Date.now();h||!1!==r||(h=c);var d=t-(c-h);return n=this,a=arguments,d<=0||d>t?(s&&(clearTimeout(s),s=null),h=c,o=e.apply(n,a),s||(n=a=null)):s||!1===i||(s=setTimeout(l,d)),o};return c.cancel=function(){clearTimeout(s),h=0,s=n=a=null},c};Ut(function(...e){console.log(...e)},1e3);class Ht extends r{constructor(){if(super(),!1===Ht.HasARKit())throw new Error("ARKitWrapper will only work in Mozilla's ARDemo test app");if(void 0!==Ht.GLOBAL_INSTANCE)throw new Error("ARKitWrapper is a singleton. Use ARKitWrapper.GetOrCreate() to get the global instance.");this._timestamp=0,this._lightProbe=null,this._deviceId=null,this._isWatching=!1,this._waitingForSessionStart=!1,this._isInitialized=!1,this._rawARData=null,this._rAF_callbacks=[],this._rAF_currentCallbacks=[],this._frameHandle=1,this._requestedPermissions={cameraAccess:!1,worldAccess:!1},this._currentPermissions={cameraAccess:!1,worldAccess:!1},this._worldSensingState={meshDetectionState:!1},this._worldInformation=null,this._projectionMatrix=new Float32Array(16),this._viewMatrix=new Float32Array(16),this._cameraTransform=new Float32Array(16),this._anchors=new Map,this._timeOffsets=[],this._timeOffset=0,this._timeOffsetComputed=!1,this._dataBeforeNext=0,this._worldMappingStatus=Ht.WEB_AR_WORLDMAPPING_NOT_AVAILABLE,this._defaultOptions={location:!0,camera:!0,objects:!0,light_intensity:!0,computer_vision_data:!1};const e={arkitStartRecording:Ht.RECORD_START_EVENT,arkitStopRecording:Ht.RECORD_STOP_EVENT,arkitDidMoveBackground:Ht.DID_MOVE_BACKGROUND_EVENT,arkitWillEnterForeground:Ht.WILL_ENTER_FOREGROUND_EVENT,arkitInterrupted:Ht.INTERRUPTED_EVENT,arkitInterruptionEnded:Ht.INTERRUPTION_ENDED_EVENT,arkitShowDebug:Ht.SHOW_DEBUG_EVENT,arkitWindowResize:Ht.WINDOW_RESIZE_EVENT,onError:Ht.ON_ERROR,arTrackingChanged:Ht.AR_TRACKING_CHANGED};for(const t in e)window[t]=(r=>{r=r||null;try{this.dispatchEvent(e[t],new CustomEvent(e[t],{source:this,detail:r}))}catch(e){console.error(t+" callback error",e)}});window.onComputerVisionData=(e=>{this._onComputerVisionData(e)}),window.setNativeTime=(e=>{this._timeOffsets.push((performance||Date).now()-e.nativeTime),this._timeOffsetComputed=!0,this._timeOffset=0;for(let e=0;e<this._timeOffsets.length;e++)this._timeOffset+=this._timeOffsets[e];this._timeOffset=this._timeOffset/this._timeOffsets.length}),window.userGrantedComputerVisionData=(e=>{this._sessionCameraAccess|=e.granted}),window.userGrantedWorldSensingData=(e=>{this._sessionWorldAccess|=e.granted}),window.userStoppedAR=(e=>{this._handleStopped();try{this.dispatchEvent(Ht.USER_STOPPED_AR,new CustomEvent(Ht.USER_STOPPED_AR,{}))}catch(e){console.error("USER_STOPPED_AR event error",e)}})}static GetOrCreate(e=null){if(void 0===Ht.GLOBAL_INSTANCE){const t=new Ht;Ht.GLOBAL_INSTANCE=t;const r={browser:!0,points:!0,focus:!1,rec:!0,rec_time:!0,mic:!1,build:!1,plane:!0,warnings:!0,anchors:!1,debug:!0,statistics:!1},i="object"==typeof(e=e&&"object"==typeof e?e:{}).ui?e.ui:{};e.ui=Object.assign(r,i),e.geometry_arrays=!0,Ze.setUseGeomArrays(),console.log("----INIT"),t._initAR(e).then(e=>{t._deviceId=e,t._isInitialized=!0;try{t.dispatchEvent(Ht.INIT_EVENT,new CustomEvent(Ht.INIT_EVENT,{source:t}))}catch(e){console.error("INIT_EVENT event error",e)}})}return Ht.GLOBAL_INSTANCE}static HasARKit(){return void 0!==window.webkit}get deviceId(){return this._deviceId}get hasSession(){return this._isWatching}get isInitialized(){return this._isInitialized}_sendMessage(e,t={},r=!0,i=!0){return new Promise((s,n)=>{if(r&&!this._isInitialized)return void n(new Error("ARKit is not initialized"));const a={};if(i){const t="arkitCallback_"+e+"_"+(new Date).getTime()+"_"+Math.floor(Math.random()*Number.MAX_SAFE_INTEGER);window[t]=(e=>{delete window[t],s(e)}),a.callback=t}window.webkit.messageHandlers[e].postMessage(Object.assign({},t,a)),i||s()})}_initAR(e){return this._sendMessage("initAR",{options:e},!1)}_requestSession(e,t){return this._sendMessage("requestSession",{options:e,data_callback:t})}_hitTest(e,t,r){return this._sendMessage("hitTest",{x:e,y:t,type:r})}_addAnchor(e,t){return this._sendMessage("addAnchor",{uuid:e,transform:t})}_removeAnchors(e){return new Promise(t=>{window.webkit.messageHandlers.removeAnchors.postMessage(e),t()})}_createDetectionImage(e,t,r,i,s){return this._sendMessage("createImageAnchor",{uid:e,buffer:mt.encode(t),imageWidth:r,imageHeight:i,physicalWidth:s})}_destroyDetectionImage(e){return this._sendMessage("destroyImageAnchor",{uid:e})}_activateDetectionImage(e,t=!1){return this._sendMessage("activateDetectionImage",{uid:e,trackable:t})}_deactivateDetectionImage(e){return this._sendMessage("deactivateDetectionImage",{uid:e})}_setNumberOfTrackedImages(e){this._sendMessage("setNumberOfTrackedImages",{numberOfTrackedImages:"number"==typeof e?e:0},!0,!1)}_getWorldMap(){return this._sendMessage("getWorldMap")}_setWorldMap(e){return this._sendMessage("setWorldMap",{worldMap:e.worldMap})}_stop(){return this._sendMessage("stopAR")}_setUIOptions(e){return this._sendMessage("setUIOptions",e,!0,!1)}_onUpdate(){return window.webkit.messageHandlers.onUpdate.postMessage({})}_requestComputerVisionData(){return this._sendMessage("requestComputerVisionData",{},!0,!1)}_startSendingComputerVisionData(){return this._sendMessage("startSendingComputerVisionData",{},!0,!1)}_stopSendingComputerVisionData(){return this._sendMessage("stopSendingComputerVisionData",{},!0,!1)}_onData(e){if(this._rawARData=e,this._worldInformation=null,this._timestamp=this._adjustARKitTime(e.timestamp),this._lightProbe=new ut({indirectIrradiance:e.light_intensity/1e3}),De(this._cameraTransform,e.camera_transform),De(this._viewMatrix,e.camera_view),De(this._projectionMatrix,e.projection_camera),this._worldMappingStatus=e.worldMappingStatus,e.newObjects.length)for(let t=0;t<e.newObjects.length;t++){const r=e.newObjects[t],i=this._anchors.get(r.uuid);i&&i.deleted&&(i.deleted=!1),this._createOrUpdateAnchorObject(r)}if(e.removedObjects.length)for(let t=0;t<e.removedObjects.length;t++){const r=e.removedObjects[t],i=this._anchors.get(r);i?(i.notifyOfRemoval(),this._anchors.delete(r)):console.error("app signalled removal of non-existant anchor/plane")}if(e.objects.length)for(let t=0;t<e.objects.length;t++){const r=e.objects[t];this._createOrUpdateAnchorObject(r)}try{this.dispatchEvent(Ht.WATCH_EVENT,new CustomEvent(Ht.WATCH_EVENT,{source:this,detail:this}))}catch(e){console.error("WATCH_EVENT event error",e)}this._rAF_callbacks.length>0&&this._do_rAF(),this._dataBeforeNext++}_onComputerVisionData(e){if(!e)return console.error("detail passed to _onComputerVisionData is null"),void this._requestComputerVisionData();if(!e.frame||!e.frame.buffers||e.frame.buffers.length<=0)return console.error("detail passed to _onComputerVisionData is bad, no buffers"),void this._requestComputerVisionData();e.camera.arCamera=!0;const t=e.camera.interfaceOrientation;switch(e.camera.viewMatrix=e.camera.inverse_viewMatrix,t){case 1:e.camera.cameraOrientation=-90;break;case 2:e.camera.cameraOrientation=90;break;case 3:e.camera.cameraOrientation=0;break;case 4:e.camera.cameraOrientation=180}switch(e.frame.pixelFormatType){case"kCVPixelFormatType_420YpCbCr8BiPlanarFullRange":e.frame.pixelFormat="YUV420P";break;default:e.frame.pixelFormat=e.frame.pixelFormatType}const r=new _t(e.frame.buffers,e.frame.pixelFormat,this._adjustARKitTime(e.frame.timestamp),e.camera);try{this.dispatchEvent(Ht.COMPUTER_VISION_DATA,new CustomEvent(Ht.COMPUTER_VISION_DATA,{source:this,detail:r}))}catch(e){console.error("COMPUTER_VISION_DATA event error",e)}}_do_rAF(){const e=this._rAF_callbacks;return this._rAF_currentCallbacks=this._rAF_currentCallbacks.concat(this._rAF_callbacks),this._rAF_callbacks=[],window.requestAnimationFrame((...t)=>{this.startingRender();for(let t=0;t<e.length;t++){let r=this._rAF_currentCallbacks,i=r.findIndex(r=>r&&r.handle===e[t].handle);i>-1&&r.splice(i,1);try{e[t].cancelled||"function"!=typeof e[t].callback||e[t].callback(...e[t].params)}catch(e){console.error(e)}}this.finishedRender()})}_createOrUpdateAnchorObject(e){if(e.plane_center){const t=this._anchors.get(e.uuid);if(!t||t.placeholder){const r=new pt(e.transform,e.plane_center,[e.plane_extent.x,e.plane_extent.z],e.plane_alignment,e.geometry,e.uuid,this._timestamp);if(t){try{t.dispatchEvent("replaceAnchor",new CustomEvent("replaceAnchor",{source:t,detail:r}))}catch(e){console.error("replaceAnchor event error",e)}console.log("replaced dummy anchor created from hit test with plane"),this._anchors.delete(e.uuid)}this._anchors.set(e.uuid,r),e.object=r}else t&&(t.updatePlaneData(e.transform,e.plane_center,[e.plane_extent.x,e.plane_extent.y],e.plane_alignment,e.geometry,this._timestamp),e.object=t)}else{const t=this._anchors.get(e.uuid);if(!t||t.placeholder){let r;switch(e.type){case Ht.ANCHOR_TYPE_FACE:r=new Je(e.transform,e.geometry,e.blendShapes,e.uuid,this._timestamp);break;case Ht.ANCHOR_TYPE_ANCHOR:r=new Ke(e.transform,e.uuid,this._timestamp);break;case Ht.ANCHOR_TYPE_IMAGE:r=new ct(e.transform,e.uuid,this._timestamp)}if(t){try{t.dispatchEvent("replaceAnchor",new CustomEvent("replaceAnchor",{source:t||mesh,detail:r}))}catch(e){console.error("replaceAnchor event error",e)}console.log("replaced dummy anchor created from hit test with new anchor")}this._anchors.set(e.uuid,r),e.object=r}else{switch(e.type){case Ht.ANCHOR_TYPE_FACE:t.updateFaceData(e.transform,e.geometry,e.blendShapes,this._timestamp);break;default:t.updateModelMatrix(e.transform,this._timestamp)}e.object=t}}}_adjustARKitTime(e){return this._timeOffsetComputed?e+this._timeOffset:(performance||Date).now()}get hasData(){return null!==this._rawARData}getData(e=null){return e?this._rawARData&&void 0!==this._rawARData[e]?this._rawARData[e]:null:this._rawARData}waitForInit(){return new Promise((e,t)=>{if(this._isInitialized)return void e();const r=()=>{this.removeEventListener(Ht.INIT_EVENT,r,!1),e()};this.addEventListener(Ht.INIT_EVENT,r,!1)})}pickBestHit(e){if(0===e.length)return null;const t=e.filter(e=>e.type!=Ht.HIT_TEST_TYPE_FEATURE_POINT),r=t.filter(e=>e.type==Ht.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT),i=t.filter(e=>e.type==Ht.HIT_TEST_TYPE_EXISTING_PLANE);return r.length?(r=r.sort((e,t)=>e.distance-t.distance),r[0]):i.length?(i=i.sort((e,t)=>e.distance-t.distance),i[0]):t.length?(t=t.sort((e,t)=>e.distance-t.distance),t[0]):e[0]}createAnchorFromHit(e){return new Promise((t,r)=>{if(e.anchor_transform){let r=this._anchors.get(e.uuid);r?r.placeholder&&r.updateModelMatrix(e.anchor_transform,this._timestamp):(r=new Ke(e.anchor_transform,e.uuid,this._timestamp),console.log("created dummy anchor from hit test"),r.placeholder=!0,this._anchors.set(e.uuid,r)),t(new Qe(r,e.local_transform))}else{let r=this._anchors.get(e.uuid);r?(r.placeholder=!1,r.deleted=!1,console.log("hit test resulted in a hit on an existing anchor, without an offset")):(r=new Ke(e.world_transform,e.uuid),console.log("created dummy anchor (not a plane) from hit test"),r.placeholder=!0,this._anchors.set(e.uuid,r)),t(r)}})}requestAnimationFrame(e,...t){const r=++this._frameHandle;return this._rAF_callbacks.push({handle:r,callback:e,params:t,cancelled:!1}),(!this._isWatching||this._dataBeforeNext>0)&&this._do_rAF(),r}cancelAnimationFrame(e){let t=this._rAF_callbacks,r=t.findIndex(t=>t&&t.handle===e);r>-1&&(t[r].cancelled=!0,t.splice(r,1)),(t=this._rAF_currentCallbacks)&&(r=t.findIndex(t=>t&&t.handle===e))>-1&&(t[r].cancelled=!0)}startingRender(){this._dataBeforeNext}finishedRender(){this._dataBeforeNext=0,this._anchors.forEach(e=>{e.clearChanged()}),this._onUpdate()}watch(e=null){return new Promise((t,r)=>{if(!this._isInitialized)return void r("ARKitWrapper hasn't been initialized yet");if(this._waitingForSessionStart)return void r("ARKitWrapper startSession called, waiting to finish");if(this._isWatching)return void t({cameraAccess:this._sessionCameraAccess,worldAccess:this._sessionWorldAccess,webXRAccess:!0});this._waitingForSessionStart=!0;let i=Object.assign({},this._defaultOptions);null!==e&&(i=Object.assign(i,e)),this._requestedPermissions.cameraAccess=i.videoFrames,this._requestedPermissions.worldAccess=i.worldSensing,i.videoFrames&&(delete i.videoFrames,i.computer_vision_data=!0),console.log("----WATCH");void 0===window.arkitCallbackOnData&&(window.arkitCallbackOnData=(e=>{this._onData(e)})),this._requestSession(i,"arkitCallbackOnData").then(e=>{e.webXRAccess?(this._waitingForSessionStart=!1,this._isWatching=!0,this._currentPermissions.cameraAccess=e.cameraAccess,this._currentPermissions.worldAccess=e.worldAccess,t(e)):r(new Error("user did not give permission to start a webxr session"))})})}stop(){return new Promise((e,t)=>{this._isWatching?(console.log("----STOP"),this._stop().then(t=>{this._handleStopped(),e(t)})):e()})}_handleStopped(){this._isWatching=!1,this._rAF_callbacks.length>0&&this._do_rAF()}hitTest(e,t,r=Ht.HIT_TEST_TYPE_ALL){return this._hitTest(e,t,r)}createAnchor(e){return new Promise((t,r)=>{const i=new Ke(e,null,this._timestamp);this._addAnchor(i.uid,e).then(e=>{if(e.error)return void r(e.error);const s=this._anchors.get(e.uuid);s?(s.placeholder=!1,s.deleted=!1,s.updateModelMatrix(e.transform,this._timestamp),t(s)):(this._anchors.set(e.uuid,i),t(i))}).catch((...e)=>{console.error("could not create anchor",...e),r()})})}removeAnchor(e){let t=this._anchors.get(e.uid);t.placeholder?this._anchors.delete(e.uid):(t&&(t.deleted=!0),!e instanceof Qe&&this._removeAnchors([e.uid]))}createDetectionImage(e,t,r,i,s){return new Promise((n,a)=>{this._createDetectionImage(e,t,r,i,s).then(e=>{e.error?a(e.error):e.created?n():a(null)}).catch((...e)=>{console.error("could not create image",...e),a()})})}destroyDetectionImage(e){return new Promise((t,r)=>{this._destroyDetectionImage(e).then(e=>{e.error?r(e.error):t()}).catch((...e)=>{console.error("could not destroy image",...e),r()})})}activateDetectionImage(e,t=!1){return new Promise((r,i)=>{const s=this._anchors.get(e);!s||s.deleted?this._activateDetectionImage(e,t).then(e=>{e.error&&(i(e.error),i()),e.activated?(this._createOrUpdateAnchorObject(e.imageAnchor),e.imageAnchor.object.deleted=!1,r(e.imageAnchor.object)):i(null)}).catch((...e)=>{console.error("could not activate image",...e),i()}):r(s)})}deactivateDetectionImage(e){return new Promise((t,r)=>{this._deactivateDetectionImage(e).then(i=>{i.error&&r(i.error);const s=this._anchors.get(e);s&&(console.warn("anchor for image target '"+e+"' still exists after deactivation"),this.removeAnchor(s)),t()}).catch((...e)=>{console.error("could not activate image",...e),r()})})}setNumberOfTrackedImages(e){return this._setNumberOfTrackedImages(e)}getWorldMap(){return new Promise((e,t)=>{this._getWorldMap().then(r=>{if(!0!==r.saved)return null!==r.error?void t(r.error):void t(null);e(r.worldMap)}).catch((...e)=>{console.error("could not get world map",...e),t()})})}setWorldMap(e){return this._setWorldMap(e)}getLightProbe(){return new Promise((e,t)=>{this._lightProbe?e(this._lightProbe):t(new Error("Not populated yet"))})}setUIOptions(e){return this._setUIOptions(e)}updateWorldSensingState(e){return e.hasOwnProperty("meshDetectionState")&&this._currentPermissions.worldAccess?this._worldSensingState.meshDetectionState=e.meshDetectionState.enabled||!1:this._worldSensingState.meshDetectionState=!1,this._worldSensingState}getWorldInformation(){if(this._worldInformation)return this._worldInformation;let e={};return this._worldSensingState.meshDetectionState&&(e.meshes=[],this._anchors.forEach(t=>{!t.isMesh()||t.deleted||t.placeholder||e.meshes.push(t)})),this._worldInformation=e,e}}Ht.INIT_EVENT="arkit-init",Ht.WATCH_EVENT="arkit-watch",Ht.RECORD_START_EVENT="arkit-record-start",Ht.RECORD_STOP_EVENT="arkit-record-stop",Ht.DID_MOVE_BACKGROUND_EVENT="arkit-did-move-background",Ht.WILL_ENTER_FOREGROUND_EVENT="arkit-will-enter-foreground",Ht.INTERRUPTED_EVENT="arkit-interrupted",Ht.INTERRUPTION_ENDED_EVENT="arkit-interruption-ended",Ht.SHOW_DEBUG_EVENT="arkit-show-debug",Ht.WINDOW_RESIZE_EVENT="arkit-window-resize",Ht.ON_ERROR="on-error",Ht.USER_STOPPED_AR="user-stopped-ar",Ht.AR_TRACKING_CHANGED="ar_tracking_changed",Ht.COMPUTER_VISION_DATA="cv_data",Ht.USER_GRANTED_COMPUTER_VISION_DATA="user-granted-cv-data",Ht.USER_GRANTED_WORLD_SENSING_DATA="user-granted-world-sensing-data",Ht.ORIENTATION_UP=1,Ht.ORIENTATION_UP_MIRRORED=2,Ht.ORIENTATION_DOWN=3,Ht.ORIENTATION_DOWN_MIRRORED=4,Ht.ORIENTATION_LEFT_MIRRORED=5,Ht.ORIENTATION_RIGHT=6,Ht.ORIENTATION_RIGHT_MIRRORED=7,Ht.ORIENTATION_LEFT=8,Ht.WEB_AR_WORLDMAPPING_NOT_AVAILABLE="ar_worldmapping_not_available",Ht.WEB_AR_WORLDMAPPING_LIMITED="ar_worldmapping_limited",Ht.WEB_AR_WORLDMAPPING_EXTENDING="ar_worldmapping_extending",Ht.WEB_AR_WORLDMAPPING_MAPPED="ar_worldmapping_mapped",Ht.HIT_TEST_TYPE_FEATURE_POINT=1,Ht.HIT_TEST_TYPE_ESTIMATED_HORIZONTAL_PLANE=2,Ht.HIT_TEST_TYPE_ESTIMATED_VERTICAL_PLANE=4,Ht.HIT_TEST_TYPE_EXISTING_PLANE=8,Ht.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT=16,Ht.HIT_TEST_TYPE_EXISTING_PLANE_USING_GEOMETRY=32,Ht.HIT_TEST_TYPE_ALL=Ht.HIT_TEST_TYPE_FEATURE_POINT|Ht.HIT_TEST_TYPE_EXISTING_PLANE|Ht.HIT_TEST_TYPE_ESTIMATED_HORIZONTAL_PLANE|Ht.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT,Ht.HIT_TEST_TYPE_EXISTING_PLANES=Ht.HIT_TEST_TYPE_EXISTING_PLANE|Ht.HIT_TEST_TYPE_EXISTING_PLANE_USING_EXTENT,Ht.ANCHOR_TYPE_PLANE="plane",Ht.ANCHOR_TYPE_FACE="face",Ht.ANCHOR_TYPE_ANCHOR="anchor",Ht.ANCHOR_TYPE_IMAGE="image";class qt{constructor(e){this._subscribed=!1,this._arKitWrapper=e,this.subscribe()}subscribe(){this._subscribed||(this._subscribed=!0,this._arKitWrapper.addEventListener(Ht.INIT_EVENT,this.handleARKitInit.bind(this)),this._arKitWrapper.addEventListener(Ht.WATCH_EVENT,this.handleARKitUpdate.bind(this)),this._arKitWrapper.addEventListener(Ht.WINDOW_RESIZE_EVENT,this.handleARKitWindowResize.bind(this)),this._arKitWrapper.addEventListener(Ht.ON_ERROR,this.handleOnError.bind(this)),this._arKitWrapper.addEventListener(Ht.AR_TRACKING_CHANGED,this.handleArTrackingChanged.bind(this)),this._arKitWrapper.addEventListener(Ht.COMPUTER_VISION_DATA,this.handleComputerVisionData.bind(this)),this._arKitWrapper.addEventListener(Ht.USER_STOPPED_AR,this.handleUserStoppedAR.bind(this)))}handleARKitInit(){}handleARKitUpdate(){}handleARKitWindowResize(){}handleOnError(){}handleArTrackingChanged(){}handleComputerVisionData(){}handleUserStoppedAR(){}}class jt extends vt{constructor(e){super(e),this._throttledLogPose=Ut(this.logPose,1e3),this._sessions=new Map,this._activeSession=null,this._frameSession=null,this._wrapperDiv=document.createElement("div"),this._wrapperDiv.setAttribute("class","arkit-device-wrapper");const t=()=>{document.body.insertBefore(this._wrapperDiv,document.body.firstChild||null)};document.body?t():document.addEventListener("DOMContentLoaded",t),this._headModelMatrix=Ne(),this._headModelMatrixInverse=Ne(),this._projectionMatrix=Ne(),this._deviceProjectionMatrix=Ne(),this._eyeLevelMatrix=Le(Ne()),this._stageMatrix=Le(Ne()),this._stageMatrix[13]=1.3,this._identityMatrix=Le(Ne()),this._baseFrameSet=!1,this._frameOfRefRequestsWaiting=[],this._depthNear=.1,this._depthFar=1e3;try{this._arKitWrapper=Ht.GetOrCreate(),this._arWatcher=new Qt(this._arKitWrapper,this)}catch(e){console.error("Error initializing the ARKit wrapper",e),this._arKitWrapper=null,this._arWatcher=null}this._hitTestSources=[],this._hitTestResults=new Map,this._hitTestResultsForNextFrame=new Map,this._domOverlayRoot=null,this._topMostDomElement=null,this._activeXRSession=null,this._gamepads=[],this._gamepadInputSources=[],this._touches=[];this._gamepads.push(zt("","right",1,!0)),this._gamepadInputSources.push(new Bt(this,{},0)),this._gamepadInputSources[0]._active=!1,this._touches.push({x:-1,y:-1});const r=(e,t)=>{if(!this._domOverlayRoot)return null;const r=document.elementsFromPoint(e,t);for(const e of r)if(this._domOverlayRoot.contains(e))return e;return null};document.addEventListener("touchstart",e=>{if(!e.touches||0==e.touches.length)return;const t=e.touches[0],i=t.clientX,s=t.clientY;this._topMostDomElement=r(i,s),this._touches[0].x=i,this._touches[0].y=s;const n=this._gamepads[0].buttons[0];n.pressed=!0,n.value=1}),document.addEventListener("touchmove",e=>{if(!e.touches||0==e.touches.length)return;const t=e.touches[0],i=t.clientX,s=t.clientY;this._topMostDomElement=r(i,s),this._touches[0].x=i,this._touches[0].y=s}),document.addEventListener("touchend",e=>{const t=this._touches[0].x,i=this._touches[0].y;this._topMostDomElement=r(t,i);const s=this._gamepads[0].buttons[0];s.pressed=!1,s.value=0,this._touches[0].x=-1,this._touches[0].y=-1})}static initStyles(){const e=()=>{const e=document.createElement("style");document.head.appendChild(e);const t=e.sheet;t.insertRule(".arkit-device-wrapper { z-index: -1; display: none; }",0),t.insertRule(".arkit-device-wrapper, .xr-canvas { background-color: transparent; position: absolute; top: 0; left: 0; bottom: 0; right: 0; }",0),t.insertRule(".arkit-device-wrapper, .arkit-device-wrapper canvas { width: 100%; height: 100%; padding: 0; margin: 0; -webkit-user-select: none; user-select: none; }",0)};document.body?e():window.addEventListener("DOMContentLoaded",e)}logPose(){console.log("pose",Ue(new Float32Array(3),this._headModelMatrix),He(new Float32Array(4),this._headModelMatrix))}addHitTestSource(e){this._hitTestSources.includes(e)||this._hitTestSources.push(e)}_runHitTest(){this._hitTestResults.clear();let e=0;for(let t=0;t<this._hitTestSources.length;t++){const r=this._hitTestSources[t];r._active&&(r._session[ve].ended?r.cancel():(this._hitTestSources[e++]=r,this._hitTestResultsForNextFrame.has(r)&&this._hitTestResults.set(r,this._hitTestResultsForNextFrame.get(r))))}if(this._hitTestSources.length=e,this._hitTestResultsForNextFrame.clear(),this._arKitWrapper)for(const e of this._hitTestSources){const t=qe();t[0]=e._offsetRay.direction.x,t[1]=e._offsetRay.direction.y,t[2]=e._offsetRay.direction.z,ze(t,t,this._arKitWrapper._projectionMatrix);const r=.5*(t[0]+1),i=.5*(1-t[1]);this._arKitWrapper.hitTest(r,i,Ht.HIT_TEST_TYPE_EXISTING_PLANE_USING_GEOMETRY).then(t=>{this._hitTestResultsForNextFrame.has(e)||this._hitTestResultsForNextFrame.set(e,[]);const r=this._hitTestResultsForNextFrame.get(e);for(const e of t)r.push(new XRRigidTransform(new Float32Array(e.world_transform)))})}else console.error("Hit test requires ARKitWrapper.")}getHitTestResults(e){return this._hitTestResults.has(e)?this._hitTestResults.get(e):[]}setDomOverlayRoot(e){this._domOverlayRoot=e}setActiveXRSession(e){this._activeXRSession=e}_shouldSuppressSelectEvents(){if(this._topMostDomElement&&this._topMostDomElement.dispatchEvent){const e=new fe("beforexrselect",{session:this._activeXRSession,cancelable:!0});if(this._topMostDomElement.dispatchEvent(e),e.defaultPrevented)return!0}return!1}setProjectionMatrix(e){De(this._deviceProjectionMatrix,e)}setBaseViewMatrix(e){if(De(this._headModelMatrixInverse,e),Ve(this._headModelMatrix,this._headModelMatrixInverse),!this._baseFrameSet){this._baseFrameSet=!0;for(let e=0;e<this._frameOfRefRequestsWaiting.length;e++){const t=this._frameOfRefRequestsWaiting[e];try{t()}catch(e){console.error("finalization of reference frame requests failed: ",e)}}this._frameOfRefRequestsWaiting.length=0}}get depthNear(){return this._depthNear}set depthNear(e){this._depthNear=e}get depthFar(){return this._depthFar}set depthFar(e){this._depthFar=e}isSessionSupported(e){return"immersive-ar"===e||"inline"===e}isFeatureSupported(e){switch(e){case"viewer":case"local":case"local-floor":return!0;case"bounded":case"unbounded":return!1;case"worldSensing":case"computerVision":case"alignEUS":case"hit-test":case"dom-overlay":return!0;default:return!1}}doesSessionSupportReferenceSpace(e,t){const r=this._sessions.get(e);if(r.ended)return!1;if(!r.enabledFeatures.has(t))return!1;switch(t){case"viewer":case"local":case"local-floor":return!0;case"bounded":case"unbounded":default:return!1}}async requestSession(e,t){if(!this.isSessionSupported(e))return console.error("Invalid session mode",e),Promise.reject();if("inline"===e){const r=new Kt(e,t);return this._sessions.set(r.id,r),Promise.resolve(r.id)}if(!this._arKitWrapper)return console.error("Session requested without an ARKitWrapper"),Promise.reject();if(null!==this._activeSession)return console.error("Tried to start a second active session"),Promise.reject();const r={};return t.has("worldSensing")&&(r.worldSensing=!0),t.has("computerVision")&&(r.videoFrames=!0),t.has("alignEUS")&&(r.alignEUS=!0),await this._arKitWrapper.waitForInit().then(()=>{}).catch((...e)=>(console.error("app failed to initialize: ",...e),Promise.reject())),await this._arKitWrapper.watch(r).then(r=>{const i=new Kt(e,t);return this._sessions.set(i.id,i),this._activeSession=i,this.dispatchEvent("@@webxr-polyfill/vr-present-start",i.id),Promise.resolve(i.id)}).catch((...e)=>(console.error("session request failed: ",...e),Promise.reject()))}onBaseLayerSet(e,t){const r=this._sessions.get(e),i=t.context.canvas,s=r.baseLayer;if(r.baseLayer=t,r.immersive){if(null!==s){const e=s.context.canvas;this._wrapperDiv.removeChild(e),e.style.width=r.canvasWidth,e.style.height=r.canvasHeight,e.style.display=r.canvasDisplay,e.style.backgroundColor=r.canvasBackground}r.bodyBackgroundColor=document.body.style.backgroundColor,r.bodyBackgroundImage=document.body.style.backgroundImage,document.body.style.backgroundColor="transparent",document.body.style.backgroundImage="none";for(var n=document.body.children,a=0;a<n.length;a++){var o=n[a];if(!(o==this._wrapperDiv||o==i||this._domOverlayRoot&&this._domOverlayRoot.contains(o))){var h=o.style.display;o._displayChanged=!0,o._displayWas=h,o.style.display="none"}}r.canvasParent=i.parentNode,r.canvasNextSibling=i.nextSibling,r.canvasDisplay=i.style.display,i.style.display="block",r.canvasBackground=i.style.backgroundColor,i.style.backgroundColor="transparent",r.canvasWidth=i.style.width,r.canvasHeight=i.style.height,i.style.width="100%",i.style.height="100%",this._wrapperDiv.appendChild(i),this._wrapperDiv.style.display="block"}}userEndedSession(){if(this._activeSession){let e=this._activeSession;e.immersive&&!e.ended&&(this.endSession(e.id),this.dispatchEvent("@@webxr-polyfill/vr-present-end",e.id))}}endSession(e){const t=this._sessions.get(e);if(t&&!t.ended){if(t.ended=!0,this._activeSession===t){if(null!==t.baseLayer){for(var r=document.body.children,i=0;i<r.length;i++){var s=r[i];s!=this._wrapperDiv&&s._displayChanged&&(s.style.display=s._displayWas,s._displayWas="",s._displayChanged=!1)}const e=t.baseLayer.context.canvas;this._wrapperDiv.removeChild(e),t.canvasNextSibling?t.canvasNextSibling.before(e):t.canvasParent&&t.canvasParent.appendChild(e),t.canvasParent=null,t.canvasNextSibling=null,e.style.width=t.canvasWidth,e.style.height=t.canvasHeight,e.style.display=t.canvasDisplay,e.style.backgroundColor=t.canvasBackground,document.body.style.backgroundColor=t.bodyBackgroundColor,document.body.style.backgroundImage=t.bodyBackgroundImage}this._wrapperDiv.style.display="none",this._activeSession=null,Le(this._headModelMatrix),this._arKitWrapper.stop(),this._domOverlayRoot=null,this._topMostDomElement=null,this._activeXRSession=null}this._frameSession=null}}requestAnimationFrame(e,...t){return this._arKitWrapper.requestAnimationFrame(e,t)}cancelAnimationFrame(e){return this._arKitWrapper.cancelAnimationFrame(e)}onFrameStart(e,t){const r=this._sessions.get(e);if(this._frameSession=r,r.immersive){if(De(this._projectionMatrix,this._deviceProjectionMatrix),r.baseLayer){const e=r.baseLayer.context,t=e.getParameter(e.COLOR_CLEAR_VALUE),i=e.getParameter(e.DEPTH_CLEAR_VALUE),s=e.getParameter(e.STENCIL_CLEAR_VALUE);e.clearColor(0,0,0,0),e.clearDepth(1,0),e.clearStencil(0),e.clear(e.DEPTH_BUFFER_BIT|e.COLOR_BUFFER_BIT|e.STENCIL_BUFFER_BIT),e.clearColor(t[0],t[1],t[2],t[3]),e.clearDepth(i),e.clearStencil(s)}}else if(r.baseLayer){const e=r.baseLayer.context.canvas;!function(e,t,r,i,s){let n,a=1/Math.tan(t/2);e[0]=a/r,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=s&&s!==1/0?(n=1/(i-s),e[10]=(s+i)*n,e[14]=2*s*i*n):(e[10]=-1,e[14]=-2*i)}(this._projectionMatrix,t.inlineVerticalFieldOfView,e.width/e.height,t.depthNear,t.depthFar)}if(r.immersive)for(let e=0;e<this._gamepads.length;++e){const t=this._gamepads[e],i=this._gamepadInputSources[e];if(i.updateFromGamepad(t),i.targetRayMode="screen",-1!==i.primaryButtonIndex){const e=t.buttons[i.primaryButtonIndex].pressed;e&&!i.primaryActionPressed?this._gamepadInputSources[0]._active=!0:!e&&i.primaryActionPressed&&(this._shouldSuppressSelectEvents()||this.dispatchEvent("@@webxr-polyfill/input-select-end",{sessionId:r.id,inputSource:i.inputSource}),this._gamepadInputSources[0]._active=!1)}}this._runHitTest()}onFrameEnd(e){const t=this._sessions.get(e);if(t.immersive)for(let e=0;e<this._gamepads.length;++e){const r=this._gamepads[e],i=this._gamepadInputSources[e];if(-1!==i.primaryButtonIndex){const e=r.buttons[i.primaryButtonIndex].pressed;!e||i.primaryActionPressed||this._shouldSuppressSelectEvents()||this.dispatchEvent("@@webxr-polyfill/input-select-start",{sessionId:t.id,inputSource:i.inputSource}),i.primaryActionPressed=e}}this._frameSession=null}requestFrameOfReferenceTransform(e,t){return new Promise((t,r)=>{const i=e=>{this._baseFrameSet?e():this._frameOfRefRequestsWaiting.push(e)};switch(e){case"viewer":return void i(()=>{t(this._headModelMatrix)});case"local":return void i(()=>{t(this._eyeLevelMatrix)});case"local-floor":return void i(()=>{t(this._stageMatrix)});case"bounded-floor":case"unbounded":return void r(new Error("not supported "+e));default:return void r(new Error("Unsupported frame of reference type "+e))}})}getViewport(e,t,r,i){const{width:s,height:n}=r.context.canvas;return i.x=0,i.y=0,i.width=s,i.height=n,!0}getProjectionMatrix(e){return this._projectionMatrix}getBasePoseMatrix(){return this._frameSession.immersive?this._headModelMatrix:this._identityMatrix}getBaseViewMatrix(e){return this._frameSession.immersive?this._headModelMatrix:this._identityMatrix}requestStageBounds(){return null}getInputSources(){const e=[];for(const t of this._gamepadInputSources)t._active&&e.push(t.inputSource);return e}getInputPose(e,t,r){for(let i=0;i<this._gamepadInputSources.length;i++){const s=this._gamepadInputSources[i];if(s._active&&s.inputSource===e){const e=.5*(2*Math.atan(1/this._projectionMatrix[5])),n=this._projectionMatrix[14]/(this._projectionMatrix[10]-1),a=this._projectionMatrix[5]/this._projectionMatrix[0],o=document.documentElement.clientWidth,h=document.documentElement.clientHeight,l=this._touches[i].x/o*2-1,c=-this._touches[i].y/h*2+1,d=Ve(Ne(),this._headModelMatrix);t._transformBasePoseMatrix(d,d);const u=Le(Ne());Ge(u,u,-l*e*a),Xe(u,u,c*e),u[12]=l*Math.tan(e)*n*a,u[13]=c*Math.tan(e)*n,u[14]=-n,ke(u,d,u);const p=this._gamepads[i].pose;Ue(p.position,u),He(p.orientation,u);const m=s.getXRPose(t,r);return Be(m.transform.matrix,p.orientation,p.position),Ve(m.transform.inverse.matrix,m.transform.matrix),m}}return null}onWindowResize(){this._sessions.forEach((e,t)=>{})}}const zt=(e,t,r,i)=>{const s=[];for(let e=0;e<r;e++)s.push({pressed:!1,touched:!1,value:0});return{id:e||"",pose:{hasPosition:i,position:new Float32Array([0,0,0]),orientation:new Float32Array([0,0,0,1])},buttons:s,hand:t,mapping:"xr-standard",axes:[0,0]}};let Yt=100;class Kt{constructor(e,t){this.mode=e,this.enabledFeatures=t,this.immersive="immersive-ar"==e,this.ended=null,this.baseLayer=null,this.id=++Yt}}class Qt extends qt{constructor(e,t){super(e),this._arKitDevice=t}handleARKitUpdate(e){this._arKitDevice.setBaseViewMatrix(this._arKitWrapper._cameraTransform),this._arKitDevice.setProjectionMatrix(this._arKitWrapper._projectionMatrix)}handleOnError(...e){console.error("ARKit error",...e)}handleUserStoppedAR(e){this._arKitDevice.userEndedSession()}}const $t=Ne();Ne();Oe.prototype._patchNavigatorXR=function(){this.xr=new XR(Promise.resolve(new jt(this.global))),this.xr._mozillaXRViewer=!0,Object.defineProperty(this.global.navigator,"xr",{value:this.xr,configurable:!0})};const Zt=navigator.userAgent.indexOf("Mobile/"),Jt=-1!==navigator.userAgent.indexOf("WebXRViewer")||(-1!==navigator.userAgent.indexOf("iPhone")||-1!==navigator.userAgent.indexOf("iPad"))&&-1!==Zt&&-1!==navigator.userAgent.indexOf("AppleWebKit")&&-1===navigator.userAgent.indexOf(" ",Zt)?new Oe(null,{webvr:!1,cardboard:!1}):null;let er=null;const tr=()=>{void 0!==window.XRFrame&&(XRFrame.prototype.addAnchor=async function(e,t){if(!this.session[ve].immersive)return Promise.reject();Ne();return e instanceof Float32Array?new Promise((r,i)=>{let s=this.session[ve]._localSpace;De($t,this.getPose(s,t).transform.matrix);const n=ke(Ne(),$t,e);er.createAnchor(n).then(r).catch((...e)=>{console.error("could not create anchor",...e),i()})}):Promise.reject("invalid value passed to addAnchor "+e)},Ke.prototype.detach=async function(){return new Promise((e,t)=>{er.removeAnchor(this),e()})})},rr=()=>{void 0!==window.XRSession&&(be.prototype.requestHitTestSource=function(e={}){const t=new lt(this,e);return this[ve].device.addHitTestSource(t),Promise.resolve(t)},be.prototype.requestHitTestSourceForTransientInput=function(){throw new Error("requestHitTestSourceForTransientInput() is not supported yet.")},XRFrame.prototype.getHitTestResults=function(e){const t=this.session[ve].device.getHitTestResults(e),r=[];for(const e of t)r.push(new rt(this,e));return r},XRFrame.prototype.geetTransientInputHitTestResult=function(){throw new Error("geetTransientInputHitTestResult() is not supported yet.")})},ir=()=>{void 0!==window.XRFrame&&void 0!==window.XRSession&&(Object.defineProperty(XRFrame.prototype,"worldInformation",{get:function(){if(!this.session[ve].immersive)throw new Error("Not implemented");return er.getWorldInformation()}}),be.prototype.updateWorldSensingState=function(e){if(!this[ve].immersive)throw new Error("Not implemented");return er.updateWorldSensingState(e)})},sr=()=>{void 0!==window.XRFrame&&(XRFrame.prototype.getGlobalLightEstimate=function(){if(!this.session[ve].immersive)throw new Error("Not implemented");return er.getLightProbe()},XRFrame.prototype.getGlobalReflectionProbe=function(){throw new Error("Not implemented")})},nr=()=>{void 0!==window.XRSession&&(be.prototype.nonStandard_setNumberOfTrackedImages=function(e){if(!this[ve].immersive)throw new Error("Not implemented");return er.setNumberOfTrackedImages(e)},be.prototype.nonStandard_createDetectionImage=function(e,t,r,i,s){if(!this[ve].immersive)throw new Error("Not implemented");return er.createDetectionImage(e,t,r,i,s)},be.prototype.nonStandard_destroyDetectionImage=function(e){if(!this[ve].immersive)throw new Error("Not implemented");return er.createDetectionImage(e)},be.prototype.nonStandard_activateDetectionImage=function(e){if(!this[ve].immersive)throw new Error("Not implemented");return er.activateDetectionImage(e)},be.prototype.nonStandard_deactivateDetectionImage=function(e){if(!this[ve].immersive)throw new Error("Not implemented");return er.deactivateDetectionImage(e)},be.prototype.nonStandard_getWorldMap=function(){if(!this[ve].immersive)throw new Error("Not implemented");return er.getWorldMap()},be.prototype.nonStandard_setWorldMap=function(e){if(!this[ve].immersive)throw new Error("Not implemented");return er.setWorldMap(e)},be.prototype.nonStandard_getWorldMappingStatus=function(){if(!this[ve].immersive)throw new Error("Not implemented");return er._worldMappingStatus})};if(Jt&&Jt.injected&&navigator.xr){er=Ht.GetOrCreate(),jt.initStyles(),window.XR&&(XR.prototype._isSessionSupported=XR.prototype.isSessionSupported,XR.prototype._requestSession=XR.prototype.requestSession,XR.prototype.isSessionSupported=function(e){return"immersive-ar"!==e&&"inline"!==e?Promise.resolve(!1):this._isSessionSupported(e)},XR.prototype.requestSession=async function(e,t){if("immersive-ar"!==e&&"inline"!==e)throw new DOMException("Polyfill Error: only immersive-ar or inline mode is supported.");let r=await this._requestSession(e,t);if("immersive-ar"===e&&(r[ve]._localSpace=await r.requestReferenceSpace("local")),t&&t.domOverlay&&t.domOverlay.root){r.domOverlayState={type:"screen"};const e=r[ve].device;e.setDomOverlayRoot(t.domOverlay.root),e.setActiveXRSession(r)}return r}),tr(),rr(),ir(),sr(),nr();for(const e of Object.keys(gt))void 0!==window[e]?console.warn(`${e} already defined on global.`):window[e]=gt[e]}});
